<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Submitted - Car Crash Lawyer AI</title>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .profile-complete-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-complete-banner h2 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .profile-complete-banner p {
            opacity: 0.95;
            font-size: 14px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
        }

        .success-banner {
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .info-notice {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid rgba(255, 255, 255, 0.5);
        }

        .info-notice strong {
            font-weight: 600;
        }

        .emergency-panel {
            background: #fef2f2;  /* Light red background */
            border: 2px solid #dc2626;  /* Red border */
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .emergency-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .emergency-header h3 {
            font-size: 22px;
            margin-bottom: 5px;
            color: #dc2626;  /* Red text for light background */
        }

        .emergency-header p {
            font-size: 14px;
            color: #991b1b;  /* Darker red for readability */
        }

        .emergency-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .emergency-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .emergency-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .emergency-btn:active {
            transform: translateY(0);
        }

        /* Traffic Light System - Urgency-Based Colors (matches incident.html) */
        .emergency-btn.critical {
            background: #dc2626;    /* Solid Red - Critical/Emergency */
            color: white;
        }

        .emergency-btn.recovery {
            background: #f59e0b;    /* Solid Amber - Important */
            color: white;
        }

        .emergency-btn.contact {
            background: #3b82f6;    /* Solid Blue - Non-critical */
            color: white;
        }

        .btn-icon {
            font-size: 24px;
        }

        .find-me-btn, .website-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .find-me-btn:hover, .website-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .additional-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .additional-btn {
            padding: 12px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #374151;
        }

        .additional-btn:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
            border-color: #d1d5db;
        }

        .helper-text {
            text-align: center;
            color: white;
            font-size: 14px;
            margin-top: 20px;
            line-height: 1.6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            color: #374151;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .modal-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-btn.secondary:hover {
            background: #e5e7eb;
        }

        .error-message {
            color: #ef4444;
            font-size: 13px;
            margin-top: 10px;
            padding: 10px;
            background: #fee;
            border-radius: 6px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .list-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            border-color: #d1d5db;
            background: #f3f4f6;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .list-item-details {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }

        .delete-btn {
            padding: 8px 16px;
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 6px;
            color: #dc2626;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .delete-btn:hover {
            background: #fcc;
            border-color: #faa;
            transform: translateY(-2px);
        }

        .delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .save-pdf-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #667eea;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .save-pdf-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            border-color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .save-pdf-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 640px) {
            .container {
                padding: 0 10px;
            }

            .header h1 {
                font-size: 28px;
            }

            .card {
                padding: 20px;
            }

            .additional-controls {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="/css/mascot.css"></head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 Car Crash Lawyer AI</h1>
            <p>Your Legal First Responder</p>
        </div>

        <!-- Profile Complete Banner -->
        <div class="profile-complete-banner" id="profileBanner" style="display: none;">
            <h2>✅ Profile Setup Complete!</h2>
            <p>Your account is ready. You can now report incidents anytime.</p>
            <div class="user-info" id="userInfo"></div>
        </div>

        <!-- Success Notification -->
        <div class="success-banner" id="successBanner" style="display: none;">
            ✅ Your report has been successfully submitted
        </div>

        <!-- Image Processing Notice -->
        <div class="info-notice">
            📸 <strong>Please Note:</strong> Your uploaded images and documents are being securely processed and may take up to 24 hours to be fully accessible in your account. This ensures all evidence is properly stored for legal purposes.
        </div>

        <!-- Emergency Actions Panel -->
        <div class="card emergency-panel">
            <div class="emergency-header">
                <h3>🚨 Emergency Actions</h3>
                <p>Tap to call emergency services</p>
            </div>

            <div class="emergency-buttons">
                <button class="emergency-btn critical" id="call999Btn">
                    <span class="btn-icon">📞</span>
                    <span>Call 999 - Emergency Services</span>
                </button>

                <button class="emergency-btn recovery" id="recoveryBtn">
                    <span class="btn-icon">🚗</span>
                    <span id="recoveryBtnText">Call Recovery Service</span>
                </button>

                <button class="emergency-btn contact" id="emergencyContactBtn">
                    <span class="btn-icon">👤</span>
                    <span id="emergencyContactBtnText">Call Emergency Contact</span>
                </button>
            </div>
        </div>

        <!-- Additional Reports Section -->
        <div class="card">
            <button class="find-me-btn" id="newReportBtn">
                📝 Report an Incident
            </button>
        </div>

        <!-- Go to Dashboard Button -->
        <button class="website-btn" id="dashboardBtn">
            📊 View Dashboard
        </button>

        <p class="helper-text" id="helperText">
            Need help? Contact us anytime at <strong>support@carcrashlawyerai.co.uk</strong>
        </p>
    </div>

    <!-- Modals removed: Flow changed to transcription-status → declaration → report-complete -->

    <script>
        // ===== TYPEFORM REDIRECT HANDLER =====
        function extractTypeformParams() {
            const urlParams = new URLSearchParams(window.location.search);

            const user_id = urlParams.get('auth_user_id') || 
                           urlParams.get('user_id') || 
                           urlParams.get('userId') || 
                           urlParams.get('create_user_id');

            const product_id = urlParams.get('product_id');
            const auth_code = urlParams.get('auth_code');
            const email = urlParams.get('email');
            const incident_id = urlParams.get('incident_id');

            console.log('🔥 Typeform redirect parameters:', {
                user_id,
                product_id,
                auth_code,
                email,
                incident_id,
                fullUrl: window.location.href
            });

            // Store user session data
            if (user_id) {
                localStorage.setItem('create_user_id', user_id);
                sessionStorage.setItem('userId', user_id);

                if (auth_code) sessionStorage.setItem('auth_code', auth_code);
                if (email) sessionStorage.setItem('userEmail', email);
                if (product_id) sessionStorage.setItem('product_id', product_id);
                if (incident_id) sessionStorage.setItem('incident_id', incident_id);

                // Show profile banner
                const profileBanner = document.getElementById('profileBanner');
                profileBanner.style.display = 'block';

                // Update user info display
                const userInfo = document.getElementById('userInfo');
                userInfo.innerHTML = `
                    <strong>Email:</strong> ${email || 'Not provided'}<br>
                    <strong>User ID:</strong> ${user_id.substring(0, 8)}...
                `;

                console.log('✅ User authenticated from Typeform:', user_id);
                return true;
            }

            return false;
        }

        // Check if this is from an incident submission
        function checkIncidentSubmission() {
            const incidentId = sessionStorage.getItem('incident_id') || 
                              new URLSearchParams(window.location.search).get('incident_id');

            if (incidentId) {
                document.getElementById('successBanner').style.display = 'block';
                document.getElementById('helperText').innerHTML = `
                    Reference: <strong id="incident-ref">${incidentId}</strong><br>
                    We'll be in touch within 24 hours
                `;
            }
        }

        // ===== SUPABASE INITIALIZATION =====
        let supabase = null;

        async function initSupabase() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                if (config.supabaseUrl && config.supabaseKey) {
                    supabase = window.supabase.createClient(
                        config.supabaseUrl,
                        config.supabaseKey
                    );
                    console.log('✅ Supabase initialized');
                } else {
                    console.warn('⚠️ Supabase config not available');
                }
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
            }
        }

        // Get current user data
        const userId = localStorage.getItem('create_user_id') || 
                      sessionStorage.getItem('userId');
        const userEmail = sessionStorage.getItem('userEmail');

        // ===== EMERGENCY FUNCTIONS =====
        let emergencyContacts = null;
        let what3wordsData = null;  // Stores what3words location for 999 calls

        // Get user's what3words location
        async function getWhat3WordsLocation() {
            try {
                console.log('📍 Getting what3words location...');

                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    console.warn('⚠️ Geolocation not supported by browser');
                    return;
                }

                // Get current position
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const { latitude, longitude } = position.coords;
                console.log('✅ Location obtained:', { latitude, longitude });

                // Convert to what3words using backend API
                const response = await fetch('/api/location/what3words', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude, longitude })
                });

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.words) {
                    what3wordsData = result.words;
                    console.log('✅ what3words location:', what3wordsData);
                } else {
                    console.warn('⚠️ what3words lookup failed:', result.error);
                }

            } catch (error) {
                // Geolocation errors are common (user denial, timeout, etc.)
                // Log but don't disrupt the page
                if (error.code === 1) {
                    console.log('ℹ️ User denied location access (normal behavior)');
                } else if (error.code === 2) {
                    console.warn('⚠️ Location unavailable');
                } else if (error.code === 3) {
                    console.warn('⚠️ Location request timed out');
                } else {
                    console.warn('⚠️ Error getting what3words location:', error.message);
                }
            }
        }

        // Load emergency contacts once on page load
        async function loadUserData() {
            if (!userId) {
                console.log('⚠️ No userId available, skipping emergency contacts load');
                return;
            }

            try {
                console.log('📞 Loading emergency contacts for userId:', userId);
                const response = await fetch(`/api/emergency/contacts/${userId}`);

                console.log('API Response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                emergencyContacts = await response.json();
                console.log('✅ Emergency contacts loaded:', emergencyContacts);

                // Update button handlers with loaded contacts
                updateEmergencyButtons();

            } catch (error) {
                console.error('❌ Error loading emergency contacts:', error);
            }
        }

        // Update button handlers (colors are fixed in CSS by urgency level)
        function updateEmergencyButtons() {
            const call999Btn = document.getElementById('call999Btn');
            const recoveryBtn = document.getElementById('recoveryBtn');
            const emergencyContactBtn = document.getElementById('emergencyContactBtn');
            const recoveryBtnText = document.getElementById('recoveryBtnText');
            const emergencyContactBtnText = document.getElementById('emergencyContactBtnText');

            // 999 button - always available (red for critical)
            call999Btn.onclick = function() {
                const emergencyNumber = emergencyContacts?.emergency_services_number || '999';
                console.log('📞 Calling 999:', emergencyNumber);

                let message = `This will call ${emergencyNumber} Emergency Services.`;

                // Include what3words location if available
                if (what3wordsData) {
                    message += `\n\nYour what3words location: ///${what3wordsData}`;
                    message += '\n\nPlease provide this location to the operator.';
                }

                if (confirm(message)) {
                    window.location.href = `tel:${emergencyNumber}`;
                }
            };

            // Recovery button - conditional (amber for important)
            if (emergencyContacts?.recovery_breakdown_number) {
                console.log('✅ Recovery button enabled with number:', emergencyContacts.recovery_breakdown_number);
                recoveryBtnText.textContent = 'Call Recovery Service';

                recoveryBtn.onclick = function() {
                    console.log('📞 Calling recovery:', emergencyContacts.recovery_breakdown_number);
                    if (confirm(`Call recovery service: ${emergencyContacts.recovery_breakdown_number}?`)) {
                        window.location.href = `tel:${emergencyContacts.recovery_breakdown_number}`;
                    }
                };
            } else {
                console.log('⚠️ No recovery number available');
                recoveryBtnText.textContent = 'No Recovery Number';

                recoveryBtn.onclick = function() {
                    alert('Recovery service number not found. Please update your profile.');
                };
            }

            // Emergency contact button - conditional (green for non-critical)
            if (emergencyContacts?.emergency_contact) {
                console.log('✅ Emergency contact button enabled with number:', emergencyContacts.emergency_contact);
                emergencyContactBtnText.textContent = 'Call Emergency Contact';

                emergencyContactBtn.onclick = function() {
                    console.log('📞 Calling emergency contact:', emergencyContacts.emergency_contact);
                    if (confirm(`Call your emergency contact: ${emergencyContacts.emergency_contact}?`)) {
                        window.location.href = `tel:${emergencyContacts.emergency_contact}`;
                    }
                };
            } else {
                console.log('⚠️ No emergency contact available');
                emergencyContactBtnText.textContent = 'No Emergency Contact';

                emergencyContactBtn.onclick = function() {
                    alert('Emergency contact number not found. Please update your profile.');
                };
            }
        }

        // ===== NAVIGATION FUNCTIONS =====
        function startNewReport() {
            if (userId) {
                window.location.href = `/incident.html?user_id=${userId}`;
            } else {
                window.location.href = '/incident.html';
            }
        }

        function goToDashboard() {
            if (userId) {
                window.location.href = `/dashboard.html?user_id=${userId}`;
            } else {
                window.location.href = '/dashboard.html';
            }
        }

        // ===== MODAL AND WITNESS/VEHICLE FUNCTIONS REMOVED =====
        // Flow changed: transcription-status → declaration → report-complete
        // Witness and vehicle functionality removed per user request

        // ===== DVLA LOOKUP AND FORM SUBMISSIONS REMOVED =====

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Initializing report-complete page');

            await initSupabase();
            const fromTypeform = extractTypeformParams();
            checkIncidentSubmission();

            // Load emergency contacts and update button handlers
            await loadUserData();

            // Get what3words location for emergency services
            // Non-blocking - runs in background
            getWhat3WordsLocation();

            // Setup navigation button event listeners (CSP-compliant)
            document.getElementById('newReportBtn').addEventListener('click', startNewReport);
            document.getElementById('dashboardBtn').addEventListener('click', goToDashboard);

            console.log('📋 Page Context:', {
                userId,
                userEmail,
                fromTypeform,
                url: window.location.href
            });

            console.log('✅ Page initialization complete');
        });

        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <script src="/js/mascot.js"></script></body>
</html>