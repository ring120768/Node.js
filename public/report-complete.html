<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Submitted - Car Crash Lawyer AI</title>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .profile-complete-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-complete-banner h2 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .profile-complete-banner p {
            opacity: 0.95;
            font-size: 14px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
        }

        .success-banner {
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .info-notice {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid rgba(255, 255, 255, 0.5);
        }

        .info-notice strong {
            font-weight: 600;
        }

        .emergency-panel {
            background: #fef2f2;  /* Light red background */
            border: 2px solid #dc2626;  /* Red border */
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .emergency-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .emergency-header h3 {
            font-size: 22px;
            margin-bottom: 5px;
            color: #dc2626;  /* Red text for light background */
        }

        .emergency-header p {
            font-size: 14px;
            color: #991b1b;  /* Darker red for readability */
        }

        .emergency-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .emergency-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .emergency-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .emergency-btn:active {
            transform: translateY(0);
        }

        /* Traffic Light System - Urgency-Based Colors (matches incident.html) */
        .emergency-btn.critical {
            background: #dc2626;    /* Solid Red - Critical/Emergency */
            color: white;
        }

        .emergency-btn.recovery {
            background: #f59e0b;    /* Solid Amber - Important */
            color: white;
        }

        .emergency-btn.contact {
            background: #3b82f6;    /* Solid Blue - Non-critical */
            color: white;
        }

        .btn-icon {
            font-size: 24px;
        }

        .find-me-btn, .website-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .find-me-btn:hover, .website-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .additional-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .additional-btn {
            padding: 12px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #374151;
        }

        .additional-btn:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
            border-color: #d1d5db;
        }

        .helper-text {
            text-align: center;
            color: white;
            font-size: 14px;
            margin-top: 20px;
            line-height: 1.6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            color: #374151;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .modal-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-btn.secondary:hover {
            background: #e5e7eb;
        }

        .error-message {
            color: #ef4444;
            font-size: 13px;
            margin-top: 10px;
            padding: 10px;
            background: #fee;
            border-radius: 6px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .list-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            border-color: #d1d5db;
            background: #f3f4f6;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .list-item-details {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }

        .delete-btn {
            padding: 8px 16px;
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 6px;
            color: #dc2626;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .delete-btn:hover {
            background: #fcc;
            border-color: #faa;
            transform: translateY(-2px);
        }

        .delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .save-pdf-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #667eea;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .save-pdf-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            border-color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .save-pdf-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 640px) {
            .container {
                padding: 0 10px;
            }

            .header h1 {
                font-size: 28px;
            }

            .card {
                padding: 20px;
            }

            .additional-controls {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="/css/mascot.css"></head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 Car Crash Lawyer AI</h1>
            <p>Your Legal First Responder</p>
        </div>

        <!-- Profile Complete Banner -->
        <div class="profile-complete-banner" id="profileBanner" style="display: none;">
            <h2>✅ Profile Setup Complete!</h2>
            <p>Your account is ready. You can now report incidents anytime.</p>
            <div class="user-info" id="userInfo"></div>
        </div>

        <!-- Success Notification -->
        <div class="success-banner" id="successBanner" style="display: none;">
            ✅ Your report has been successfully submitted
        </div>

        <!-- Image Processing Notice -->
        <div class="info-notice">
            📸 <strong>Please Note:</strong> Your uploaded images and documents are being securely processed and may take up to 24 hours to be fully accessible in your account. This ensures all evidence is properly stored for legal purposes.
        </div>

        <!-- Emergency Actions Panel -->
        <div class="card emergency-panel">
            <div class="emergency-header">
                <h3>🚨 Emergency Actions</h3>
                <p>Tap to call emergency services</p>
            </div>

            <div class="emergency-buttons">
                <button class="emergency-btn critical" id="call999Btn">
                    <span class="btn-icon">📞</span>
                    <span>Call 999 - Emergency Services</span>
                </button>

                <button class="emergency-btn recovery" id="recoveryBtn">
                    <span class="btn-icon">🚗</span>
                    <span id="recoveryBtnText">Call Recovery Service</span>
                </button>

                <button class="emergency-btn contact" id="emergencyContactBtn">
                    <span class="btn-icon">👤</span>
                    <span id="emergencyContactBtnText">Call Emergency Contact</span>
                </button>
            </div>
        </div>

        <!-- Additional Reports Section -->
        <div class="card">
            <button class="find-me-btn" id="newReportBtn">
                📝 Report an Incident
            </button>

            <div class="additional-controls">
                <button class="additional-btn witness-btn" id="witnessBtn">
                    👥 Add Witnesses
                </button>
                <button class="additional-btn vehicle-btn" id="vehicleBtn">
                    🚙 Add Vehicles
                </button>
            </div>

            <!-- Witnesses List -->
            <div id="witnessListContainer" style="margin-top: 20px; display: none;">
                <h4 style="color: #374151; margin-bottom: 12px; font-size: 16px; font-weight: 600;">
                    👥 Witnesses Added (<span id="witnessCount">0</span>)
                </h4>
                <div id="witnessList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>

            <!-- Vehicles List -->
            <div id="vehicleListContainer" style="margin-top: 20px; display: none;">
                <h4 style="color: #374151; margin-bottom: 12px; font-size: 16px; font-weight: 600;">
                    🚙 Other Vehicles Added (<span id="vehicleCount">0</span>)
                </h4>
                <div id="vehicleList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>

        <!-- Go to Dashboard Button -->
        <button class="website-btn" id="dashboardBtn">
            📊 View Dashboard
        </button>

        <p class="helper-text" id="helperText">
            Need help? Contact us anytime at <strong>support@carcrashlawyerai.co.uk</strong>
        </p>
    </div>

    <!-- Witness Modal -->
    <div id="witnessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👥 Add Witness Information</h2>
                <p>Please provide details of any witnesses to the incident</p>
            </div>

            <div class="error-message" id="witnessError"></div>

            <form id="witnessForm">
                <div class="form-group">
                    <label for="witnessName">Full Name *</label>
                    <input type="text" id="witnessName" name="witness_name" required>
                </div>

                <div class="form-group">
                    <label for="witnessPhone">Phone Number *</label>
                    <input type="tel" id="witnessPhone" name="witness_phone" required
                           placeholder="e.g., 07411005390">
                </div>

                <div class="form-group">
                    <label for="witnessEmail">Email Address</label>
                    <input type="email" id="witnessEmail" name="witness_email">
                </div>

                <div class="form-group">
                    <label for="witnessAddress">Address</label>
                    <textarea id="witnessAddress" name="witness_address" rows="2"
                              placeholder="Full address (optional)"></textarea>
                </div>

                <div class="form-group">
                    <label for="witnessStatement">Witness Statement *</label>
                    <textarea id="witnessStatement" name="witness_statement" required rows="4"
                              placeholder="Please describe what the witness observed..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-btn secondary" onclick="closeModal('witnessModal')">
                        Cancel
                    </button>
                    <button type="submit" class="modal-btn primary">
                        Save Witness
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vehicle Modal -->
    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🚙 Add Vehicle Information</h2>
                <p>Please provide details of other vehicles involved</p>
            </div>

            <div class="error-message" id="vehicleError"></div>

            <form id="vehicleForm">
                <!-- Vehicle Registration with DVLA Lookup -->
                <div class="form-group">
                    <label for="vehicleLicensePlate">Vehicle Registration *
                        <span style="font-size: 12px; color: #666;">(DVLA auto-lookup)</span>
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="vehicleLicensePlate" name="vehicle_license_plate" required
                               placeholder="e.g., AB12CDE" style="flex: 1; text-transform: uppercase;">
                        <button type="button" id="dvlaLookupBtn" class="modal-btn primary"
                                style="padding: 10px 20px; white-space: nowrap;">
                            🔍 Lookup
                        </button>
                    </div>
                    <small id="dvlaStatus" style="display: block; margin-top: 5px; font-size: 12px;"></small>
                </div>

                <!-- Vehicle Details (auto-populated by DVLA) -->
                <div id="vehicleDetailsSection" style="display: none; background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0369a1;">
                    <h4 style="color: #0369a1; margin-bottom: 15px; font-size: 14px;">✅ Vehicle Details (from DVLA)</h4>

                    <!-- Basic Vehicle Info -->
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #0369a1; margin-bottom: 8px; font-size: 12px; text-transform: uppercase;">Basic Information</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                            <div><strong>Make:</strong> <span id="dvlaMake">-</span></div>
                            <div><strong>Model:</strong> <span id="dvlaModel">-</span></div>
                            <div><strong>Color:</strong> <span id="dvlaColor">-</span></div>
                            <div><strong>Year:</strong> <span id="dvlaYear">-</span></div>
                            <div><strong>Fuel Type:</strong> <span id="dvlaFuelType">-</span></div>
                            <div><strong>Engine:</strong> <span id="dvlaEngineCapacity">-</span></div>
                        </div>
                    </div>

                    <!-- MOT & Tax Status -->
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #0369a1; margin-bottom: 8px; font-size: 12px; text-transform: uppercase;">MOT & Tax</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                            <div><strong>MOT Status:</strong> <span id="dvlaMotStatus">-</span></div>
                            <div><strong>MOT Expiry:</strong> <span id="dvlaMotExpiry">-</span></div>
                            <div><strong>Tax Status:</strong> <span id="dvlaTaxStatus">-</span></div>
                            <div><strong>Tax Due:</strong> <span id="dvlaTaxDue">-</span></div>
                        </div>
                    </div>

                    <!-- V5C Date -->
                    <div style="font-size: 13px;">
                        <strong>V5C Last Issued:</strong> <span id="dvlaV5CDate">-</span>
                    </div>
                </div>

                <!-- Driver Information -->
                <div class="form-group">
                    <label for="driverName">Driver's Full Name *</label>
                    <input type="text" id="driverName" name="driver_name" required>
                </div>

                <div class="form-group">
                    <label for="driverPhone">Driver's Phone Number *</label>
                    <input type="tel" id="driverPhone" name="driver_phone" required
                           placeholder="e.g., 07411005390">
                </div>

                <div class="form-group">
                    <label for="driverAddress">Driver's Address</label>
                    <textarea id="driverAddress" name="driver_address" rows="2"></textarea>
                </div>

                <!-- Insurance Information -->
                <div class="form-group">
                    <label for="insuranceCompany">Insurance Company</label>
                    <input type="text" id="insuranceCompany" name="insurance_company">
                </div>

                <div class="form-group">
                    <label for="policyNumber">Policy Number</label>
                    <input type="text" id="policyNumber" name="policy_number">
                </div>

                <div class="form-group">
                    <label for="policyCover">Policy Cover Type</label>
                    <select id="policyCover" name="policy_cover">
                        <option value="">Select...</option>
                        <option value="comprehensive">Comprehensive</option>
                        <option value="third_party_fire_theft">Third Party, Fire & Theft</option>
                        <option value="third_party">Third Party Only</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="policyHolder">Policy Holder Name</label>
                    <input type="text" id="policyHolder" name="policy_holder">
                </div>

                <!-- Damage Description -->
                <div class="form-group">
                    <label for="damageDescription">Damage Description</label>
                    <textarea id="damageDescription" name="damage_description" rows="3"
                              placeholder="Describe any visible damage to the vehicle..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-btn secondary" onclick="closeModal('vehicleModal')">
                        Cancel
                    </button>
                    <button type="submit" class="modal-btn primary">
                        Save Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== TYPEFORM REDIRECT HANDLER =====
        function extractTypeformParams() {
            const urlParams = new URLSearchParams(window.location.search);

            const user_id = urlParams.get('auth_user_id') || 
                           urlParams.get('user_id') || 
                           urlParams.get('userId') || 
                           urlParams.get('create_user_id');

            const product_id = urlParams.get('product_id');
            const auth_code = urlParams.get('auth_code');
            const email = urlParams.get('email');
            const incident_id = urlParams.get('incident_id');

            console.log('🔥 Typeform redirect parameters:', {
                user_id,
                product_id,
                auth_code,
                email,
                incident_id,
                fullUrl: window.location.href
            });

            // Store user session data
            if (user_id) {
                localStorage.setItem('create_user_id', user_id);
                sessionStorage.setItem('userId', user_id);

                if (auth_code) sessionStorage.setItem('auth_code', auth_code);
                if (email) sessionStorage.setItem('userEmail', email);
                if (product_id) sessionStorage.setItem('product_id', product_id);
                if (incident_id) sessionStorage.setItem('incident_id', incident_id);

                // Show profile banner
                const profileBanner = document.getElementById('profileBanner');
                profileBanner.style.display = 'block';

                // Update user info display
                const userInfo = document.getElementById('userInfo');
                userInfo.innerHTML = `
                    <strong>Email:</strong> ${email || 'Not provided'}<br>
                    <strong>User ID:</strong> ${user_id.substring(0, 8)}...
                `;

                console.log('✅ User authenticated from Typeform:', user_id);
                return true;
            }

            return false;
        }

        // Check if this is from an incident submission
        function checkIncidentSubmission() {
            const incidentId = sessionStorage.getItem('incident_id') || 
                              new URLSearchParams(window.location.search).get('incident_id');

            if (incidentId) {
                document.getElementById('successBanner').style.display = 'block';
                document.getElementById('helperText').innerHTML = `
                    Reference: <strong id="incident-ref">${incidentId}</strong><br>
                    We'll be in touch within 24 hours
                `;
            }
        }

        // ===== SUPABASE INITIALIZATION =====
        let supabase = null;

        async function initSupabase() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                if (config.supabaseUrl && config.supabaseKey) {
                    supabase = window.supabase.createClient(
                        config.supabaseUrl,
                        config.supabaseKey
                    );
                    console.log('✅ Supabase initialized');
                } else {
                    console.warn('⚠️ Supabase config not available');
                }
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
            }
        }

        // Get current user data
        const userId = localStorage.getItem('create_user_id') || 
                      sessionStorage.getItem('userId');
        const userEmail = sessionStorage.getItem('userEmail');

        // ===== EMERGENCY FUNCTIONS =====
        let emergencyContacts = null;
        let what3wordsData = null;  // Stores what3words location for 999 calls

        // Get user's what3words location
        async function getWhat3WordsLocation() {
            try {
                console.log('📍 Getting what3words location...');

                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    console.warn('⚠️ Geolocation not supported by browser');
                    return;
                }

                // Get current position
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const { latitude, longitude } = position.coords;
                console.log('✅ Location obtained:', { latitude, longitude });

                // Convert to what3words using backend API
                const response = await fetch('/api/location/what3words', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude, longitude })
                });

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.words) {
                    what3wordsData = result.words;
                    console.log('✅ what3words location:', what3wordsData);
                } else {
                    console.warn('⚠️ what3words lookup failed:', result.error);
                }

            } catch (error) {
                // Geolocation errors are common (user denial, timeout, etc.)
                // Log but don't disrupt the page
                if (error.code === 1) {
                    console.log('ℹ️ User denied location access (normal behavior)');
                } else if (error.code === 2) {
                    console.warn('⚠️ Location unavailable');
                } else if (error.code === 3) {
                    console.warn('⚠️ Location request timed out');
                } else {
                    console.warn('⚠️ Error getting what3words location:', error.message);
                }
            }
        }

        // Load emergency contacts once on page load
        async function loadUserData() {
            if (!userId) {
                console.log('⚠️ No userId available, skipping emergency contacts load');
                return;
            }

            try {
                console.log('📞 Loading emergency contacts for userId:', userId);
                const response = await fetch(`/api/emergency/contacts/${userId}`);

                console.log('API Response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                emergencyContacts = await response.json();
                console.log('✅ Emergency contacts loaded:', emergencyContacts);

                // Update button handlers with loaded contacts
                updateEmergencyButtons();

            } catch (error) {
                console.error('❌ Error loading emergency contacts:', error);
            }
        }

        // Update button handlers (colors are fixed in CSS by urgency level)
        function updateEmergencyButtons() {
            const call999Btn = document.getElementById('call999Btn');
            const recoveryBtn = document.getElementById('recoveryBtn');
            const emergencyContactBtn = document.getElementById('emergencyContactBtn');
            const recoveryBtnText = document.getElementById('recoveryBtnText');
            const emergencyContactBtnText = document.getElementById('emergencyContactBtnText');

            // 999 button - always available (red for critical)
            call999Btn.onclick = function() {
                const emergencyNumber = emergencyContacts?.emergency_services_number || '999';
                console.log('📞 Calling 999:', emergencyNumber);

                let message = `This will call ${emergencyNumber} Emergency Services.`;

                // Include what3words location if available
                if (what3wordsData) {
                    message += `\n\nYour what3words location: ///${what3wordsData}`;
                    message += '\n\nPlease provide this location to the operator.';
                }

                if (confirm(message)) {
                    window.location.href = `tel:${emergencyNumber}`;
                }
            };

            // Recovery button - conditional (amber for important)
            if (emergencyContacts?.recovery_breakdown_number) {
                console.log('✅ Recovery button enabled with number:', emergencyContacts.recovery_breakdown_number);
                recoveryBtnText.textContent = 'Call Recovery Service';

                recoveryBtn.onclick = function() {
                    console.log('📞 Calling recovery:', emergencyContacts.recovery_breakdown_number);
                    if (confirm(`Call recovery service: ${emergencyContacts.recovery_breakdown_number}?`)) {
                        window.location.href = `tel:${emergencyContacts.recovery_breakdown_number}`;
                    }
                };
            } else {
                console.log('⚠️ No recovery number available');
                recoveryBtnText.textContent = 'No Recovery Number';

                recoveryBtn.onclick = function() {
                    alert('Recovery service number not found. Please update your profile.');
                };
            }

            // Emergency contact button - conditional (green for non-critical)
            if (emergencyContacts?.emergency_contact) {
                console.log('✅ Emergency contact button enabled with number:', emergencyContacts.emergency_contact);
                emergencyContactBtnText.textContent = 'Call Emergency Contact';

                emergencyContactBtn.onclick = function() {
                    console.log('📞 Calling emergency contact:', emergencyContacts.emergency_contact);
                    if (confirm(`Call your emergency contact: ${emergencyContacts.emergency_contact}?`)) {
                        window.location.href = `tel:${emergencyContacts.emergency_contact}`;
                    }
                };
            } else {
                console.log('⚠️ No emergency contact available');
                emergencyContactBtnText.textContent = 'No Emergency Contact';

                emergencyContactBtn.onclick = function() {
                    alert('Emergency contact number not found. Please update your profile.');
                };
            }
        }

        // ===== NAVIGATION FUNCTIONS =====
        function startNewReport() {
            if (userId) {
                window.location.href = `/incident.html?user_id=${userId}`;
            } else {
                window.location.href = '/incident.html';
            }
        }

        function goToDashboard() {
            if (userId) {
                window.location.href = `/dashboard.html?user_id=${userId}`;
            } else {
                window.location.href = '/dashboard.html';
            }
        }

        // ===== MODAL FUNCTIONS =====
        function openWitnessModal() {
            document.getElementById('witnessModal').classList.add('active');
        }

        function openVehicleModal() {
            document.getElementById('vehicleModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.querySelector(`#${modalId} form`).reset();
            document.querySelector(`#${modalId} .error-message`).classList.remove('show');
        }

        // ===== WITNESS & VEHICLE LIST FUNCTIONS =====

        async function loadWitnesses() {
            const incidentId = sessionStorage.getItem('incident_id');
            if (!incidentId) return;

            try {
                const response = await fetch(`/api/witnesses/${incidentId}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to load witnesses');
                }

                const witnesses = result.witnesses || [];
                const witnessContainer = document.getElementById('witnessListContainer');
                const witnessList = document.getElementById('witnessList');
                const witnessCount = document.getElementById('witnessCount');

                if (witnesses.length === 0) {
                    witnessContainer.style.display = 'none';
                    return;
                }

                witnessCount.textContent = witnesses.length;
                witnessContainer.style.display = 'block';

                witnessList.innerHTML = witnesses.map(witness => `
                    <div class="list-item">
                        <div class="list-item-content">
                            <div class="list-item-title">${witness.witness_name}</div>
                            <div class="list-item-details">
                                📞 ${witness.witness_phone}
                                ${witness.witness_email ? ` • ✉️ ${witness.witness_email}` : ''}
                            </div>
                        </div>
                        <button class="save-pdf-btn" onclick="generateAndDownloadPdf('${witness.id}', 'witness')" style="margin-right: 8px;">
                            📄 Confirm and Save
                        </button>
                        <button class="delete-btn" onclick="deleteWitness('${witness.id}')">
                            🗑️ Delete
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading witnesses:', error);
            }
        }

        async function loadVehicles() {
            const incidentId = sessionStorage.getItem('incident_id');
            if (!incidentId) return;

            try {
                const response = await fetch(`/api/other-vehicles/${incidentId}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to load vehicles');
                }

                const vehicles = result.vehicles || [];
                const vehicleContainer = document.getElementById('vehicleListContainer');
                const vehicleList = document.getElementById('vehicleList');
                const vehicleCount = document.getElementById('vehicleCount');

                if (vehicles.length === 0) {
                    vehicleContainer.style.display = 'none';
                    return;
                }

                vehicleCount.textContent = vehicles.length;
                vehicleContainer.style.display = 'block';

                vehicleList.innerHTML = vehicles.map(vehicle => `
                    <div class="list-item">
                        <div class="list-item-content">
                            <div class="list-item-title">
                                🚗 ${vehicle.vehicle_license_plate}
                                ${vehicle.vehicle_make && vehicle.vehicle_model ?
                                  `(${vehicle.vehicle_make} ${vehicle.vehicle_model})` : ''}
                            </div>
                            <div class="list-item-details">
                                👤 ${vehicle.driver_name} • 📞 ${vehicle.driver_phone}
                                ${vehicle.insurance_company ? ` • 🛡️ ${vehicle.insurance_company}` : ''}
                            </div>
                        </div>
                        <button class="save-pdf-btn" onclick="generateAndDownloadPdf('${vehicle.id}', 'vehicle')" style="margin-right: 8px;">
                            📄 Confirm and Save
                        </button>
                        <button class="delete-btn" onclick="deleteVehicle('${vehicle.id}')">
                            🗑️ Delete
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }

        /**
         * Generate and download PDF for witness or vehicle
         */
        async function generateAndDownloadPdf(id, type) {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '⏳ Generating PDF...';

            try {
                const endpoint = type === 'witness'
                    ? `/api/witnesses/${id}/generate-pdf`
                    : `/api/other-vehicles/${id}/generate-pdf`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.message || 'PDF generation failed');
                }

                // Download PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${type}-${id}-${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                button.textContent = '✅ PDF Downloaded';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert(`❌ Failed to generate PDF: ${error.message}. Please try again.`);
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function deleteWitness(witnessId) {
            if (!confirm('Are you sure you want to delete this witness? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/witnesses/${witnessId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to delete witness');
                }

                alert('✅ Witness deleted successfully');
                await loadWitnesses(); // Reload the list

            } catch (error) {
                console.error('Error deleting witness:', error);
                alert('❌ Failed to delete witness. Please try again.');
            }
        }

        async function deleteVehicle(vehicleId) {
            if (!confirm('Are you sure you want to delete this vehicle? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/other-vehicles/${vehicleId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to delete vehicle');
                }

                alert('✅ Vehicle deleted successfully');
                await loadVehicles(); // Reload the list

            } catch (error) {
                console.error('Error deleting vehicle:', error);
                alert('❌ Failed to delete vehicle. Please try again.');
            }
        }

        // ===== DVLA LOOKUP =====
        document.getElementById('dvlaLookupBtn').addEventListener('click', async () => {
            const licensePlate = document.getElementById('vehicleLicensePlate').value.trim();
            const statusDiv = document.getElementById('dvlaStatus');
            const detailsSection = document.getElementById('vehicleDetailsSection');
            const lookupBtn = document.getElementById('dvlaLookupBtn');

            if (!licensePlate) {
                statusDiv.textContent = '⚠️ Please enter a vehicle registration';
                statusDiv.style.color = '#f59e0b';
                return;
            }

            lookupBtn.disabled = true;
            lookupBtn.textContent = '⏳ Looking up...';
            statusDiv.textContent = 'Contacting DVLA...';
            statusDiv.style.color = '#3b82f6';

            try {
                const response = await fetch('/api/other-vehicles/dvla-lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vehicle_license_plate: licensePlate })
                });

                const result = await response.json();

                if (result.success && result.vehicle) {
                    const v = result.vehicle;

                    // Basic Information
                    document.getElementById('dvlaMake').textContent = v.make || '-';
                    document.getElementById('dvlaModel').textContent = v.model || '-';
                    document.getElementById('dvlaColor').textContent = v.color || '-';
                    document.getElementById('dvlaYear').textContent = v.year_of_manufacture || '-';
                    document.getElementById('dvlaFuelType').textContent = v.fuel_type || '-';
                    document.getElementById('dvlaEngineCapacity').textContent = v.engine_capacity ? `${v.engine_capacity}cc` : '-';

                    // MOT & Tax Status with color coding
                    const motStatusEl = document.getElementById('dvlaMotStatus');
                    motStatusEl.textContent = v.mot_status || '-';
                    motStatusEl.style.color = v.mot_status === 'Valid' ? '#10b981' : (v.mot_status === 'No details held by DVLA' ? '#f59e0b' : '#ef4444');
                    motStatusEl.style.fontWeight = '600';

                    document.getElementById('dvlaMotExpiry').textContent = v.mot_expiry_date || '-';

                    const taxStatusEl = document.getElementById('dvlaTaxStatus');
                    taxStatusEl.textContent = v.tax_status || '-';
                    taxStatusEl.style.color = v.tax_status === 'Taxed' ? '#10b981' : (v.tax_status === 'SORN' ? '#f59e0b' : '#ef4444');
                    taxStatusEl.style.fontWeight = '600';

                    document.getElementById('dvlaTaxDue').textContent = v.tax_due_date || '-';

                    // V5C Date
                    document.getElementById('dvlaV5CDate').textContent = v.date_of_last_v5c_issued || '-';

                    detailsSection.style.display = 'block';
                    statusDiv.textContent = '✅ Vehicle found in DVLA database';
                    statusDiv.style.color = '#10b981';
                } else {
                    detailsSection.style.display = 'none';
                    statusDiv.textContent = `⚠️ ${result.error || 'Vehicle not found'}. You can still add manually.`;
                    statusDiv.style.color = '#f59e0b';
                }

            } catch (error) {
                console.error('DVLA lookup error:', error);
                detailsSection.style.display = 'none';
                statusDiv.textContent = '❌ DVLA lookup failed. You can still add the vehicle manually.';
                statusDiv.style.color = '#ef4444';
            } finally {
                lookupBtn.disabled = false;
                lookupBtn.textContent = '🔍 Lookup';
            }
        });

        // Automatic DVLA lookup when user finishes typing (with debounce)
        let dvlaLookupTimeout;
        document.getElementById('vehicleLicensePlate').addEventListener('input', (e) => {
            const licensePlate = e.target.value.trim();

            // Clear previous timeout
            clearTimeout(dvlaLookupTimeout);

            // Auto-lookup after 1 second of no typing (UK registrations are 5-7 chars)
            if (licensePlate.length >= 5) {
                dvlaLookupTimeout = setTimeout(() => {
                    document.getElementById('dvlaLookupBtn').click();
                }, 1000);
            }
        });

        // Also trigger on blur (when user tabs out)
        document.getElementById('vehicleLicensePlate').addEventListener('blur', (e) => {
            const licensePlate = e.target.value.trim();
            if (licensePlate.length >= 5) {
                // Small delay to avoid double-lookup if they clicked the button
                setTimeout(() => {
                    const dvlaStatus = document.getElementById('dvlaStatus').textContent;
                    // Only auto-lookup if we haven't already looked up this plate
                    if (!dvlaStatus.includes('✅') && !dvlaStatus.includes('Contacting')) {
                        document.getElementById('dvlaLookupBtn').click();
                    }
                }, 300);
            }
        });

        // ===== FORM SUBMISSIONS =====
        document.getElementById('witnessForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const errorDiv = document.getElementById('witnessError');
            const submitBtn = form.querySelector('button[type="submit"]');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const incidentId = sessionStorage.getItem('incident_id');

                if (!incidentId) {
                    throw new Error('No incident ID found. Please submit an incident report first.');
                }

                const formData = new FormData(form);
                const witnessData = {
                    incident_id: incidentId,
                    create_user_id: userId,
                    witness_name: formData.get('witness_name'),
                    witness_phone: formData.get('witness_phone'),
                    witness_email: formData.get('witness_email') || null,
                    witness_address: formData.get('witness_address') || null,
                    witness_statement: formData.get('witness_statement')
                };

                const response = await fetch('/api/witnesses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(witnessData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to save witness');
                }

                closeModal('witnessModal');
                alert('✅ Witness information saved successfully!');

                // Reload witness list if it exists
                if (typeof loadWitnesses === 'function') {
                    loadWitnesses();
                }

            } catch (error) {
                console.error('Error saving witness:', error);
                errorDiv.textContent = error.message || 'Failed to save witness information. Please try again.';
                errorDiv.classList.add('show');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Witness';
            }
        });

        document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const errorDiv = document.getElementById('vehicleError');
            const submitBtn = form.querySelector('button[type="submit"]');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const incidentId = sessionStorage.getItem('incident_id');

                if (!incidentId) {
                    throw new Error('No incident ID found. Please submit an incident report first.');
                }

                const formData = new FormData(form);
                const vehicleData = {
                    incident_id: incidentId,
                    create_user_id: userId,
                    vehicle_license_plate: formData.get('vehicle_license_plate'),
                    driver_name: formData.get('driver_name'),
                    driver_phone: formData.get('driver_phone'),
                    driver_address: formData.get('driver_address') || null,
                    insurance_company: formData.get('insurance_company') || null,
                    policy_number: formData.get('policy_number') || null,
                    policy_cover: formData.get('policy_cover') || null,
                    policy_holder: formData.get('policy_holder') || null,
                    damage_description: formData.get('damage_description') || null
                };

                const response = await fetch('/api/other-vehicles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(vehicleData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to save vehicle');
                }

                closeModal('vehicleModal');

                // Show success message with DVLA lookup status
                if (result.dvla_lookup && result.dvla_lookup.successful) {
                    alert('✅ Vehicle information saved successfully!\n✓ Vehicle details auto-populated from DVLA');
                } else if (result.dvla_lookup && result.dvla_lookup.error) {
                    alert('✅ Vehicle information saved successfully!\n⚠️ DVLA lookup unavailable, details saved as entered');
                } else {
                    alert('✅ Vehicle information saved successfully!');
                }

                // Clear DVLA lookup UI
                document.getElementById('vehicleDetailsSection').style.display = 'none';
                document.getElementById('dvlaStatus').textContent = '';

                // Reload vehicle list if it exists
                if (typeof loadVehicles === 'function') {
                    loadVehicles();
                }

            } catch (error) {
                console.error('Error saving vehicle:', error);
                errorDiv.textContent = error.message || 'Failed to save vehicle information. Please try again.';
                errorDiv.classList.add('show');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Vehicle';
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Initializing report-complete page');

            await initSupabase();
            const fromTypeform = extractTypeformParams();
            checkIncidentSubmission();

            // Load emergency contacts and update button handlers
            await loadUserData();

            // Get what3words location for emergency services
            // Non-blocking - runs in background
            getWhat3WordsLocation();

            // Load witnesses and vehicles if there's an incident_id
            await loadWitnesses();
            await loadVehicles();

            // Setup navigation button event listeners (CSP-compliant)
            document.getElementById('newReportBtn').addEventListener('click', startNewReport);
            document.getElementById('witnessBtn').addEventListener('click', openWitnessModal);
            document.getElementById('vehicleBtn').addEventListener('click', openVehicleModal);
            document.getElementById('dashboardBtn').addEventListener('click', goToDashboard);

            console.log('📋 Page Context:', {
                userId,
                userEmail,
                fromTypeform,
                url: window.location.href
            });

            console.log('✅ Page initialization complete');
        });

        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <script src="/js/mascot.js"></script></body>
</html>