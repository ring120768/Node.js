<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Submitted - Car Crash Lawyer AI</title>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .profile-complete-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-complete-banner h2 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .profile-complete-banner p {
            opacity: 0.95;
            font-size: 14px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
        }

        .success-banner {
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .info-notice {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid rgba(255, 255, 255, 0.5);
        }

        .info-notice strong {
            font-weight: 600;
        }

        .emergency-panel {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .emergency-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .emergency-header h3 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .emergency-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .emergency-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .emergency-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .emergency-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .emergency-btn:active {
            transform: translateY(0);
        }

        /* Traffic Light System - Button State Colors */
        .emergency-btn.btn-available {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.6);
        }

        .emergency-btn.btn-available:hover {
            background: rgba(16, 185, 129, 0.4);
        }

        .emergency-btn.btn-unavailable {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .emergency-btn.btn-unavailable:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: none;
        }

        .btn-icon {
            font-size: 24px;
        }

        .find-me-btn, .website-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .find-me-btn:hover, .website-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .additional-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .additional-btn {
            padding: 12px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #374151;
        }

        .additional-btn:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
            border-color: #d1d5db;
        }

        .helper-text {
            text-align: center;
            color: white;
            font-size: 14px;
            margin-top: 20px;
            line-height: 1.6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            color: #374151;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .modal-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-btn.secondary:hover {
            background: #e5e7eb;
        }

        .error-message {
            color: #ef4444;
            font-size: 13px;
            margin-top: 10px;
            padding: 10px;
            background: #fee;
            border-radius: 6px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @media (max-width: 640px) {
            .container {
                padding: 0 10px;
            }

            .header h1 {
                font-size: 28px;
            }

            .card {
                padding: 20px;
            }

            .additional-controls {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="/css/mascot.css"></head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 Car Crash Lawyer AI</h1>
            <p>Your Legal First Responder</p>
        </div>

        <!-- Profile Complete Banner -->
        <div class="profile-complete-banner" id="profileBanner" style="display: none;">
            <h2>✅ Profile Setup Complete!</h2>
            <p>Your account is ready. You can now report incidents anytime.</p>
            <div class="user-info" id="userInfo"></div>
        </div>

        <!-- Success Notification -->
        <div class="success-banner" id="successBanner" style="display: none;">
            ✅ Your report has been successfully submitted
        </div>

        <!-- Image Processing Notice -->
        <div class="info-notice">
            📸 <strong>Please Note:</strong> Your uploaded images and documents are being securely processed and may take up to 24 hours to be fully accessible in your account. This ensures all evidence is properly stored for legal purposes.
        </div>

        <!-- Emergency Actions Panel -->
        <div class="card emergency-panel">
            <div class="emergency-header">
                <h3>🚨 Emergency Actions</h3>
                <p>Tap to call emergency services</p>
            </div>

            <div class="emergency-buttons">
                <button class="emergency-btn critical" id="call999Btn">
                    <span class="btn-icon">📞</span>
                    <span>Call 999 - Emergency Services</span>
                </button>

                <button class="emergency-btn recovery" id="recoveryBtn">
                    <span class="btn-icon">🚗</span>
                    <span id="recoveryBtnText">Call Recovery Service</span>
                </button>

                <button class="emergency-btn contact" id="emergencyContactBtn">
                    <span class="btn-icon">👤</span>
                    <span id="emergencyContactBtnText">Call Emergency Contact</span>
                </button>
            </div>
        </div>

        <!-- Additional Reports Section -->
        <div class="card">
            <button class="find-me-btn" onclick="startNewReport()">
                📝 Report an Incident
            </button>

            <div class="additional-controls">
                <button class="additional-btn witness-btn" onclick="openWitnessModal()">
                    👥 Add Witnesses
                </button>
                <button class="additional-btn vehicle-btn" onclick="openVehicleModal()">
                    🚙 Add Vehicles
                </button>
            </div>
        </div>

        <!-- Go to Dashboard Button -->
        <button class="website-btn" onclick="goToDashboard()">
            📊 View Dashboard
        </button>

        <p class="helper-text" id="helperText">
            Need help? Contact us anytime at <strong>support@carcrashlawyerai.co.uk</strong>
        </p>
    </div>

    <!-- Witness Modal -->
    <div id="witnessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👥 Add Witness Information</h2>
                <p>Please provide details of any witnesses to the incident</p>
            </div>

            <div class="error-message" id="witnessError"></div>

            <form id="witnessForm">
                <div class="form-group">
                    <label for="witnessName">Full Name *</label>
                    <input type="text" id="witnessName" name="witnessName" required>
                </div>

                <div class="form-group">
                    <label for="witnessAddress">Address *</label>
                    <input type="text" id="witnessAddress" name="witnessAddress" required>
                </div>

                <div class="form-group">
                    <label for="witnessMobile">Mobile Number *</label>
                    <input type="tel" id="witnessMobile" name="witnessMobile" required>
                </div>

                <div class="form-group">
                    <label for="witnessEmail">Email Address</label>
                    <input type="email" id="witnessEmail" name="witnessEmail">
                </div>

                <div class="form-group">
                    <label for="witnessStatement">Witness Statement *</label>
                    <textarea id="witnessStatement" name="witnessStatement" required 
                              placeholder="Please describe what the witness observed..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-btn secondary" onclick="closeModal('witnessModal')">
                        Cancel
                    </button>
                    <button type="submit" class="modal-btn primary">
                        Save Witness
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vehicle Modal -->
    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🚙 Add Vehicle Information</h2>
                <p>Please provide details of other vehicles involved</p>
            </div>

            <div class="error-message" id="vehicleError"></div>

            <form id="vehicleForm">
                <div class="form-group">
                    <label for="driverName">Driver's Full Name *</label>
                    <input type="text" id="driverName" name="driverName" required>
                </div>

                <div class="form-group">
                    <label for="driverAddress">Driver's Address *</label>
                    <input type="text" id="driverAddress" name="driverAddress" required>
                </div>

                <div class="form-group">
                    <label for="driverMobile">Driver's Mobile Number *</label>
                    <input type="tel" id="driverMobile" name="driverMobile" required>
                </div>

                <div class="form-group">
                    <label for="driverEmail">Driver's Email</label>
                    <input type="email" id="driverEmail" name="driverEmail">
                </div>

                <div class="form-group">
                    <label for="vehicleReg">Vehicle Registration *</label>
                    <input type="text" id="vehicleReg" name="vehicleReg" required 
                           placeholder="e.g., AB12 CDE">
                </div>

                <div class="form-group">
                    <label for="vehicleMake">Vehicle Make *</label>
                    <input type="text" id="vehicleMake" name="vehicleMake" required 
                           placeholder="e.g., Ford">
                </div>

                <div class="form-group">
                    <label for="vehicleModel">Vehicle Model *</label>
                    <input type="text" id="vehicleModel" name="vehicleModel" required 
                           placeholder="e.g., Focus">
                </div>

                <div class="form-group">
                    <label for="vehicleColor">Vehicle Color</label>
                    <input type="text" id="vehicleColor" name="vehicleColor" 
                           placeholder="e.g., Blue">
                </div>

                <div class="form-group">
                    <label for="insuranceCompany">Insurance Company</label>
                    <input type="text" id="insuranceCompany" name="insuranceCompany">
                </div>

                <div class="form-group">
                    <label for="insurancePolicy">Policy Number</label>
                    <input type="text" id="insurancePolicy" name="insurancePolicy">
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-btn secondary" onclick="closeModal('vehicleModal')">
                        Cancel
                    </button>
                    <button type="submit" class="modal-btn primary">
                        Save Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== TYPEFORM REDIRECT HANDLER =====
        function extractTypeformParams() {
            const urlParams = new URLSearchParams(window.location.search);

            const user_id = urlParams.get('auth_user_id') || 
                           urlParams.get('user_id') || 
                           urlParams.get('userId') || 
                           urlParams.get('create_user_id');

            const product_id = urlParams.get('product_id');
            const auth_code = urlParams.get('auth_code');
            const email = urlParams.get('email');
            const incident_id = urlParams.get('incident_id');

            console.log('🔥 Typeform redirect parameters:', {
                user_id,
                product_id,
                auth_code,
                email,
                incident_id,
                fullUrl: window.location.href
            });

            // Store user session data
            if (user_id) {
                localStorage.setItem('create_user_id', user_id);
                sessionStorage.setItem('userId', user_id);

                if (auth_code) sessionStorage.setItem('auth_code', auth_code);
                if (email) sessionStorage.setItem('userEmail', email);
                if (product_id) sessionStorage.setItem('product_id', product_id);
                if (incident_id) sessionStorage.setItem('incident_id', incident_id);

                // Show profile banner
                const profileBanner = document.getElementById('profileBanner');
                profileBanner.style.display = 'block';

                // Update user info display
                const userInfo = document.getElementById('userInfo');
                userInfo.innerHTML = `
                    <strong>Email:</strong> ${email || 'Not provided'}<br>
                    <strong>User ID:</strong> ${user_id.substring(0, 8)}...
                `;

                console.log('✅ User authenticated from Typeform:', user_id);
                return true;
            }

            return false;
        }

        // Check if this is from an incident submission
        function checkIncidentSubmission() {
            const incidentId = sessionStorage.getItem('incident_id') || 
                              new URLSearchParams(window.location.search).get('incident_id');

            if (incidentId) {
                document.getElementById('successBanner').style.display = 'block';
                document.getElementById('helperText').innerHTML = `
                    Reference: <strong id="incident-ref">${incidentId}</strong><br>
                    We'll be in touch within 24 hours
                `;
            }
        }

        // ===== SUPABASE INITIALIZATION =====
        let supabase = null;

        async function initSupabase() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                if (config.supabaseUrl && config.supabaseKey) {
                    supabase = window.supabase.createClient(
                        config.supabaseUrl,
                        config.supabaseKey
                    );
                    console.log('✅ Supabase initialized');
                } else {
                    console.warn('⚠️ Supabase config not available');
                }
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
            }
        }

        // Get current user data
        const userId = localStorage.getItem('create_user_id') || 
                      sessionStorage.getItem('userId');
        const userEmail = sessionStorage.getItem('userEmail');

        // ===== EMERGENCY FUNCTIONS =====
        let emergencyContacts = null;

        // Load emergency contacts once on page load
        async function loadUserData() {
            if (!userId) {
                console.log('⚠️ No userId available, skipping emergency contacts load');
                return;
            }

            try {
                console.log('📞 Loading emergency contacts for userId:', userId);
                const response = await fetch(`/api/emergency/contacts/${userId}`);

                console.log('API Response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                emergencyContacts = await response.json();
                console.log('✅ Emergency contacts loaded:', emergencyContacts);

                // Update button handlers with loaded contacts
                updateEmergencyButtons();

            } catch (error) {
                console.error('❌ Error loading emergency contacts:', error);
            }
        }

        // Update button handlers and apply traffic light colors
        function updateEmergencyButtons() {
            const call999Btn = document.getElementById('call999Btn');
            const recoveryBtn = document.getElementById('recoveryBtn');
            const emergencyContactBtn = document.getElementById('emergencyContactBtn');
            const recoveryBtnText = document.getElementById('recoveryBtnText');
            const emergencyContactBtnText = document.getElementById('emergencyContactBtnText');

            // 999 button - always available (green)
            call999Btn.classList.add('btn-available');
            call999Btn.onclick = function() {
                console.log('📞 Calling 999: 999');
                window.location.href = 'tel:999';
            };

            // Recovery button - conditional
            if (emergencyContacts?.recovery_breakdown_number) {
                console.log('✅ Recovery button enabled with number:', emergencyContacts.recovery_breakdown_number);
                recoveryBtn.classList.remove('btn-unavailable');
                recoveryBtn.classList.add('btn-available');
                recoveryBtnText.textContent = 'Call Recovery Service';

                recoveryBtn.onclick = function() {
                    console.log('📞 Calling recovery:', emergencyContacts.recovery_breakdown_number);
                    if (confirm(`Call recovery service: ${emergencyContacts.recovery_breakdown_number}?`)) {
                        window.location.href = `tel:${emergencyContacts.recovery_breakdown_number}`;
                    }
                };
            } else {
                console.log('❌ Recovery button disabled - no number available');
                recoveryBtn.classList.remove('btn-available');
                recoveryBtn.classList.add('btn-unavailable');
                recoveryBtnText.textContent = 'No Recovery Number';

                recoveryBtn.onclick = function() {
                    alert('Recovery service number not found. Please update your profile.');
                };
            }

            // Emergency contact button - conditional
            if (emergencyContacts?.emergency_contact) {
                console.log('✅ Emergency contact button enabled with number:', emergencyContacts.emergency_contact);
                emergencyContactBtn.classList.remove('btn-unavailable');
                emergencyContactBtn.classList.add('btn-available');
                emergencyContactBtnText.textContent = 'Call Emergency Contact';

                emergencyContactBtn.onclick = function() {
                    console.log('📞 Calling emergency contact:', emergencyContacts.emergency_contact);
                    if (confirm(`Call your emergency contact: ${emergencyContacts.emergency_contact}?`)) {
                        window.location.href = `tel:${emergencyContacts.emergency_contact}`;
                    }
                };
            } else {
                console.log('❌ Emergency contact button disabled - no number available');
                emergencyContactBtn.classList.remove('btn-available');
                emergencyContactBtn.classList.add('btn-unavailable');
                emergencyContactBtnText.textContent = 'No Emergency Contact';

                emergencyContactBtn.onclick = function() {
                    alert('Emergency contact number not found. Please update your profile.');
                };
            }
        }

        // ===== NAVIGATION FUNCTIONS =====
        function startNewReport() {
            if (userId) {
                window.location.href = `/incident.html?user_id=${userId}`;
            } else {
                window.location.href = '/incident.html';
            }
        }

        function goToDashboard() {
            if (userId) {
                window.location.href = `/dashboard.html?user_id=${userId}`;
            } else {
                window.location.href = '/dashboard.html';
            }
        }

        // ===== MODAL FUNCTIONS =====
        function openWitnessModal() {
            document.getElementById('witnessModal').classList.add('active');
        }

        function openVehicleModal() {
            document.getElementById('vehicleModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.querySelector(`#${modalId} form`).reset();
            document.querySelector(`#${modalId} .error-message`).classList.remove('show');
        }

        // ===== FORM SUBMISSIONS =====
        document.getElementById('witnessForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!supabase) {
                alert('Database connection not available. Please try again later.');
                return;
            }

            const form = e.target;
            const errorDiv = document.getElementById('witnessError');
            form.classList.add('loading');

            try {
                const incidentId = sessionStorage.getItem('incident_id');

                const witnessData = {
                    incident_id: incidentId,
                    create_user_id: userId,
                    witness_name: form.witnessName.value,
                    witness_address: form.witnessAddress.value,
                    witness_mobile: form.witnessMobile.value,
                    witness_email: form.witnessEmail.value || null,
                    witness_statement: form.witnessStatement.value,
                    created_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('witness_reports')
                    .insert([witnessData]);

                if (error) throw error;

                closeModal('witnessModal');
                alert('✅ Witness information saved successfully!');

            } catch (error) {
                console.error('Error saving witness:', error);
                errorDiv.textContent = 'Failed to save witness information. Please try again.';
                errorDiv.classList.add('show');
            } finally {
                form.classList.remove('loading');
            }
        });

        document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!supabase) {
                alert('Database connection not available. Please try again later.');
                return;
            }

            const form = e.target;
            const errorDiv = document.getElementById('vehicleError');
            form.classList.add('loading');

            try {
                const incidentId = sessionStorage.getItem('incident_id');

                const vehicleData = {
                    incident_report_id: incidentId ? parseInt(incidentId) : null,
                    create_user_id: userId,
                    additional_driver_name: form.driverName.value,
                    additional_driver_address: form.driverAddress.value,
                    additional_driver_mobile: form.driverMobile.value,
                    additional_driver_email: form.driverEmail.value || null,
                    additional_registration_number: form.vehicleReg.value,
                    additional_make_of_vehicle: form.vehicleMake.value,
                    additional_model_of_vehicle: form.vehicleModel.value,
                    additional_vehicle_colour: form.vehicleColor.value || null,
                    additional_insurance_company: form.insuranceCompany.value || null,
                    additional_policy_number: form.insurancePolicy.value || null,
                    submit_date: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('additional_vehicles')
                    .insert([vehicleData]);

                if (error) throw error;

                closeModal('vehicleModal');
                alert('✅ Vehicle information saved successfully!');

            } catch (error) {
                console.error('Error saving vehicle:', error);
                errorDiv.textContent = 'Failed to save vehicle information. Please try again.';
                errorDiv.classList.add('show');
            } finally {
                form.classList.remove('loading');
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Initializing report-complete page');

            await initSupabase();
            const fromTypeform = extractTypeformParams();
            checkIncidentSubmission();

            // Load emergency contacts and update button handlers
            await loadUserData();

            console.log('📋 Page Context:', {
                userId,
                userEmail,
                fromTypeform,
                url: window.location.href
            });

            console.log('✅ Page initialization complete');
        });

        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    <script src="/js/mascot.js"></script></body>
</html>