<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Test Page</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f3f4f6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #1f2937;
      margin-bottom: 10px;
    }

    .status {
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-family: monospace;
    }

    .status.loading {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      color: #92400e;
    }

    .status.success {
      background: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }

    .status.error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .image-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .image-container {
      width: 100%;
      height: 200px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .image-container.error {
      background: #fee2e2;
      color: #991b1b;
      font-size: 14px;
      padding: 20px;
      text-align: center;
    }

    .image-info {
      padding: 15px;
      border-top: 1px solid #e5e7eb;
    }

    .image-info h3 {
      font-size: 14px;
      color: #1f2937;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .image-info p {
      font-size: 12px;
      color: #6b7280;
      margin: 3px 0;
    }

    .debug-info {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 5px;
    }

    .debug-info h2 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .debug-info pre {
      font-size: 11px;
      overflow-x: auto;
      background: white;
      padding: 10px;
      border-radius: 3px;
      border: 1px solid #e5e7eb;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üñºÔ∏è Image Display Test</h1>
    <div id="status" class="status loading">Loading images...</div>

    <div id="imagesGrid" class="images-grid">
      <!-- Images will be inserted here -->
    </div>

    <div class="debug-info">
      <h2>Debug Information</h2>
      <pre id="debugInfo">Waiting for data...</pre>
    </div>
  </div>

  <script>
    const USER_ID = '199d9251-b2e0-40a5-80bf-fc1529d9bf6c';
    const API_URL = `http://localhost:5001/api/user-documents?user_id=${USER_ID}`;

    async function loadImages() {
      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('imagesGrid');
      const debugEl = document.getElementById('debugInfo');

      try {
        console.log('Fetching images from:', API_URL);
        statusEl.textContent = 'Fetching images from API...';

        const response = await fetch(API_URL);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(`API returned ${response.status}: ${data.error || 'Unknown error'}`);
        }

        const documents = data.data?.documents || [];
        const images = documents.filter(doc =>
          !doc.document_type?.toLowerCase().includes('video') &&
          !doc.document_type?.toLowerCase().includes('dashcam')
        );

        console.log('API Response:', data);
        console.log('Found images:', images.length);

        // Update debug info
        debugEl.textContent = JSON.stringify({
          api_url: API_URL,
          total_documents: documents.length,
          images_found: images.length,
          first_image: images[0] ? {
            type: images[0].document_type,
            status: images[0].status,
            has_public_url: !!images[0].public_url,
            has_signed_url: !!images[0].signed_url,
            storage_path: images[0].storage_path
          } : null
        }, null, 2);

        if (images.length === 0) {
          statusEl.className = 'status error';
          statusEl.textContent = 'No images found for this user';
          gridEl.innerHTML = '<p style="color: #6b7280;">No images to display</p>';
          return;
        }

        statusEl.className = 'status success';
        statusEl.textContent = `Found ${images.length} images. Loading...`;

        // Clear grid
        gridEl.innerHTML = '';

        // Display each image
        images.forEach((image, index) => {
          const imageUrl = image.signed_url || image.public_url;

          const card = document.createElement('div');
          card.className = 'image-card';

          const container = document.createElement('div');
          container.className = 'image-container';
          container.innerHTML = '<div class="loading-spinner"></div>';

          const info = document.createElement('div');
          info.className = 'image-info';
          info.innerHTML = `
            <h3>${formatDocumentType(image.document_type)}</h3>
            <p>Status: ${image.status}</p>
            <p>Size: ${formatFileSize(image.file_size)}</p>
            <p>Created: ${formatDate(image.created_at)}</p>
          `;

          card.appendChild(container);
          card.appendChild(info);
          gridEl.appendChild(card);

          if (imageUrl) {
            const img = new Image();
            img.onload = () => {
              console.log(`‚úÖ Image ${index + 1} loaded successfully`);
              container.innerHTML = '';
              container.appendChild(img);
            };
            img.onerror = (e) => {
              console.error(`‚ùå Image ${index + 1} failed to load:`, e);
              container.className = 'image-container error';
              container.innerHTML = `
                <div>
                  <div>‚ùå Failed to load image</div>
                  <div style="font-size: 10px; margin-top: 5px;">
                    ${image.document_type}
                  </div>
                </div>
              `;
            };
            img.src = imageUrl;
            img.alt = image.document_type;
          } else {
            container.className = 'image-container error';
            container.innerHTML = '<div>‚ö†Ô∏è No URL available</div>';
          }
        });

        statusEl.className = 'status success';
        statusEl.textContent = `‚úÖ Displaying ${images.length} images`;

      } catch (error) {
        console.error('Error loading images:', error);
        statusEl.className = 'status error';
        statusEl.textContent = `Error: ${error.message}`;
        debugEl.textContent = JSON.stringify({
          error: error.message,
          stack: error.stack
        }, null, 2);
      }
    }

    function formatDocumentType(type) {
      if (!type) return 'Unknown';
      return type
        .replace(/_/g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function formatFileSize(bytes) {
      if (!bytes) return 'Unknown';
      const kb = bytes / 1024;
      const mb = kb / 1024;
      if (mb > 1) return `${mb.toFixed(2)} MB`;
      return `${kb.toFixed(0)} KB`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    // Load images on page load
    document.addEventListener('DOMContentLoaded', loadImages);
  </script>
</body>
</html>