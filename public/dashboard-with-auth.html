<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Image Test with Supabase Auth</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #1f2937;
      margin-bottom: 20px;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-family: monospace;
    }

    .status.loading { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
    .status.success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
    .status.error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }

    .auth-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .auth-section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #1f2937;
    }

    .auth-info {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .auth-info div {
      padding: 10px;
      background: #f9fafb;
      border-radius: 5px;
      font-size: 14px;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .image-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .image-container {
      width: 100%;
      height: 200px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .image-info {
      padding: 15px;
      border-top: 1px solid #e5e7eb;
    }

    .image-info h3 {
      font-size: 14px;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .image-info p {
      font-size: 12px;
      color: #6b7280;
      margin: 5px 0;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .debug-info {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 5px;
    }

    .debug-info pre {
      font-size: 11px;
      overflow-x: auto;
      background: white;
      padding: 10px;
      border-radius: 3px;
      margin-top: 10px;
    }
  </style>
  <!-- Supabase Client SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <h1>üñºÔ∏è Dashboard Images with Supabase Auth</h1>
    <div id="status" class="status loading">Initializing Supabase client...</div>

    <div class="auth-section">
      <h2>Authentication Method</h2>
      <div class="auth-info">
        <div>
          <strong>Method 1:</strong> Using ANON key for public bucket access
          <button class="btn btn-primary" onclick="testAnonAccess()">Test Anon Access</button>
        </div>
        <div>
          <strong>Method 2:</strong> Using Service Role key (backend only)
          <button class="btn btn-secondary" onclick="testServiceAccess()">Test via API</button>
        </div>
        <div>
          <strong>Method 3:</strong> Direct public URL access (no auth)
          <button class="btn btn-primary" onclick="testDirectAccess()">Test Direct URLs</button>
        </div>
      </div>
    </div>

    <div id="imagesGrid" class="images-grid">
      <!-- Images will be inserted here -->
    </div>

    <div class="debug-info">
      <h2>Debug Information</h2>
      <pre id="debugInfo">Waiting for data...</pre>
    </div>
  </div>

  <script>
    const USER_ID = '199d9251-b2e0-40a5-80bf-fc1529d9bf6c';

    // Get these from your environment - for testing only!
    // In production, use proper authentication
    const SUPABASE_URL = 'https://kctlcmbjmhcfoobmkfrs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjdGxjbWJqbWhjZm9vYm1rZnJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTcwNDQzODYsImV4cCI6MjAxMjYyMDM4Nn0.Pz2kGSaFnaHLPa8OZmQkzr_W-c1EJRksO6_UqGaHvj0';

    let supabase;
    let allImages = [];

    // Initialize Supabase client
    async function initSupabase() {
      const statusEl = document.getElementById('status');
      const debugEl = document.getElementById('debugInfo');

      try {
        statusEl.textContent = 'Initializing Supabase client...';

        // Initialize Supabase client with ANON key
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        statusEl.className = 'status success';
        statusEl.textContent = '‚úÖ Supabase client initialized';

        debugEl.textContent = JSON.stringify({
          supabase_url: SUPABASE_URL,
          client_initialized: true,
          user_id: USER_ID
        }, null, 2);

      } catch (error) {
        statusEl.className = 'status error';
        statusEl.textContent = `‚ùå Failed to initialize: ${error.message}`;
        debugEl.textContent = error.stack;
      }
    }

    // Test Method 1: Direct Supabase storage access with ANON key
    async function testAnonAccess() {
      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('imagesGrid');
      const debugEl = document.getElementById('debugInfo');

      try {
        statusEl.className = 'status loading';
        statusEl.textContent = 'Testing ANON key access to storage...';

        // List files in the user's folder
        const { data: files, error: listError } = await supabase.storage
          .from('user-documents')
          .list(USER_ID, {
            limit: 100,
            offset: 0
          });

        if (listError) {
          throw new Error(`List error: ${listError.message}`);
        }

        console.log('Files found:', files);

        // Filter for image files
        const imageFiles = files?.filter(file =>
          file.name.includes('.jpeg') ||
          file.name.includes('.jpg') ||
          file.name.includes('.png')
        ) || [];

        statusEl.className = 'status success';
        statusEl.textContent = `‚úÖ Found ${imageFiles.length} images via ANON access`;

        // Clear grid
        gridEl.innerHTML = '';

        // Display each image
        for (const file of imageFiles) {
          const filePath = `${USER_ID}/${file.name}`;

          // Get public URL (doesn't require auth if bucket is public)
          const { data: urlData } = supabase.storage
            .from('user-documents')
            .getPublicUrl(filePath);

          // Also try to get a signed URL for comparison
          const { data: signedData, error: signedError } = await supabase.storage
            .from('user-documents')
            .createSignedUrl(filePath, 3600); // 1 hour

          const card = createImageCard(
            file.name,
            urlData?.publicUrl,
            signedData?.signedUrl,
            file
          );
          gridEl.appendChild(card);
        }

        debugEl.textContent = JSON.stringify({
          method: 'ANON key access',
          files_found: imageFiles.length,
          sample_file: imageFiles[0] || null
        }, null, 2);

      } catch (error) {
        statusEl.className = 'status error';
        statusEl.textContent = `‚ùå ANON access failed: ${error.message}`;
        debugEl.textContent = JSON.stringify({
          error: error.message,
          stack: error.stack
        }, null, 2);
      }
    }

    // Test Method 2: Access via backend API
    async function testServiceAccess() {
      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('imagesGrid');
      const debugEl = document.getElementById('debugInfo');

      try {
        statusEl.className = 'status loading';
        statusEl.textContent = 'Fetching images from backend API...';

        const response = await fetch(`http://localhost:5001/api/user-documents?user_id=${USER_ID}&document_type=image`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(`API error: ${data.error || 'Unknown'}`);
        }

        const images = data.data?.documents || [];

        statusEl.className = 'status success';
        statusEl.textContent = `‚úÖ Found ${images.length} images via API`;

        // Clear grid
        gridEl.innerHTML = '';

        // Display each image
        for (const image of images) {
          const card = createImageCard(
            image.document_type,
            image.public_url,
            image.signed_url,
            image
          );
          gridEl.appendChild(card);
        }

        debugEl.textContent = JSON.stringify({
          method: 'Backend API',
          images_found: images.length,
          sample_image: images[0] ? {
            type: images[0].document_type,
            has_public_url: !!images[0].public_url,
            has_signed_url: !!images[0].signed_url
          } : null
        }, null, 2);

      } catch (error) {
        statusEl.className = 'status error';
        statusEl.textContent = `‚ùå API access failed: ${error.message}`;
        debugEl.textContent = JSON.stringify({
          error: error.message
        }, null, 2);
      }
    }

    // Test Method 3: Direct URL access
    async function testDirectAccess() {
      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('imagesGrid');

      statusEl.className = 'status loading';
      statusEl.textContent = 'Testing direct URL access...';

      // First get the URLs from the API
      const response = await fetch(`http://localhost:5001/api/user-documents?user_id=${USER_ID}&document_type=image`);
      const data = await response.json();
      const images = data.data?.documents || [];

      gridEl.innerHTML = '';

      for (const image of images) {
        const url = image.public_url || image.signed_url;
        if (url) {
          // Create a simple image element
          const card = document.createElement('div');
          card.className = 'image-card';
          card.innerHTML = `
            <div class="image-container">
              <img
                src="${url}"
                alt="${image.document_type}"
                onload="this.parentElement.style.background='#10b981'"
                onerror="handleImageError(this, '${image.document_type}')"
                crossorigin="anonymous"
              >
            </div>
            <div class="image-info">
              <h3>${formatDocumentType(image.document_type)}</h3>
              <p>Status: <span id="status-${image.id}">Loading...</span></p>
            </div>
          `;
          gridEl.appendChild(card);
        }
      }

      statusEl.className = 'status success';
      statusEl.textContent = `‚úÖ Testing ${images.length} direct URLs`;
    }

    // Create image card element
    function createImageCard(name, publicUrl, signedUrl, metadata) {
      const card = document.createElement('div');
      card.className = 'image-card';

      const container = document.createElement('div');
      container.className = 'image-container';
      container.innerHTML = '<div class="loading-spinner"></div>';

      const info = document.createElement('div');
      info.className = 'image-info';
      info.innerHTML = `
        <h3>${formatDocumentType(name)}</h3>
        <p>Public URL: ${publicUrl ? '‚úÖ Available' : '‚ùå Not available'}</p>
        <p>Signed URL: ${signedUrl ? '‚úÖ Available' : '‚ùå Not available'}</p>
        <p>Testing: <span id="test-${name}">...</span></p>
      `;

      card.appendChild(container);
      card.appendChild(info);

      // Try to load the image
      if (signedUrl || publicUrl) {
        const img = new Image();
        img.onload = () => {
          container.innerHTML = '';
          container.appendChild(img);
          document.getElementById(`test-${name}`).textContent = '‚úÖ Loaded';
        };
        img.onerror = () => {
          container.innerHTML = '<div>‚ùå Failed to load</div>';
          document.getElementById(`test-${name}`).textContent = '‚ùå Error';
        };
        img.src = signedUrl || publicUrl;
        img.alt = name;
      } else {
        container.innerHTML = '<div>‚ö†Ô∏è No URL available</div>';
      }

      return card;
    }

    function handleImageError(img, type) {
      img.parentElement.style.background = '#fee2e2';
      img.parentElement.innerHTML = `
        <div style="color: #991b1b; text-align: center; padding: 20px;">
          ‚ùå Failed to load<br>
          <small>${type}</small><br>
          <small style="font-size: 10px;">CORS or auth issue</small>
        </div>
      `;
    }

    function formatDocumentType(type) {
      if (!type) return 'Unknown';
      return type
        .replace(/_/g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase())
        .replace('.jpeg', '')
        .replace('.jpg', '')
        .replace(/^\d+/, ''); // Remove timestamp prefix
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      initSupabase();
    });
  </script>
</body>
</html>