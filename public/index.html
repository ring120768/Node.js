<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Crash Lawyer AI - Legal Support at the Scene</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0B7AB0 0%, #1EA1D4 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            padding-top: 40px;
            position: relative;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 20px;
            animation: fadeInDown 0.8s ease;
        }

        .logo-section img {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
            
        }

        .logo-section h1 {
            color: white;
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .logo-section p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            margin-bottom: 20px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 450px;
            animation: fadeInUp 1s ease;
            margin-top: 20px;
        }

        /* 3D EMERGENCY BUTTON - Apple Style */
        .emergency-btn {
            position: relative;
            padding: 24px 40px;
            background: linear-gradient(180deg, #ff3b30 0%, #d32f2f 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 
                0 8px 16px rgba(255, 59, 48, 0.4),
                0 4px 8px rgba(0, 0, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.3),
                inset 0 -2px 0 rgba(0, 0, 0, 0.3);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: translateY(0);
        }

        .emergency-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
            border-radius: 16px 16px 0 0;
        }

        .emergency-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 12px 24px rgba(255, 59, 48, 0.5),
                0 6px 12px rgba(0, 0, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.4),
                inset 0 -2px 0 rgba(0, 0, 0, 0.3);
        }

        .emergency-btn:active {
            transform: translateY(2px);
            box-shadow: 
                0 4px 8px rgba(255, 59, 48, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .emergency-btn .btn-icon {
            font-size: 28px;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Secondary Buttons */
        .secondary-btn {
            padding: 16px 32px;
            background: white;
            color: #0B7AB0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .secondary-btn:hover {
            background: #0B7AB0;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(11, 122, 176, 0.4);
        }

        .secondary-btn .btn-icon {
            margin-right: 8px;
            font-size: 20px;
        }

        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
        }

        .divider span {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Auth Buttons Container */
        .auth-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .auth-btn {
            padding: 14px 20px;
            border: 2px solid white;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .auth-btn.login {
            background: transparent;
            color: white;
        }

        .auth-btn.login:hover {
            background: white;
            color: #0B7AB0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 255, 255, 0.3);
        }

        .auth-btn.signup {
            background: white;
            color: #0B7AB0;
        }

        .auth-btn.signup:hover {
            background: #0B7AB0;
            color: white;
            border-color: #0B7AB0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(11, 122, 176, 0.4);
        }

        /* Emergency Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emergency-modal {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
            position: relative;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            color: #ff3b30;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: #666;
            font-size: 14px;
        }

        .location-section {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .location-section h3 {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .what3words-box {
            background: #0B7AB0;
            color: white;
            padding: 16px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 12px;
            font-family: monospace;
            position: relative;
        }

        .what3words-box::before {
            content: '///';
            position: absolute;
            left: 16px;
            color: rgba(255, 255, 255, 0.7);
        }

        .address-box {
            background: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .copy-btn {
            width: 100%;
            padding: 12px;
            background: #f5f5f5;
            color: #0B7AB0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: #e0e0e0;
        }

        .copy-btn.copied {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .call-999-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(180deg, #ff3b30 0%, #d32f2f 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
            transition: all 0.2s ease;
        }

        .call-999-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 59, 48, 0.5);
        }

        .cancel-btn {
            width: 100%;
            padding: 14px;
            background: transparent;
            color: #666;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cancel-btn:hover {
            background: #f5f5f5;
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: #0B7AB0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0B7AB0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 480px) {
            body {
                padding-top: 60px;
            }

            .logo-section h1 {
                font-size: 32px;
            }

            .emergency-btn {
                font-size: 20px;
                padding: 20px 32px;
            }

            .secondary-btn {
                font-size: 16px;
                padding: 14px 28px;
            }

            .emergency-modal {
                padding: 24px;
            }

            .auth-buttons {
                grid-template-columns: 1fr;
            }
        }
    .logo-section img, .site-branding{width:450px;max-width:100%;height:auto;margin-bottom:20px;}@media(max-width:520px){.logo-section img, .site-branding{width:320px;}}@media(max-width:380px){.logo-section img, .site-branding{width:260px;}}</style>
    <link rel="stylesheet" href="/css/mascot.css"></head>
<body>
    <!-- EMERGENCY BUTTON - TOP PRIORITY -->
    <button class="emergency-btn" id="emergencyBtn" style="margin-bottom: 30px; max-width: 450px; width: 100%;">
        <span class="btn-icon">🚨</span>
        Get Help Now - Call 999
    </button>

    <div class="logo-section">
        <img src="/images/car-crash-lawyer-ai-450.webp" alt="Car Crash Lawyer AI logo" class="site-branding" width="450" height="450" style="display:block;margin:0 auto 20px;max-width:100%;height:auto;image-rendering:crisp-edges;image-rendering:-webkit-optimize-contrast;">
        <h1>Car Crash Lawyer AI</h1>
        <p>Legal support at the scene – fast, smart, AI-powered.</p>
        <p style="font-size: 16px; margin-top: 10px;">Get help. Record evidence. Protect your rights.</p>
    </div>

    <div class="button-container">
        <!-- REPORT INCIDENT BUTTON -->
        <button class="secondary-btn" onclick="navigateToIncident()">
            <span class="btn-icon">📝</span>
            Report an Incident
        </button>

        <!-- DASHBOARD BUTTON -->
        <button class="secondary-btn" onclick="navigateToDashboard()">
            <span class="btn-icon">📋</span>
            View My Reports
        </button>

        <!-- DEMO BUTTON -->
        <button class="secondary-btn" onclick="window.location.href='/demo.html'">
            <span class="btn-icon">🎬</span>
            Try Demo
        </button>

        <!-- DIVIDER -->
        <div class="divider">
            <span>Account</span>
        </div>

        <!-- AUTH BUTTONS -->
        <div class="auth-buttons">
            <button class="auth-btn login" onclick="window.location.href='/login.html'">
                🔑 Login
            </button>
            <button class="auth-btn signup" onclick="window.location.href='/signup-form.html'">
                ✨ Sign Up
            </button>
        </div>
    </div>

    <!-- EMERGENCY MODAL -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="emergency-modal">
            <div class="modal-header">
                <h2>🚨 Emergency Assistance</h2>
                <p>Your location is ready to share with emergency services</p>
            </div>

            <div id="modalContent">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Getting your location...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get references to elements
        const emergencyBtn = document.getElementById('emergencyBtn');
        const emergencyModal = document.getElementById('emergencyModal');
        const modalContent = document.getElementById('modalContent');

        let currentLocation = null;
        let what3wordsAddress = null;

        // Emergency button click handler
        emergencyBtn.addEventListener('click', async function() {
            emergencyModal.classList.add('show');
            await getLocationAndWhat3Words();
        });

        // Get location and convert to what3words
        async function getLocationAndWhat3Words() {
            try {
                // Request geolocation
                if (!navigator.geolocation) {
                    showError('Geolocation is not supported by your browser');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Get what3words address
                        await convertToWhat3Words(currentLocation.lat, currentLocation.lng);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        showError('Unable to get your location. Please enable location services.');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } catch (error) {
                console.error('Location error:', error);
                showError('Failed to get location. Please try again.');
            }
        }

        // Convert coordinates to what3words
        async function convertToWhat3Words(lat, lng) {
            try {
                const response = await fetch(`/api/location/convert?lat=${lat}&lng=${lng}`);
                const data = await response.json();

                if (response.ok && data.words) {
                    what3wordsAddress = data.words;
                    displayLocationInfo(data);
                } else {
                    showError('Unable to get what3words address');
                }
            } catch (error) {
                console.error('what3words error:', error);
                showError('Failed to convert location to what3words address');
            }
        }

        // Display location information
        function displayLocationInfo(data) {
            const regularAddress = data.nearestPlace || 'Address lookup in progress...';

            modalContent.innerHTML = `
                <div class="location-section">
                    <h3>📍 Your Location</h3>

                    <div class="what3words-box">
                        ${data.words}
                    </div>

                    <div class="address-box">
                        📮 ${regularAddress}<br>
                        🗺️ ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}
                    </div>

                    <button class="copy-btn" data-action="copy">
                        📋 Copy Location to Clipboard
                    </button>
                </div>

                <button class="call-999-btn" data-action="call999">
                    📞 Call 999 Now
                </button>

                <button class="cancel-btn" data-action="cancel">
                    Cancel
                </button>
            `;
        }

        // Show error in modal
        function showError(message) {
            modalContent.innerHTML = `
                <div class="error-message">
                    ⚠️ ${message}
                </div>
                <button class="call-999-btn" data-action="call999">
                    📞 Call 999 Anyway
                </button>
                <button class="cancel-btn" data-action="cancel">
                    Cancel
                </button>
            `;
        }

        // Copy location to clipboard
        function copyLocation() {
            const locationText = what3wordsAddress 
                ? `Location: ///${what3wordsAddress}\nCoordinates: ${currentLocation.lat}, ${currentLocation.lng}`
                : `Location: ${currentLocation.lat}, ${currentLocation.lng}`;

            navigator.clipboard.writeText(locationText).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = '✓ Copied to Clipboard!';
                btn.classList.add('copied');

                setTimeout(() => {
                    btn.textContent = '📋 Copy Location to Clipboard';
                    btn.classList.remove('copied');
                }, 3000);
            });
        }

        // Call 999 emergency
        function call999() {
            // For mobile devices, this will trigger the phone dialer
            window.location.href = 'tel:999';
        }

        // Close modal
        function closeModal() {
            emergencyModal.classList.remove('show');
        }

        // Close modal when clicking outside
        emergencyModal.addEventListener('click', function(e) {
            if (e.target === emergencyModal) {
                closeModal();
            }
        });

        // Event delegation for modal buttons (handles dynamically added buttons)
        emergencyModal.addEventListener('click', function(e) {
            const button = e.target.closest('[data-action]');
            if (!button) return;

            const action = button.getAttribute('data-action');

            switch(action) {
                case 'call999':
                    call999();
                    break;
                case 'cancel':
                    closeModal();
                    break;
                case 'copy':
                    copyLocation();
                    break;
            }
        });

        // Navigate to incident report
        async function navigateToIncident() {
            console.log('📝 Incident button clicked');
            try {
                const response = await fetch('/api/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();

                console.log('🔍 Auth status check:', data);

                if (data.authenticated) {
                    console.log('✅ User authenticated, going to incident.html');
                    window.location.href = '/incident.html';
                } else {
                    console.log('❌ User not authenticated, redirecting to login with redirect=incident.html');
                    window.location.href = '/login.html?redirect=incident.html';
                }
            } catch (error) {
                console.error('❌ Auth check failed:', error);
                console.log('Redirecting to login with redirect=incident.html (fallback)');
                window.location.href = '/login.html?redirect=incident.html';
            }
        }

        // Navigate to dashboard
        async function navigateToDashboard() {
            console.log('📋 Dashboard button clicked');
            try {
                const response = await fetch('/api/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();

                console.log('🔍 Auth status check:', data);

                if (data.authenticated) {
                    console.log('✅ User authenticated, going to dashboard.html');
                    window.location.href = '/dashboard.html';
                } else {
                    console.log('❌ User not authenticated, redirecting to login with redirect=dashboard.html');
                    window.location.href = '/login.html?redirect=dashboard.html';
                }
            } catch (error) {
                console.error('❌ Auth check failed:', error);
                console.log('Redirecting to login with redirect=dashboard.html (fallback)');
                window.location.href = '/login.html?redirect=dashboard.html';
            }
        }

        // Add event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚗 Car Crash Lawyer AI - Landing Page Initialized');
            
            // Main navigation buttons
            const incidentBtn = document.querySelector('.secondary-btn[onclick="navigateToIncident()"]');
            const dashboardBtn = document.querySelector('.secondary-btn[onclick="navigateToDashboard()"]');
            const demoBtn = document.querySelector('.secondary-btn[onclick*="demo.html"]');
            const loginBtn = document.querySelector('.auth-btn.login');
            const signupBtn = document.querySelector('.auth-btn.signup');

            if (incidentBtn) {
                incidentBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    navigateToIncident();
                });
                console.log('✅ Incident button event listener added');
            }

            if (dashboardBtn) {
                dashboardBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    navigateToDashboard();
                });
                console.log('✅ Dashboard button event listener added');
            }

            if (demoBtn) {
                demoBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🎬 Demo button clicked');
                    window.location.href = '/demo.html';
                });
                console.log('✅ Demo button event listener added');
            }

            if (loginBtn) {
                loginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🔑 Login button clicked');
                    window.location.href = '/login.html';
                });
                console.log('✅ Login button event listener added');
            }

            if (signupBtn) {
                signupBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('✨ Signup button clicked');
                    window.location.href = '/signup-form.html';
                });
                console.log('✅ Signup button event listener added');
            }

            console.log('✅ Page fully loaded');
            
            // Debug: Check if buttons are clickable
            setTimeout(() => {
                console.log('🔍 Checking if buttons are clickable...');
                const allButtons = document.querySelectorAll('button, .auth-btn, .secondary-btn');
                console.log(`✅ Found ${allButtons.length} total buttons`);
                
                allButtons.forEach((btn, index) => {
                    const text = btn.textContent.trim();
                    const hasClick = btn.onclick || btn.getAttribute('onclick') || btn.hasAttribute('onclick');
                    console.log(`[${index}] "${text}" - Has click handler: ${!!hasClick}`);
                });
                
                console.log('✅ All buttons found and ready');
            }, 100);

            // Fallback click handlers (in case inline onclick doesn't work)
            document.body.addEventListener('click', function(e) {
                const target = e.target;
                const text = target.textContent.trim();
                
                if (target.matches('.secondary-btn')) {
                    if (text.includes('Report an Incident')) {
                        e.preventDefault();
                        navigateToIncident();
                    } else if (text.includes('View My Reports')) {
                        e.preventDefault();
                        navigateToDashboard();
                    } else if (text.includes('Try Demo')) {
                        e.preventDefault();
                        window.location.href = '/demo.html';
                    }
                } else if (target.matches('.auth-btn.login')) {
                    e.preventDefault();
                    window.location.href = '/login.html';
                } else if (target.matches('.auth-btn.signup')) {
                    e.preventDefault();
                    window.location.href = '/signup-form.html';
                }
            });
            
            console.log('✅ Fallback event listeners added');
        });

        // ==================== CORS ERROR DETECTION ====================

        /**
         * Global fetch interceptor for CORS debugging and user-friendly error handling
         * Wraps native fetch to detect and handle CORS errors gracefully
         */
        (function() {
            const originalFetch = window.fetch;

            window.fetch = function(...args) {
                const url = typeof args[0] === 'string' ? args[0] : args[0].url;

                return originalFetch.apply(this, args)
                    .then(response => {
                        // Log successful CORS responses in development
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.debug('[CORS] Success:', url, response.status);
                        }
                        return response;
                    })
                    .catch(error => {
                        // Detect CORS-related errors
                        const isCorsError =
                            error.message.toLowerCase().includes('cors') ||
                            error.message.toLowerCase().includes('cross-origin') ||
                            (error.name === 'TypeError' && error.message.includes('fetch'));

                        if (isCorsError) {
                            console.error('[CORS ERROR] Request blocked:', {
                                url: url,
                                origin: window.location.origin,
                                error: error.message,
                                timestamp: new Date().toISOString()
                            });

                            // Show user-friendly error (only in development)
                            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                                console.warn(
                                    '%c⚠️ CORS ERROR DETECTED',
                                    'color: red; font-size: 16px; font-weight: bold',
                                    '\nURL:', url,
                                    '\nOrigin:', window.location.origin,
                                    '\nCheck console for details or contact support.'
                                );
                            } else {
                                // Production: Silent logging, generic error
                                console.error('Connection error. Please try again or contact support.');
                            }
                        }

                        // Re-throw the error for original error handlers
                        throw error;
                    });
            };

            console.info('[CORS Monitor] Initialized - Fetch requests will be monitored for CORS issues');
        })();
    </script>
    <script src="/js/mascot.js"></script></body>
</html>