<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Image Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #0b7ab0;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .test-title {
            font-weight: bold;
            color: #0b7ab0;
            margin-bottom: 10px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .image-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .image-card img {
            max-width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 3px;
        }
        .image-type {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .url-display {
            word-break: break-all;
            font-size: 10px;
            color: #999;
            margin-top: 5px;
            max-height: 60px;
            overflow-y: auto;
        }
        .log-entry {
            font-size: 12px;
            padding: 3px 0;
            border-bottom: 1px dotted #ddd;
        }
        .log-entry.error {
            color: red;
        }
        .log-entry.success {
            color: green;
        }
        #console-log {
            background: #1e1e1e;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Direct Image Display Test</h1>

        <div class="test-section">
            <div class="test-title">Test Configuration</div>
            <div>User ID: <code>199d9251-b2e0-40a5-80bf-fc1529d9bf6c</code></div>
            <div>API Endpoint: <code>/api/user-documents</code></div>
            <div>Document Type Filter: <code>image</code></div>
        </div>

        <div class="test-section">
            <div class="test-title">Console Output</div>
            <div id="console-log"></div>
        </div>

        <div class="test-section">
            <div class="test-title">Test Results</div>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">Images Found</div>
            <div id="image-grid" class="image-grid"></div>
        </div>
    </div>

    <script>
        const userId = '199d9251-b2e0-40a5-80bf-fc1529d9bf6c';
        const consoleLog = document.getElementById('console-log');
        const testResults = document.getElementById('test-results');
        const imageGrid = document.getElementById('image-grid');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' :
                         type === 'success' ? '#51cf66' :
                         type === 'warning' ? '#ffd43b' : '#74c0fc';

            consoleLog.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
            console.log(message);
        }

        async function runTests() {
            log('Starting Direct Image Test...', 'info');

            // Step 1: Fetch from API
            log('Fetching from API...', 'info');

            try {
                const apiUrl = `/api/user-documents?user_id=${userId}&document_type=image`;
                log(`API URL: ${apiUrl}`, 'info');

                const response = await fetch(apiUrl);
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const data = await response.json();
                log(`Raw response received`, 'success');

                // Parse the response structure
                const images = data.data?.documents || data.documents || [];
                log(`Found ${images.length} images`, images.length > 0 ? 'success' : 'warning');

                if (images.length === 0) {
                    testResults.innerHTML = '<div class="status error">No images found in API response</div>';
                    return;
                }

                // Step 2: Analyze each image
                let successCount = 0;
                let failCount = 0;

                for (const [index, image] of images.entries()) {
                    log(`\n--- Image ${index + 1} ---`, 'info');
                    log(`Type: ${image.document_type}`, 'info');
                    log(`Has public_url: ${!!image.public_url}`, image.public_url ? 'success' : 'error');
                    log(`Has signed_url: ${!!image.signed_url}`, image.signed_url ? 'success' : 'error');

                    const imageCard = document.createElement('div');
                    imageCard.className = 'image-card';

                    const url = image.public_url || image.signed_url;

                    if (url) {
                        log(`Testing URL accessibility...`, 'info');

                        // Create image element
                        const img = document.createElement('img');
                        img.src = url;

                        // Set up load/error handlers
                        await new Promise((resolve) => {
                            img.onload = () => {
                                log(`‚úÖ Image ${index + 1} loaded successfully`, 'success');
                                successCount++;
                                imageCard.innerHTML = `
                                    <img src="${url}" alt="${image.document_type}">
                                    <div class="image-type">${image.document_type}</div>
                                    <div class="status success">‚úÖ Loaded</div>
                                    <div class="url-display">${url.substring(0, 100)}...</div>
                                `;
                                resolve();
                            };

                            img.onerror = () => {
                                log(`‚ùå Image ${index + 1} failed to load`, 'error');
                                failCount++;
                                imageCard.innerHTML = `
                                    <div style="height: 150px; background: #f8d7da; display: flex; align-items: center; justify-content: center;">
                                        ‚ùå Failed to Load
                                    </div>
                                    <div class="image-type">${image.document_type}</div>
                                    <div class="status error">‚ùå Error</div>
                                    <div class="url-display">${url.substring(0, 100)}...</div>
                                `;
                                resolve();
                            };

                            // Timeout after 10 seconds
                            setTimeout(() => {
                                if (!img.complete) {
                                    log(`‚è±Ô∏è Image ${index + 1} timed out`, 'warning');
                                    failCount++;
                                    imageCard.innerHTML = `
                                        <div style="height: 150px; background: #fff3cd; display: flex; align-items: center; justify-content: center;">
                                            ‚è±Ô∏è Timeout
                                        </div>
                                        <div class="image-type">${image.document_type}</div>
                                        <div class="status warning">‚è±Ô∏è Timeout</div>
                                    `;
                                    resolve();
                                }
                            }, 10000);
                        });
                    } else {
                        log(`‚ùå No URL available for image ${index + 1}`, 'error');
                        failCount++;
                        imageCard.innerHTML = `
                            <div style="height: 150px; background: #f8d7da; display: flex; align-items: center; justify-content: center;">
                                ‚ùå No URL
                            </div>
                            <div class="image-type">${image.document_type}</div>
                            <div class="status error">‚ùå No URL</div>
                        `;
                    }

                    imageGrid.appendChild(imageCard);
                }

                // Step 3: Summary
                log(`\n========== TEST SUMMARY ==========`, 'info');
                log(`Total Images: ${images.length}`, 'info');
                log(`Successful: ${successCount}`, successCount > 0 ? 'success' : 'error');
                log(`Failed: ${failCount}`, failCount > 0 ? 'error' : 'success');

                testResults.innerHTML = `
                    <div class="status ${successCount === images.length ? 'success' : failCount > 0 ? 'error' : 'warning'}">
                        Test Complete: ${successCount}/${images.length} images loaded successfully
                    </div>
                    ${failCount > 0 ? `<div class="status error">‚ö†Ô∏è ${failCount} images failed to load</div>` : ''}
                    ${successCount === images.length ? `<div class="status success">‚úÖ All images are working!</div>` : ''}
                `;

                // Test the proxy endpoint as well
                log(`\n--- Testing Proxy Endpoint ---`, 'info');
                if (images.length > 0 && images[0].id) {
                    try {
                        const proxyUrl = `/api/images/${images[0].id}`;
                        log(`Proxy URL: ${proxyUrl}`, 'info');

                        const proxyResponse = await fetch(proxyUrl);
                        if (proxyResponse.ok) {
                            log(`‚úÖ Proxy endpoint works! Status: ${proxyResponse.status}`, 'success');
                            const blob = await proxyResponse.blob();
                            log(`Proxy returned ${blob.size} bytes of type ${blob.type}`, 'success');
                        } else {
                            log(`‚ùå Proxy failed: ${proxyResponse.status}`, 'error');
                        }
                    } catch (err) {
                        log(`‚ùå Proxy error: ${err.message}`, 'error');
                    }
                }

            } catch (error) {
                log(`Fatal error: ${error.message}`, 'error');
                testResults.innerHTML = `<div class="status error">Test Failed: ${error.message}</div>`;
            }
        }

        // Run tests on page load
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>