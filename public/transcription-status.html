<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Record Your Statement - Car Crash Lawyer AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        h2 {
            color: #444;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }

        h4 {
            color: #666;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 16px;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            height: 4px;
            background: #4CAF50;
            transition: width 0.5s ease;
            z-index: 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            flex: 1;
        }

        .progress-step .circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #999;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.active .circle {
            background: #2196F3;
            color: white;
            box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.2);
        }

        .progress-step.complete .circle {
            background: #4CAF50;
            color: white;
        }

        .progress-step span {
            font-size: 12px;
            color: #666;
        }

        /* Info boxes */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h3 {
            margin-top: 0;
            color: #1976D2;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 6px;
            color: #555;
        }

        /* Audio Visualizer */
        .audio-visualizer {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }

        .audio-visualizer.active {
            display: block;
        }

        .visualizer-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            height: 100px;
        }

        .visualizer-bar {
            width: 6px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 3px;
            transition: height 0.1s ease;
        }

        /* Status Message */
        #statusMessage {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #ff9800;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-indicator.processing {
            background: #ff9800;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-indicator.complete {
            background: #4CAF50;
        }

        .status-indicator.recording {
            background: #f44336;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Recording Status */
        #recordingStatus {
            background: #ffebee;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            display: none;
            margin-bottom: 20px;
        }

        .recording-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            background: #dc2626;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1s ease-in-out infinite;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #d32f2f;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #388E3C;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #f57c00;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .recording-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .auto-save-indicator.saving {
            color: #ff9800;
        }

        .auto-save-indicator.saved {
            color: #4CAF50;
        }

        /* Metrics Dashboard */
        .metrics-dashboard {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
        }

        .metrics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .metric-value {
            font-size: 48px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }

        .metric-value.high {
            color: #4CAF50;
        }

        .metric-value.medium {
            color: #ff9800;
        }

        .metric-value.low {
            color: #f44336;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .completeness-bars {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .completeness-item {
            margin-bottom: 15px;
        }

        .completeness-item:last-child {
            margin-bottom: 0;
        }

        .completeness-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .completeness-bar {
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }

        .completeness-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Audio Playback */
        #audioPlayback {
            width: 100%;
            margin: 20px 0;
            display: none;
        }

        /* Transcription Section */
        #transcriptionResult {
            display: none;
            margin-top: 30px;
        }

        .transcription-box {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            background: #f9f9f9;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .transcription-box:focus {
            border-color: #2196F3;
            background: white;
        }

        .transcription-box[contenteditable]:empty:before {
            content: attr(placeholder);
            color: #999;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        /* AI Summary Section */
        #summarySection {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
        }

        .summary-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .key-points {
            list-style: none;
            padding-left: 0;
        }

        .key-points li {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }

        /* AI Review Section */
        #reviewSection {
            display: none;
            margin-top: 30px;
        }

        .review-box {
            background: #fff9e6;
            border: 2px solid #ffd54f;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .review-box h4 {
            color: #f57c00;
            margin-top: 0;
        }

        .missing-info {
            color: #d32f2f;
            font-weight: 600;
        }

        .suggestion {
            color: #1976D2;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #2196F3;
        }

        /* Combined Report Section */
        #combinedReportSection {
            display: none;
            margin-top: 30px;
        }

        .report-box {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            line-height: 1.8;
        }

        /* Final Review Section */
        #finalReviewSection {
            display: none;
            margin-top: 30px;
        }

        .final-review-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .completeness-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: #4CAF50;
            margin: 20px 0;
        }

        .next-steps {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .next-steps ol {
            margin-left: 20px;
        }

        .next-steps li {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .ai-disclaimer {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .ai-disclaimer strong {
            color: #f57c00;
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            background: #eeeeee;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 2000px;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.5s ease-out;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-banner h2 {
            margin: 0 0 8px 0;
            font-size: 20px;
            color: white;
        }

        .welcome-banner p {
            opacity: 0.95;
            font-size: 14px;
            margin: 0;
        }

        /* Network Status */
        .network-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .network-status.online {
            background: #4CAF50;
            color: white;
        }

        .network-status.offline {
            background: #f44336;
            color: white;
        }

        .network-status .dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        /* Security Badge */
        .security-badge {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .security-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .security-icon {
            font-size: 20px;
        }

        .security-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .security-title {
            font-weight: 600;
            font-size: 12px;
            color: #059669;
            line-height: 1;
        }

        .security-subtitle {
            font-size: 10px;
            color: #666;
            line-height: 1;
        }

        /* Security Details Modal */
        .security-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .security-modal.open {
            display: flex;
        }

        .security-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .security-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .security-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            line-height: 1;
        }

        .security-modal-close:hover {
            color: #333;
        }

        .security-feature {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .security-feature-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .security-feature-text {
            flex: 1;
        }

        .security-feature-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .security-feature-description {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        /* Legal Disclaimer Box */
        .legal-disclaimer-box {
            background: #fff9e6;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .legal-disclaimer-box h3 {
            color: #f57c00;
            margin: 0 0 12px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legal-disclaimer-box p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .legal-disclaimer-box p:last-child {
            margin-bottom: 0;
        }

        .legal-disclaimer-box strong {
            color: #f57c00;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .progress-steps {
                flex-wrap: wrap;
            }

            .recording-controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .security-badge {
                top: auto;
                bottom: 20px;
                right: 20px;
            }

            .network-status {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
    <link rel="stylesheet" href="/css/mascot.css">
</head>
<body>
    <!-- Network Status Indicator -->
    <div class="network-status online" id="networkStatus">
        <span class="dot"></span>
        <span>Connected</span>
    </div>

    <!-- Security & Compliance Badge -->
    <div class="security-badge" id="securityBadge">
        <div class="security-icon">🔒</div>
        <div class="security-content">
            <div class="security-title">Secure & Private</div>
            <div class="security-subtitle">GDPR Compliant</div>
        </div>
    </div>

    <div class="container">
        <!-- Welcome Banner (shown when returning from Typeform) -->
        <div class="welcome-banner" id="welcomeBanner" style="display: none;">
            <h2>✅ Welcome Back!</h2>
            <p>Your profile is complete. Let's record your incident statement.</p>
        </div>

        <h1>🎤 Record Your Statement</h1>

        <!-- Legal Disclaimer -->
        <div class="legal-disclaimer-box">
            <h3>⚠️ Important Notice</h3>
            <p><strong>This is NOT legal advice.</strong> This tool helps you record and organize information about your incident for your own personal records.</p>
            <p>The AI analysis is provided for informational purposes only and does not constitute professional legal advice. Always consult with a qualified solicitor for legal guidance specific to your situation.</p>
        </div>

        <!-- Progress Indicator with Animation -->
        <div class="progress-steps">
            <div class="progress-line" id="progressLine" style="width: 0%"></div>
            <div class="progress-step active" id="step-record">
                <div class="circle">1</div>
                <span>Record</span>
            </div>
            <div class="progress-step" id="step-upload">
                <div class="circle">2</div>
                <span>Upload</span>
            </div>
            <div class="progress-step" id="step-transcribe">
                <div class="circle">3</div>
                <span>Transcribe</span>
            </div>
            <div class="progress-step" id="step-summary">
                <div class="circle">4</div>
                <span>AI Analysis</span>
            </div>
        </div>

        <!-- Recording Guidelines -->
        <div class="info-box">
            <h3>📋 Recording Guidelines</h3>
            <ul>
                <li>Find a quiet location for better accuracy</li>
                <li>Speak clearly about what happened</li>
                <li>Include details about time, location, and events</li>
                <li>Mention any injuries or vehicle damage</li>
                <li>Recording limit: 5 minutes maximum</li>
            </ul>
        </div>

        <!-- What to Include Tips -->
        <div class="info-box" style="background: #fef3c7; border-left-color: #f59e0b;">
            <h3>💡 What to Include</h3>
            <ul>
                <li>Exact time and date of the accident</li>
                <li>Weather and road conditions</li>
                <li>What you saw, heard, and felt</li>
                <li>Actions taken after the accident</li>
                <li>Any unusual circumstances</li>
            </ul>
        </div>

        <!-- Audio Visualizer -->
        <div class="audio-visualizer" id="visualizer">
            <div class="visualizer-bars" id="visualizerBars">
                <!-- Bars will be generated dynamically -->
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage">
            <span class="status-indicator"></span>
            <span id="statusText">Ready to record</span>
        </div>

        <!-- Recording Status -->
        <div id="recordingStatus">
            <div style="display: flex; align-items: center; justify-content: center;">
                <span class="recording-indicator"></span>
                <span style="font-weight: 600; color: #dc2626;">Recording in progress</span>
            </div>
            <p style="margin-top: 10px;">Duration: <span id="duration">0:00</span> / 5:00</p>
        </div>

        <!-- Recording Controls -->
        <div class="recording-controls">
            <button id="recordButton" class="btn btn-primary">
                🎤 Start Recording
            </button>
            <button id="pauseButton" class="btn btn-warning" style="display: none; background: #ff9800;">
                ⏸️ Pause
            </button>
            <button id="stopButton" class="btn btn-danger" style="display: none;">
                ⏹ Stop Recording
            </button>
            <button id="retryButton" class="btn" style="display: none;">
                🔄 Record Again
            </button>
        </div>

        <!-- Audio Playback -->
        <audio id="audioPlayback" controls></audio>

        <!-- Transcription Result -->
        <div id="transcriptionResult">
            <h2>📝 <span id="userName">Your</span> Personal Statement</h2>
            <div class="transcription-box" contenteditable="true" id="transcriptionText" placeholder="Your transcription will appear here..."></div>
            <div class="char-count">
                <span id="wordCount">0 words</span> | <span id="charCount">0 characters</span>
            </div>
            <div class="auto-save-indicator" id="autoSaveIndicator">
                Auto-save enabled
            </div>
            <button class="btn btn-success" id="saveTranscriptionBtn" style="margin-top: 20px;">
                💾 Save Changes
            </button>
            <button class="btn btn-primary" id="generateSummaryBtn" style="margin-top: 20px;">
                🤖 Generate AI Analysis
            </button>
            <p style="text-align: center; color: #666; margin-top: 10px; font-size: 14px;">
                You can edit the transcription above if needed
            </p>
        </div>

        <!-- Metrics Dashboard -->
        <div class="metrics-dashboard" id="metricsDashboard">
            <h2>📊 AI Analysis Overview</h2>

            <div class="metrics-cards">
                <div class="metric-card">
                    <div class="metric-value" id="metricScore">--</div>
                    <div class="metric-label">Completeness Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metricKeyPoints">--</div>
                    <div class="metric-label">Key Points</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metricQuality">--</div>
                    <div class="metric-label">Quality Rating</div>
                </div>
            </div>

            <div class="completeness-bars">
                <h3 style="margin-top: 0; margin-bottom: 20px;">Completeness Breakdown</h3>
                <div class="completeness-item">
                    <div class="completeness-label">
                        <span>Time & Date</span>
                        <span id="timeScore">--</span>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="timeFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="completeness-item">
                    <div class="completeness-label">
                        <span>Location Details</span>
                        <span id="locationScore">--</span>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="locationFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="completeness-item">
                    <div class="completeness-label">
                        <span>Witness Information</span>
                        <span id="witnessScore">--</span>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="witnessFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="completeness-item">
                    <div class="completeness-label">
                        <span>Injuries & Damage</span>
                        <span id="injuryScore">--</span>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="injuryFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Summary Section -->
        <div id="summarySection">
            <h2>🤖 Personal Statement Summary</h2>
            <div class="summary-content">
                <h4>Summary</h4>
                <p id="summaryText" style="color: #555; line-height: 1.6;"></p>
            </div>
            <div class="summary-content">
                <h4>Key Points</h4>
                <ul class="key-points" id="keyPointsList"></ul>
            </div>
        </div>

        <!-- AI Review Section -->
        <div id="reviewSection">
            <div class="collapsible-header" onclick="toggleSection('reviewContent')">
                <h2 style="margin: 0;">💡 AI Review</h2>
                <span>▼</span>
            </div>
            <div class="collapsible-content" id="reviewContent">
                <div class="review-box">
                    <h4>Quality Assessment</h4>
                    <p id="qualityAssessment"></p>
                </div>
                <div class="review-box">
                    <h4>Missing Information</h4>
                    <div id="missingInfo"></div>
                </div>
                <div class="review-box">
                    <h4>Suggestions for Improvement</h4>
                    <div id="suggestions"></div>
                </div>
            </div>
        </div>

        <!-- Combined Report Summary -->
        <div id="combinedReportSection">
            <div class="collapsible-header" onclick="toggleSection('combinedReportContent')">
                <h2 style="margin: 0;">📄 Complete Incident Overview</h2>
                <span>▼</span>
            </div>
            <div class="collapsible-content" id="combinedReportContent">
                <div class="report-box" id="combinedReportText"></div>
            </div>
        </div>

        <!-- Final AI Review with Next Steps -->
        <div id="finalReviewSection">
            <h2>✨ AL's Incident Report Review</h2>
            <div class="final-review-box">
                <h3>Documentation Completeness Score</h3>
                <div class="completeness-score" id="completenessScore">--</div>

                <div class="next-steps">
                    <h4>Strengths of Your Report</h4>
                    <div id="reportStrengths"></div>
                </div>

                <div class="next-steps">
                    <h4>Recommended Next Steps</h4>
                    <ol id="nextStepsList"></ol>
                </div>

                <div class="next-steps">
                    <h4>Legal Considerations</h4>
                    <div id="legalConsiderations"></div>
                </div>
            </div>

            <div class="ai-disclaimer">
                <strong>⚠️ AI-Generated Information Disclaimer</strong><br>
                This analysis is generated by artificial intelligence for informational purposes only and does not constitute legal advice.
                This tool is designed to help you organize your incident information for your personal records.
                Always consult with a qualified solicitor for professional legal guidance specific to your situation.
            </div>
        </div>
    </div>

    <!-- Security Details Modal -->
    <div class="security-modal" id="securityModal">
        <div class="security-modal-content">
            <div class="security-modal-header">
                <h2 style="margin: 0; color: #059669; display: flex; align-items: center; gap: 10px;">
                    <span>🔒</span> Security & Privacy
                </h2>
                <button class="security-modal-close" onclick="closeSecurityModal()">&times;</button>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">🔐</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">End-to-End Encryption</div>
                    <div class="security-feature-description">
                        All data transmission uses HTTPS/TLS encryption. Your recordings and transcriptions are encrypted in transit and at rest.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">🇬🇧</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">UK Data Residency</div>
                    <div class="security-feature-description">
                        Your personal data is stored on servers located in the United Kingdom, complying with UK GDPR requirements.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">✓</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">GDPR Compliant</div>
                    <div class="security-feature-description">
                        We follow all GDPR requirements including data minimization, right to access, right to erasure, and data portability.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">🗑️</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">You Control Your Data</div>
                    <div class="security-feature-description">
                        You can request to view, download, or permanently delete all your data at any time through your account settings.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">🚫</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">No Data Sharing</div>
                    <div class="security-feature-description">
                        We never sell, rent, or share your personal information with third parties for marketing purposes.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">📋</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">Audit Logging</div>
                    <div class="security-feature-description">
                        All access to your data is logged for security and compliance purposes. You can review these logs in your account.
                    </div>
                </div>
            </div>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <p style="font-size: 13px; color: #666; margin: 0 0 15px 0;">
                    For full details about how we handle your data, please review our privacy policy.
                </p>
                <a href="/privacy-policy" target="_blank" style="display: inline-block; padding: 10px 20px; background: #059669; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">
                    View Privacy Policy
                </a>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime;
        let durationInterval;
        let userId = localStorage.getItem('create_user_id') || 'user_' + Date.now();
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationId = null;
        let currentTranscriptionText = '';
        let currentIncidentId = null;
        let isPaused = false;
        let pausedTime = 0;
        let autoSaveInterval = null;

        // Store user ID
        localStorage.setItem('create_user_id', userId);

        // ===== TYPEFORM REDIRECT HANDLER =====
        function extractTypeformParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const user_id = urlParams.get('auth_user_id') ||
                           urlParams.get('user_id') ||
                           urlParams.get('userId') ||
                           urlParams.get('create_user_id');

            const incident_id = urlParams.get('incident_id');

            console.log('📥 URL parameters:', {
                user_id,
                incident_id,
                fullUrl: window.location.href
            });

            if (user_id) {
                localStorage.setItem('create_user_id', user_id);
                sessionStorage.setItem('userId', user_id);
                userId = user_id;
                document.getElementById('welcomeBanner').style.display = 'block';
                return true;
            }

            if (incident_id) {
                currentIncidentId = incident_id;
                sessionStorage.setItem('incident_id', incident_id);
            }

            return false;
        }

        // ===== NETWORK STATUS =====
        function updateNetworkStatus() {
            const statusElement = document.getElementById('networkStatus');
            const statusText = statusElement.querySelector('span:last-child');

            if (navigator.onLine) {
                statusElement.className = 'network-status online';
                statusText.textContent = 'Connected';
            } else {
                statusElement.className = 'network-status offline';
                statusText.textContent = 'Offline';
            }
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', () => {
            updateNetworkStatus();
            showStatus('Network connection lost. Recording will be saved locally.', 'error');
        });

        // ===== STATUS MESSAGE =====
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            const statusIndicator = statusDiv.querySelector('.status-indicator');

            statusDiv.style.display = 'block';
            statusText.textContent = message;

            switch(type) {
                case 'error':
                    statusDiv.style.background = '#fee2e2';
                    statusIndicator.className = 'status-indicator recording';
                    break;
                case 'success':
                    statusDiv.style.background = '#d4edda';
                    statusIndicator.className = 'status-indicator complete';
                    break;
                case 'warning':
                    statusDiv.style.background = '#fff3cd';
                    statusIndicator.className = 'status-indicator processing';
                    break;
                default:
                    statusDiv.style.background = '#d1ecf1';
                    statusIndicator.className = 'status-indicator processing';
            }

            if (type === 'info' || type === 'success') {
                setTimeout(() => {
                    if (statusText.textContent === message) {
                        statusDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // ===== PROGRESS TRACKING =====
        function updateProgress(stepId, status) {
            const step = document.getElementById(stepId);
            const allSteps = document.querySelectorAll('.progress-step');
            const stepIndex = Array.from(allSteps).indexOf(step);

            if (status === 'active') {
                step.classList.add('active');
                step.classList.remove('complete');
                const progressLine = document.getElementById('progressLine');
                progressLine.style.width = `${(stepIndex / 3) * 100}%`;
            } else if (status === 'complete') {
                step.classList.remove('active');
                step.classList.add('complete');
                const progressLine = document.getElementById('progressLine');
                progressLine.style.width = `${((stepIndex + 1) / 4) * 100}%`;
            }
        }

        // ===== AUDIO VISUALIZER =====
        function initializeVisualizer() {
            const barsContainer = document.getElementById('visualizerBars');
            barsContainer.innerHTML = '';

            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = '10px';
                barsContainer.appendChild(bar);
            }
        }

        function animateVisualizer() {
            if (!analyser || !audioContext) return;

            const bars = document.querySelectorAll('.visualizer-bar');
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            bars.forEach((bar, index) => {
                const value = dataArray[index * 4] || 0;
                const height = Math.max(10, (value / 255) * 100);
                bar.style.height = `${height}px`;
            });

            animationId = requestAnimationFrame(animateVisualizer);
        }

        // ===== RECORDING FUNCTIONS =====
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                // Setup audio context for visualization
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;

                // Show visualizer
                document.getElementById('visualizer').classList.add('active');
                animateVisualizer();

                // Setup media recorder
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = handleRecordingComplete;

                mediaRecorder.start();
                recordingStartTime = Date.now();

                // Update UI
                document.getElementById('recordButton').style.display = 'none';
                document.getElementById('pauseButton').style.display = 'inline-block';
                document.getElementById('stopButton').style.display = 'inline-block';
                document.getElementById('recordingStatus').style.display = 'block';
                showStatus('Recording in progress...', 'warning');

                // Start duration timer
                durationInterval = setInterval(updateDuration, 1000);

                // Auto-stop after 5 minutes
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                        showStatus('Maximum recording time reached (5 minutes)', 'warning');
                    }
                }, 5 * 60 * 1000);

            } catch (error) {
                console.error('Error starting recording:', error);
                showStatus('Failed to access microphone. Please check permissions.', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')) {
                mediaRecorder.stop();
                clearInterval(durationInterval);

                // Stop visualizer
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                document.getElementById('visualizer').classList.remove('active');

                // Stop audio tracks
                if (microphone) {
                    microphone.mediaStream.getTracks().forEach(track => track.stop());
                }

                // Update UI
                document.getElementById('pauseButton').style.display = 'none';
                document.getElementById('stopButton').style.display = 'none';
                document.getElementById('retryButton').style.display = 'inline-block';
                document.getElementById('recordingStatus').style.display = 'none';
                showStatus('Processing your recording...', 'info');
                updateProgress('step-record', 'complete');
                updateProgress('step-upload', 'active');

                // Reset pause state
                isPaused = false;
                pausedTime = 0;
            }
        }

        // ===== PAUSE/RESUME FUNCTIONS =====
        function pauseRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.pause();
                isPaused = true;
                pausedTime = Date.now();

                // Pause duration timer
                clearInterval(durationInterval);

                // Pause visualizer
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }

                // Update UI
                document.getElementById('pauseButton').innerHTML = '▶️ Resume';
                document.getElementById('recordingStatus').querySelector('span:last-child').textContent = 'Recording paused';
                showStatus('Recording paused', 'warning');

                console.log('Recording paused');
            }
        }

        function resumeRecording() {
            if (mediaRecorder && mediaRecorder.state === 'paused') {
                mediaRecorder.resume();
                isPaused = false;

                // Adjust recording start time to account for pause
                const pauseDuration = Date.now() - pausedTime;
                recordingStartTime += pauseDuration;

                // Resume duration timer
                durationInterval = setInterval(updateDuration, 1000);

                // Resume visualizer
                animateVisualizer();

                // Update UI
                document.getElementById('pauseButton').innerHTML = '⏸️ Pause';
                document.getElementById('recordingStatus').querySelector('span:last-child').textContent = 'Recording in progress';
                showStatus('Recording resumed', 'info');

                console.log('Recording resumed');
            }
        }

        function togglePause() {
            if (isPaused) {
                resumeRecording();
            } else {
                pauseRecording();
            }
        }

        function updateDuration() {
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('duration').textContent =
                `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        async function handleRecordingComplete() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

            // Show audio player
            const audioPlayback = document.getElementById('audioPlayback');
            audioPlayback.src = URL.createObjectURL(audioBlob);
            audioPlayback.style.display = 'block';

            // Upload and transcribe
            await uploadAndTranscribe(audioBlob);
        }

        async function uploadAndTranscribe(audioBlob) {
            try {
                updateProgress('step-upload', 'complete');
                updateProgress('step-transcribe', 'active');
                showStatus('Uploading and transcribing your recording...', 'info');

                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('userId', userId);

                const response = await fetch('/api/transcription/transcribe', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    updateProgress('step-transcribe', 'complete');
                    showTranscription(result.transcription.text);
                    showStatus('Transcription complete!', 'success');
                } else {
                    throw new Error(result.error || 'Transcription failed');
                }

            } catch (error) {
                console.error('Upload error:', error);
                showStatus('Failed to process recording. Please try again.', 'error');
                document.getElementById('recordButton').style.display = 'inline-block';
                document.getElementById('retryButton').style.display = 'none';
            }
        }

        // ===== TRANSCRIPTION DISPLAY =====
        function showTranscription(text) {
            currentTranscriptionText = text;
            document.getElementById('transcriptionText').textContent = text;
            document.getElementById('transcriptionResult').style.display = 'block';
            updateCharCount();

            // Start auto-save
            startAutoSave();

            // Fetch user name if available
            fetchUserName();
        }

        async function fetchUserName() {
            try {
                const response = await fetch('/api/auth/session', {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.authenticated && data.user.fullName) {
                    document.getElementById('userName').textContent = data.user.fullName + "'s";
                }
            } catch (error) {
                console.log('Could not fetch user name:', error);
            }
        }

        function updateCharCount() {
            const text = document.getElementById('transcriptionText').textContent;
            const words = text.trim().split(/\s+/).length;
            const chars = text.length;
            document.getElementById('wordCount').textContent = `${words} words`;
            document.getElementById('charCount').textContent = `${chars} characters`;
        }

        // ===== AUTO-SAVE FUNCTIONALITY =====
        function startAutoSave() {
            // Auto-save every 10 seconds
            autoSaveInterval = setInterval(() => {
                autoSaveDraft();
            }, 10000);

            console.log('Auto-save enabled (every 10 seconds)');
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
                console.log('Auto-save disabled');
            }
        }

        function autoSaveDraft() {
            const text = document.getElementById('transcriptionText').textContent;

            // Only save if text has changed
            if (text !== currentTranscriptionText && text.trim().length > 0) {
                const indicator = document.getElementById('autoSaveIndicator');
                indicator.textContent = 'Saving draft...';
                indicator.className = 'auto-save-indicator saving';

                // Save to localStorage
                localStorage.setItem('draft_transcription', text);
                localStorage.setItem('draft_timestamp', Date.now());
                localStorage.setItem('draft_userId', userId);

                console.log('Draft auto-saved', { length: text.length });

                // Update indicator
                setTimeout(() => {
                    indicator.textContent = `Last saved: ${new Date().toLocaleTimeString()}`;
                    indicator.className = 'auto-save-indicator saved';
                }, 500);
            }
        }

        function restoreDraft() {
            const savedDraft = localStorage.getItem('draft_transcription');
            const savedTimestamp = localStorage.getItem('draft_timestamp');
            const savedUserId = localStorage.getItem('draft_userId');

            if (savedDraft && savedUserId === userId) {
                const savedDate = new Date(parseInt(savedTimestamp));
                const minutesAgo = Math.floor((Date.now() - parseInt(savedTimestamp)) / 60000);

                let message = 'A draft was auto-saved';
                if (minutesAgo < 1) {
                    message += ' less than a minute ago.';
                } else if (minutesAgo === 1) {
                    message += ' 1 minute ago.';
                } else if (minutesAgo < 60) {
                    message += ` ${minutesAgo} minutes ago.`;
                } else {
                    message += ` on ${savedDate.toLocaleDateString()} at ${savedDate.toLocaleTimeString()}.`;
                }

                message += ' Would you like to restore it?';

                if (confirm(message)) {
                    document.getElementById('transcriptionText').textContent = savedDraft;
                    document.getElementById('transcriptionResult').style.display = 'block';
                    updateCharCount();
                    showStatus('Draft restored successfully', 'success');

                    // Start auto-save
                    startAutoSave();

                    console.log('Draft restored from localStorage');
                } else {
                    // Clear draft if user declines
                    localStorage.removeItem('draft_transcription');
                    localStorage.removeItem('draft_timestamp');
                    localStorage.removeItem('draft_userId');
                }
            }
        }

        // Listen for changes in transcription box
        document.addEventListener('DOMContentLoaded', () => {
            const transcriptionBox = document.getElementById('transcriptionText');
            if (transcriptionBox) {
                transcriptionBox.addEventListener('input', updateCharCount);
            }
        });

        // ===== SAVE TRANSCRIPTION =====
        async function saveTranscription() {
            const text = document.getElementById('transcriptionText').textContent;

            try {
                showStatus('Saving changes...', 'info');

                const response = await fetch('/api/incident-reports/save-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        incidentId: currentIncidentId,
                        personalStatement: text
                    }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    currentTranscriptionText = text;
                    showStatus('Statement saved successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Save failed');
                }

            } catch (error) {
                console.error('Save error:', error);
                showStatus('Failed to save statement. Please try again.', 'error');
            }
        }

        // ===== AI ANALYSIS GENERATION =====
        async function generateAIAnalysis() {
            const text = document.getElementById('transcriptionText').textContent;

            if (!text || text.trim().length === 0) {
                showStatus('Please record or enter a statement first.', 'warning');
                return;
            }

            try {
                updateProgress('step-summary', 'active');
                showStatus('Generating AI analysis...', 'info');

                // Show loading spinners
                document.getElementById('summarySection').style.display = 'block';
                document.getElementById('summaryText').innerHTML = '<div class="spinner"></div><div class="loading-text">Analyzing your statement...</div>';

                const response = await fetch('/api/ai/analyze-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        incidentId: currentIncidentId,
                        transcription: text
                    }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    displayAIAnalysis(result.analysis);
                    updateProgress('step-summary', 'complete');
                    showStatus('AI analysis complete!', 'success');
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }

            } catch (error) {
                console.error('AI analysis error:', error);
                showStatus('Failed to generate AI analysis. Please try again.', 'error');
                document.getElementById('summarySection').style.display = 'none';
            }
        }

        function displayAIAnalysis(analysis) {
            // Display Summary
            document.getElementById('summaryText').innerHTML = analysis.summary || 'No summary available.';

            // Display Key Points
            const keyPointsList = document.getElementById('keyPointsList');
            keyPointsList.innerHTML = '';
            if (analysis.keyPoints && analysis.keyPoints.length > 0) {
                analysis.keyPoints.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    keyPointsList.appendChild(li);
                });
            }

            // Display AI Review
            if (analysis.review) {
                document.getElementById('reviewSection').style.display = 'block';
                document.getElementById('qualityAssessment').textContent = analysis.review.quality || '';

                const missingInfoDiv = document.getElementById('missingInfo');
                missingInfoDiv.innerHTML = '';
                if (analysis.review.missingInfo && analysis.review.missingInfo.length > 0) {
                    const ul = document.createElement('ul');
                    analysis.review.missingInfo.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'missing-info';
                        li.textContent = item;
                        ul.appendChild(li);
                    });
                    missingInfoDiv.appendChild(ul);
                } else {
                    missingInfoDiv.innerHTML = '<p style="color: #4CAF50;">✓ All key information appears to be present.</p>';
                }

                const suggestionsDiv = document.getElementById('suggestions');
                suggestionsDiv.innerHTML = '';
                if (analysis.review.suggestions && analysis.review.suggestions.length > 0) {
                    analysis.review.suggestions.forEach(suggestion => {
                        const div = document.createElement('div');
                        div.className = 'suggestion';
                        div.textContent = suggestion;
                        suggestionsDiv.appendChild(div);
                    });
                }
            }

            // Display Combined Report (if Typeform data available)
            if (analysis.combinedReport) {
                document.getElementById('combinedReportSection').style.display = 'block';
                document.getElementById('combinedReportText').innerHTML = analysis.combinedReport;
            }

            // Display Final Review
            if (analysis.finalReview) {
                document.getElementById('finalReviewSection').style.display = 'block';
                document.getElementById('completenessScore').textContent =
                    analysis.finalReview.completenessScore + '%';

                document.getElementById('reportStrengths').innerHTML =
                    analysis.finalReview.strengths || '';

                const nextStepsList = document.getElementById('nextStepsList');
                nextStepsList.innerHTML = '';
                if (analysis.finalReview.nextSteps && analysis.finalReview.nextSteps.length > 0) {
                    analysis.finalReview.nextSteps.forEach(step => {
                        const li = document.createElement('li');
                        li.textContent = step;
                        nextStepsList.appendChild(li);
                    });
                }

                document.getElementById('legalConsiderations').innerHTML =
                    analysis.finalReview.legalConsiderations || '';
            }

            // ===== POPULATE METRICS DASHBOARD =====
            if (analysis.finalReview) {
                document.getElementById('metricsDashboard').style.display = 'block';

                // Completeness Score
                const score = analysis.finalReview.completenessScore || 0;
                const scoreElement = document.getElementById('metricScore');
                scoreElement.textContent = score + '%';
                scoreElement.className = 'metric-value ' + (score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low');

                // Key Points Count
                const keyPointsCount = analysis.keyPoints ? analysis.keyPoints.length : 0;
                document.getElementById('metricKeyPoints').textContent = keyPointsCount;

                // Quality Rating (derive from review quality)
                let qualityRating = 'Good';
                if (analysis.review && analysis.review.quality) {
                    const quality = analysis.review.quality.toLowerCase();
                    if (quality.includes('excellent') || quality.includes('comprehensive')) {
                        qualityRating = 'Excellent';
                    } else if (quality.includes('good') || quality.includes('detailed')) {
                        qualityRating = 'Good';
                    } else if (quality.includes('fair') || quality.includes('adequate')) {
                        qualityRating = 'Fair';
                    } else if (quality.includes('poor') || quality.includes('lacking')) {
                        qualityRating = 'Poor';
                    }
                }
                document.getElementById('metricQuality').textContent = qualityRating;

                // Completeness Breakdown (estimate based on missing info and score)
                const missingInfo = analysis.review && analysis.review.missingInfo ? analysis.review.missingInfo : [];

                // Calculate individual scores based on missing information
                const calculateCategoryScore = (keywords) => {
                    const hasMissing = missingInfo.some(item =>
                        keywords.some(keyword => item.toLowerCase().includes(keyword))
                    );
                    if (hasMissing) {
                        return Math.max(30, score - 30); // If missing, reduce from overall score
                    }
                    return Math.min(100, score + 10); // If present, slightly above overall score
                };

                const timeScore = calculateCategoryScore(['time', 'date', 'when']);
                const locationScore = calculateCategoryScore(['location', 'where', 'place', 'address']);
                const witnessScore = calculateCategoryScore(['witness', 'who', 'people', 'other']);
                const injuryScore = calculateCategoryScore(['injury', 'injuries', 'damage', 'hurt']);

                // Update Time & Date
                document.getElementById('timeScore').textContent = timeScore + '%';
                document.getElementById('timeFill').style.width = timeScore + '%';

                // Update Location Details
                document.getElementById('locationScore').textContent = locationScore + '%';
                document.getElementById('locationFill').style.width = locationScore + '%';

                // Update Witness Information
                document.getElementById('witnessScore').textContent = witnessScore + '%';
                document.getElementById('witnessFill').style.width = witnessScore + '%';

                // Update Injuries & Damage
                document.getElementById('injuryScore').textContent = injuryScore + '%';
                document.getElementById('injuryFill').style.width = injuryScore + '%';

                console.log('📊 Metrics dashboard populated', {
                    score,
                    keyPointsCount,
                    qualityRating,
                    breakdown: { timeScore, locationScore, witnessScore, injuryScore }
                });
            }
        }

        // ===== COLLAPSIBLE SECTIONS =====
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            content.classList.toggle('open');
        }

        // ===== SECURITY MODAL =====
        function openSecurityModal() {
            document.getElementById('securityModal').classList.add('open');
        }

        function closeSecurityModal() {
            document.getElementById('securityModal').classList.remove('open');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('securityModal');
            if (e.target === modal) {
                closeSecurityModal();
            }
        });

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Initializing transcription page');

            // Extract URL parameters
            extractTypeformParams();

            // Initialize components
            initializeVisualizer();
            updateNetworkStatus();

            // Check for saved draft
            restoreDraft();

            // Set up event listeners
            document.getElementById('recordButton').addEventListener('click', startRecording);
            document.getElementById('pauseButton').addEventListener('click', togglePause);
            document.getElementById('stopButton').addEventListener('click', stopRecording);
            document.getElementById('retryButton').addEventListener('click', () => {
                location.reload();
            });
            document.getElementById('saveTranscriptionBtn').addEventListener('click', saveTranscription);
            document.getElementById('generateSummaryBtn').addEventListener('click', generateAIAnalysis);
            document.getElementById('securityBadge').addEventListener('click', openSecurityModal);

            // Prevent accidental navigation during recording
            window.addEventListener('beforeunload', (e) => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    e.preventDefault();
                    e.returnValue = 'Recording in progress. Are you sure you want to leave?';
                }
            });

            showStatus('Ready to record your statement', 'info');
            console.log('✅ Transcription page initialized successfully');
        });

        // Handle errors globally
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showStatus(`Error: ${event.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showStatus(`Error: ${event.reason}`, 'error');
        });
    </script>
    <script src="/js/mascot.js"></script>
</body>
</html>
