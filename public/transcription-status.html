<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Record Your Statement - Car Crash Lawyer AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        h2 {
            color: #444;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }

        h4 {
            color: #666;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 16px;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            height: 4px;
            background: #4CAF50;
            transition: width 0.5s ease;
            z-index: 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            flex: 1;
        }

        .progress-step .circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #999;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.active .circle {
            background: #2196F3;
            color: white;
            box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.2);
        }

        .progress-step.complete .circle {
            background: #4CAF50;
            color: white;
        }

        .progress-step span {
            font-size: 12px;
            color: #666;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .tab-button {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            background: #f5f5f5;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: #eeeeee;
            color: #333;
        }

        .tab-button.active {
            background: white;
            color: #2196F3;
            border-bottom-color: #2196F3;
        }

        .tab-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Info boxes */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h3 {
            margin-top: 0;
            color: #1976D2;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 6px;
            color: #555;
        }

        /* Audio Visualizer */
        .audio-visualizer {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px 30px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }

        .audio-visualizer.active {
            display: block;
        }

        .visualizer-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .visualizer-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .audio-level-indicator {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .audio-level-indicator.quiet {
            background: #f44336;
            color: white;
        }

        .audio-level-indicator.good {
            background: #4CAF50;
            color: white;
        }

        .audio-level-indicator.loud {
            background: #ff9800;
            color: white;
        }

        .visualizer-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 6px;
            height: 250px;
            margin-bottom: 15px;
        }

        .visualizer-bar {
            width: 8px;
            border-radius: 4px;
            transition: all 0.1s ease;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .visualizer-bar.level-quiet {
            background: linear-gradient(to top, #f44336, #ef5350);
        }

        .visualizer-bar.level-good {
            background: linear-gradient(to top, #4CAF50, #66BB6A);
        }

        .visualizer-bar.level-loud {
            background: linear-gradient(to top, #ff9800, #ffa726);
        }

        .visualizer-footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        /* Status Message */
        #statusMessage {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #ff9800;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-indicator.processing {
            background: #ff9800;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-indicator.complete {
            background: #4CAF50;
        }

        .status-indicator.recording {
            background: #f44336;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Recording Status */
        #recordingStatus {
            background: #ffebee;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            display: none;
            margin-bottom: 20px;
        }

        .recording-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            background: #dc2626;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1s ease-in-out infinite;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #d32f2f;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #388E3C;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #f57c00;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .recording-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .auto-save-indicator.saving {
            color: #ff9800;
        }

        .auto-save-indicator.saved {
            color: #4CAF50;
        }

        /* Metrics Dashboard */
        .metrics-dashboard {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
        }

        .metrics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .metric-value {
            font-size: 48px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }

        .metric-value.high {
            color: #4CAF50;
        }

        .metric-value.medium {
            color: #ff9800;
        }

        .metric-value.low {
            color: #f44336;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .completeness-bars {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .completeness-item {
            margin-bottom: 15px;
        }

        .completeness-item:last-child {
            margin-bottom: 0;
        }

        .completeness-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .completeness-bar {
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }

        .completeness-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Audio Playback */
        #audioPlayback {
            width: 100%;
            margin: 20px 0;
            display: none;
        }

        /* Transcription Section */
        #transcriptionResult {
            display: none;
            margin-top: 30px;
        }

        .transcription-box {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            background: #f9f9f9;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .transcription-box:focus {
            border-color: #2196F3;
            background: white;
        }

        .transcription-box[contenteditable]:empty:before {
            content: attr(placeholder);
            color: #999;
        }

        .char-count {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        /* AI Summary Section */
        #summarySection {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
        }

        .summary-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .key-points {
            list-style: none;
            padding-left: 0;
        }

        .key-points li {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }

        /* AI Review Section */
        #reviewSection {
            display: none;
            margin-top: 30px;
        }

        .review-box {
            background: #fff9e6;
            border: 2px solid #ffd54f;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .review-box h4 {
            color: #f57c00;
            margin-top: 0;
        }

        .missing-info {
            color: #d32f2f;
            font-weight: 600;
        }

        .suggestion {
            color: #1976D2;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #2196F3;
        }

        /* Combined Report Section */
        #combinedReportSection {
            display: none;
            margin-top: 30px;
        }

        .report-box {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            line-height: 1.8;
        }

        /* Final Review Section */
        #finalReviewSection {
            display: none;
            margin-top: 30px;
        }

        .final-review-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .completeness-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: #4CAF50;
            margin: 20px 0;
        }

        .next-steps {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .next-steps ol {
            margin-left: 20px;
        }

        .next-steps li {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .ai-disclaimer {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .ai-disclaimer strong {
            color: #f57c00;
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            background: #eeeeee;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 2000px;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            animation: slideDown 0.5s ease-out;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-banner h2 {
            margin: 0 0 8px 0;
            font-size: 20px;
            color: white;
        }

        .welcome-banner p {
            opacity: 0.95;
            font-size: 14px;
            margin: 0;
        }

        /* Network Status */
        .network-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .network-status.online {
            background: #4CAF50;
            color: white;
        }

        .network-status.offline {
            background: #f44336;
            color: white;
        }

        .network-status .dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        /* Security Badge */
        .security-badge {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 999;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .security-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .security-icon {
            font-size: 20px;
        }

        .security-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .security-title {
            font-weight: 600;
            font-size: 12px;
            color: #059669;
            line-height: 1;
        }

        .security-subtitle {
            font-size: 10px;
            color: #666;
            line-height: 1;
        }

        /* Security Details Modal */
        .security-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .security-modal.open {
            display: flex;
        }

        .security-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .security-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .security-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            line-height: 1;
        }

        .security-modal-close:hover {
            color: #333;
        }

        .security-feature {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .security-feature-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .security-feature-text {
            flex: 1;
        }

        .security-feature-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .security-feature-description {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        /* Legal Disclaimer Box */
        .legal-disclaimer-box {
            background: #fff9e6;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .legal-disclaimer-box h3 {
            color: #f57c00;
            margin: 0 0 12px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legal-disclaimer-box p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .legal-disclaimer-box p:last-child {
            margin-bottom: 0;
        }

        .legal-disclaimer-box strong {
            color: #f57c00;
        }

        /* Microphone Check Modal */
        .mic-check-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10002;
            align-items: center;
            justify-content: center;
        }

        .mic-check-modal.active {
            display: flex;
        }

        .mic-check-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .mic-check-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .mic-check-instruction {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .mic-check-visualizer {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .mic-check-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            height: 100px;
        }

        .mic-check-bar {
            width: 6px;
            border-radius: 3px;
            background: linear-gradient(to top, #4CAF50, #66BB6A);
            transition: height 0.1s ease;
        }

        .mic-level-text {
            color: white;
            margin-top: 15px;
            font-weight: 600;
        }

        .mic-check-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Recording Countdown Overlay */
        .countdown-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .countdown-overlay.active {
            display: flex;
        }

        .countdown-number {
            font-size: 150px;
            font-weight: bold;
            color: white;
            animation: countdownPulse 1s ease-in-out;
        }

        .countdown-text {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 20px;
        }

        @keyframes countdownPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Responsive Design */
        /* Hover Tooltip for Manual Typing Button */
        .btn-with-tooltip {
            position: relative;
            display: inline-block;
        }

        .hover-tooltip {
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #2196F3;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
            width: 280px;
            max-width: 90vw;
            pointer-events: none;
        }

        .btn-with-tooltip:hover .hover-tooltip {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 16px);
        }

        .hover-tooltip-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hover-tooltip-title {
            font-weight: 700;
            color: #2196F3;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hover-tooltip-text {
            font-size: 0.813rem;
            color: #333;
            line-height: 1.5;
        }

        .hover-tooltip-arrow {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #2196F3;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                padding-bottom: 120px; /* Extra space for sticky controls */
            }

            h1 {
                font-size: 24px;
            }

            .progress-steps {
                flex-wrap: wrap;
            }

            .recording-controls {
                flex-direction: column;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 15px 20px;
                box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
                z-index: 998;
                margin: 0;
            }

            .btn {
                width: 100%;
            }

            .security-badge {
                top: auto;
                bottom: 90px;
                right: 20px;
            }

            .network-status {
                font-size: 12px;
                padding: 8px 12px;
            }

            .countdown-number {
                font-size: 120px;
            }

            .countdown-text {
                font-size: 18px;
            }

            .hover-tooltip {
                width: 260px;
            }
        }
    </style>
    <link rel="stylesheet" href="/css/mascot.css">
</head>
<body>
    <!-- Microphone Check Modal -->
    <div class="mic-check-modal" id="micCheckModal">
        <div class="mic-check-content">
            <h2 class="mic-check-title">🎤 Microphone Check</h2>
            <p class="mic-check-instruction">Speak into your microphone to test the audio level</p>
            <div class="mic-check-visualizer">
                <div class="mic-check-bars" id="micCheckBars">
                    <!-- Bars will be generated dynamically -->
                </div>
                <div class="mic-level-text" id="micLevelText">Speak to test...</div>
            </div>
            <div class="mic-check-buttons">
                <button class="btn" id="cancelMicCheck">Cancel</button>
                <button class="btn btn-success" id="proceedWithRecording">Sounds Good, Let's Record!</button>
            </div>
        </div>
    </div>

    <!-- Recording Countdown Overlay -->
    <div class="countdown-overlay" id="countdownOverlay">
        <div class="countdown-number" id="countdownNumber">5</div>
        <div class="countdown-text">Get ready to record...</div>
    </div>

    <!-- Network Status Indicator -->
    <div class="network-status online" id="networkStatus">
        <span class="dot"></span>
        <span>Connected</span>
    </div>

    <!-- Security & Compliance Badge -->
    <div class="security-badge" id="securityBadge">
        <div class="security-icon">🔒</div>
        <div class="security-content">
            <div class="security-title">Secure & Private</div>
            <div class="security-subtitle">GDPR Compliant</div>
        </div>
    </div>

    <div class="container">
        <!-- Welcome Banner (shown when returning from Typeform) -->
        <div class="welcome-banner" id="welcomeBanner" style="display: none;">
            <h2>✅ Welcome Back!</h2>
            <p>Your profile is complete. Let's record your incident statement.</p>
        </div>

        <h1>🎤 Record Your Statement</h1>

        <!-- Legal Disclaimer -->
        <div class="legal-disclaimer-box">
            <h3>⚠️ Important Notice</h3>
            <p><strong>This is NOT legal advice.</strong> This tool helps you record and organize information about your incident for your own personal records.</p>
            <p>The AI analysis is provided for informational purposes only and does not constitute professional legal advice. Always consult with a qualified solicitor for legal guidance specific to your situation.</p>
        </div>

        <!-- Progress Indicator with Animation -->
        <div class="progress-steps">
            <div class="progress-line" id="progressLine" style="width: 0%"></div>
            <div class="progress-step active" id="step-record">
                <div class="circle">1</div>
                <span>Record</span>
            </div>
            <div class="progress-step" id="step-upload">
                <div class="circle">2</div>
                <span>Upload</span>
            </div>
            <div class="progress-step" id="step-transcribe">
                <div class="circle">3</div>
                <span>Transcribe</span>
            </div>
            <div class="progress-step" id="step-summary">
                <div class="circle">4</div>
                <span>AI Analysis</span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="record">🎤 Record</button>
            <button class="tab-button" data-tab="transcription" id="transcriptionTab">📝 Transcription</button>
            <button class="tab-button" data-tab="analysis" id="analysisTab">🤖 AI Analysis</button>
        </div>

        <!-- Tab Panel: Record -->
        <div class="tab-panel active" id="tab-record">

        <!-- Recording Guidelines -->
        <div class="info-box">
            <h3>📋 Recording Guidelines</h3>
            <ul>
                <li>Find a quiet location for better accuracy</li>
                <li>Speak clearly about what happened</li>
                <li>Include details about time, location, and events</li>
                <li>Mention any injuries or vehicle damage</li>
                <li>Recording limit: 5 minutes maximum</li>
            </ul>
        </div>

        <!-- What to Include Tips -->
        <div class="info-box" style="background: #fef3c7; border-left-color: #f59e0b;">
            <h3>💡 What to Include</h3>
            <ul>
                <li>Exact time and date of the accident</li>
                <li>Weather and road conditions</li>
                <li>What you saw, heard, and felt</li>
                <li>Actions taken after the accident</li>
                <li>Any unusual circumstances</li>
            </ul>
        </div>

        <!-- Audio Visualizer -->
        <div class="audio-visualizer" id="visualizer">
            <div class="visualizer-header">
                <div class="visualizer-title">🎙️ Recording Active</div>
                <div class="audio-level-indicator good" id="audioLevelIndicator">
                    Audio Level: Good
                </div>
            </div>
            <div class="visualizer-bars" id="visualizerBars">
                <!-- Bars will be generated dynamically -->
            </div>
            <div class="visualizer-footer">
                Speak clearly into your microphone
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusMessage">
            <span class="status-indicator"></span>
            <span id="statusText">Ready to record</span>
        </div>

        <!-- Recording Status -->
        <div id="recordingStatus">
            <div style="display: flex; align-items: center; justify-content: center;">
                <span class="recording-indicator"></span>
                <span style="font-weight: 600; color: #dc2626;">Recording in progress</span>
            </div>
            <p style="margin-top: 10px;">Duration: <span id="duration">0:00</span> / 5:00</p>
        </div>

        <!-- Recording Controls -->
        <div class="recording-controls">
            <button id="recordButton" class="btn btn-primary">
                🎤 Start Recording
            </button>
            <button id="pauseButton" class="btn btn-warning" style="display: none; background: #ff9800;">
                ⏸️ Pause
            </button>
            <button id="stopButton" class="btn btn-danger" style="display: none;">
                ⏹ Stop Recording
            </button>
            <button id="retryButton" class="btn" style="display: none;">
                🔄 Record Again
            </button>
        </div>

        <!-- Manual Typing Button with Tooltip -->
        <div style="text-align: center; margin: 20px 0;">
            <div class="btn-with-tooltip">
                <button id="typeOwnAccountBtn" class="btn" style="background: #6366f1; color: white;">
                    ✍️ Type Your Own Account
                </button>

                <!-- Hover Tooltip -->
                <div class="hover-tooltip">
                    <div class="hover-tooltip-content">
                        <div class="hover-tooltip-title">
                            <span>💡</span>
                            <span>Pro Tip</span>
                        </div>
                        <div class="hover-tooltip-text">
                            if AI not available please manually type your own record of events!
                        </div>
                    </div>
                    <div class="hover-tooltip-arrow"></div>
                </div>
            </div>
        </div>

        <!-- Audio Playback -->
        <audio id="audioPlayback" controls></audio>

        </div> <!-- End Tab Panel: Record -->

        <!-- Tab Panel: Transcription -->
        <div class="tab-panel" id="tab-transcription">

        <!-- Full Accident Narrative -->
        <div id="narrativeSection">
            <h2>📝 Full Accident Narrative</h2>
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px 16px; margin-bottom: 15px; border-radius: 4px;">
                <strong>📖 Your Comprehensive Account:</strong> Describe what happened from your perspective. Include what you saw, heard, felt, and any important details about the circumstances leading up to, during, and after the accident.
            </div>

            <div class="form-group">
                <label for="accidentNarrative" style="font-weight: 600; margin-bottom: 8px; display: block;">
                    Describe the accident in your own words
                    <span style="color: #e53e3e;">*</span>
                </label>
                <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
                    <strong>What to include:</strong> Time and circumstances leading up to the accident, weather and road conditions, what you were doing, what the other vehicle(s) did, the moment of impact, immediate aftermath, injuries, and any conversations or observations.
                </p>
                <textarea
                    id="accidentNarrative"
                    name="accident_narrative"
                    placeholder="Example: 'I was driving north on the A40 approaching the junction with Mill Road at approximately 35mph in light traffic. The weather was clear with good visibility. As I entered the junction on a green light, a silver Ford Focus traveling west on Mill Road suddenly accelerated through what appeared to be a red light on their side. I immediately braked hard but could not avoid the collision. The front of their vehicle struck the passenger side of my car with significant force...'

Continue with: What happened immediately after impact? Any injuries you noticed? What did the other driver say or do? Who witnessed the accident? What emergency services attended? Any other relevant details?"
                    maxlength="2000"
                    rows="15"
                    style="width: 100%; padding: 15px; border: 2px solid #cbd5e0; border-radius: 8px; font-size: 15px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; resize: vertical; min-height: 300px;"
                ></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <span id="narrativeCharCount" style="color: #666; font-size: 14px;">0 / 2000 characters</span>
                    <span id="narrativeWordCount" style="color: #666; font-size: 14px;">0 words</span>
                </div>
            </div>

            <div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 12px 16px; margin: 20px 0; border-radius: 4px;">
                <strong>💡 Optional:</strong> You can also use the voice recorder below to verbally describe the accident. Your recording will be transcribed automatically and can supplement your written narrative.
            </div>
        </div>

        <!-- Voice Transcription (Optional) -->
        <div id="transcriptionResult" style="margin-top: 30px;">
            <h3>🎤 Voice Transcription (Optional)</h3>
            <div style="background: #f0f4f8; border-left: 4px solid #718096; padding: 12px 16px; margin-bottom: 15px; border-radius: 4px;">
                <strong>Voice Recording:</strong> Use the "Record" tab above to verbally describe the accident. Your audio will be transcribed and appear here as additional supporting detail.
            </div>
            <div class="transcription-box" contenteditable="true" id="transcriptionText" placeholder="Voice transcription will appear here if you use the recorder..."></div>
            <div class="char-count">
                <span id="wordCount">0 words</span> | <span id="charCount">0 characters</span>
            </div>
            <div class="auto-save-indicator" id="autoSaveIndicator">
                Auto-save enabled
            </div>
            <button class="btn btn-success" id="saveTranscriptionBtn" style="margin-top: 20px;">
                💾 Save Changes
            </button>
            <button class="btn btn-primary" id="generateSummaryBtn" style="margin-top: 20px;">
                🤖 Generate AI Analysis
            </button>
            <button class="btn btn-warning" id="clearDraftBtn" style="margin-top: 20px;">
                🗑️ Clear Draft
            </button>
            <p style="text-align: center; color: #666; margin-top: 10px; font-size: 14px;">
                You can edit the transcription above if needed
            </p>
        </div>

        </div> <!-- End Tab Panel: Transcription -->

        <!-- Tab Panel: Analysis -->
        <div class="tab-panel" id="tab-analysis">

        <!-- Metrics Dashboard -->
        <div class="metrics-dashboard" id="metricsDashboard">
            <h2>📊 AI Analysis Overview</h2>

            <div class="metrics-cards">
                <div class="metric-card">
                    <div class="metric-value" id="metricScore">--</div>
                    <div class="metric-label">Completeness Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metricKeyPoints">--</div>
                    <div class="metric-label">Key Points</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metricQuality">--</div>
                    <div class="metric-label">Quality Rating</div>
                </div>
            </div>

            <div class="completeness-bars">
                <h3 style="margin-top: 0; margin-bottom: 20px;">Completeness Breakdown</h3>
                <div class="completeness-item">
                    <div class="completeness-label">
                        <span>Time & Date</span>
                        <span id="timeScore">--</span>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="timeFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="completeness-item">
                    <div class="completeness-label">
                        <span>Location Details</span>
                        <span id="locationScore">--</span>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="locationFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="completeness-item">
                    <div class="completeness-label">
                        <span>Witness Information</span>
                        <span id="witnessScore">--</span>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="witnessFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="completeness-item">
                    <div class="completeness-label">
                        <span>Injuries & Damage</span>
                        <span id="injuryScore">--</span>
                    </div>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="injuryFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Summary Section -->
        <div id="summarySection">
            <h2>🤖 Personal Statement Summary</h2>
            <div class="summary-content">
                <h4>Summary</h4>
                <p id="summaryText" style="color: #555; line-height: 1.6;"></p>
            </div>
            <div class="summary-content">
                <h4>Key Points</h4>
                <ul class="key-points" id="keyPointsList"></ul>
            </div>
        </div>

        <!-- AI Review Section -->
        <div id="reviewSection">
            <div class="collapsible-header" data-target="reviewContent">
                <h2 style="margin: 0;">💡 AI Review</h2>
                <span>▼</span>
            </div>
            <div class="collapsible-content" id="reviewContent">
                <div class="review-box">
                    <h4>Quality Assessment</h4>
                    <p id="qualityAssessment"></p>
                </div>
                <div class="review-box">
                    <h4>Missing Information</h4>
                    <div id="missingInfo"></div>
                </div>
                <div class="review-box">
                    <h4>Suggestions for Improvement</h4>
                    <div id="suggestions"></div>
                </div>
            </div>
        </div>

        <!-- Combined Report Summary -->
        <div id="combinedReportSection">
            <div class="collapsible-header" data-target="combinedReportContent">
                <h2 style="margin: 0;">📄 Complete Incident Overview</h2>
                <span>▼</span>
            </div>
            <div class="collapsible-content" id="combinedReportContent">
                <div class="report-box" id="combinedReportText"></div>
            </div>
        </div>

        <!-- Final AI Review with Next Steps -->
        <div id="finalReviewSection">
            <h2>✨ AL's Incident Report Review</h2>
            <div class="final-review-box">
                <h3>Documentation Completeness Score</h3>
                <div class="completeness-score" id="completenessScore">--</div>

                <div class="next-steps">
                    <h4>Strengths of Your Report</h4>
                    <div id="reportStrengths"></div>
                </div>

                <div class="next-steps">
                    <h4>Recommended Next Steps</h4>
                    <ol id="nextStepsList"></ol>
                </div>

                <div class="next-steps">
                    <h4>Legal Considerations</h4>
                    <div id="legalConsiderations"></div>
                </div>
            </div>

            <!-- Save and Continue Button -->
            <div style="text-align: center; margin: 30px 0 20px 0;">
                <button class="btn btn-success" id="saveAndContinueBtn" style="font-size: 18px; padding: 15px 40px;">
                    💾 Save & Continue to Declaration
                </button>
            </div>

            <div class="ai-disclaimer">
                <strong>⚠️ AI-Generated Information Disclaimer</strong><br>
                This analysis is generated by artificial intelligence for informational purposes only and does not constitute legal advice.
                This tool is designed to help you organize your incident information for your personal records.
                Always consult with a qualified solicitor for professional legal guidance specific to your situation.
            </div>
        </div>

        </div> <!-- End Tab Panel: Analysis -->

    </div> <!-- End Container -->

    <!-- Security Details Modal -->
    <div class="security-modal" id="securityModal">
        <div class="security-modal-content">
            <div class="security-modal-header">
                <h2 style="margin: 0; color: #059669; display: flex; align-items: center; gap: 10px;">
                    <span>🔒</span> Security & Privacy
                </h2>
                <button class="security-modal-close" onclick="closeSecurityModal()">&times;</button>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">🔐</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">End-to-End Encryption</div>
                    <div class="security-feature-description">
                        All data transmission uses HTTPS/TLS encryption. Your recordings and transcriptions are encrypted in transit and at rest.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">🇬🇧</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">UK Data Residency</div>
                    <div class="security-feature-description">
                        Your personal data is stored on servers located in the United Kingdom, complying with UK GDPR requirements.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">✓</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">GDPR Compliant</div>
                    <div class="security-feature-description">
                        We follow all GDPR requirements including data minimization, right to access, right to erasure, and data portability.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">🗑️</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">You Control Your Data</div>
                    <div class="security-feature-description">
                        You can request to view, download, or permanently delete all your data at any time through your account settings.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">🚫</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">No Data Sharing</div>
                    <div class="security-feature-description">
                        We never sell, rent, or share your personal information with third parties for marketing purposes.
                    </div>
                </div>
            </div>

            <div class="security-feature">
                <div class="security-feature-icon">📋</div>
                <div class="security-feature-text">
                    <div class="security-feature-title">Audit Logging</div>
                    <div class="security-feature-description">
                        All access to your data is logged for security and compliance purposes. You can review these logs in your account.
                    </div>
                </div>
            </div>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <p style="font-size: 13px; color: #666; margin: 0 0 15px 0;">
                    For full details about how we handle your data, please review our privacy policy.
                </p>
                <a href="/privacy-policy" target="_blank" style="display: inline-block; padding: 10px 20px; background: #059669; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;">
                    View Privacy Policy
                </a>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime;
        let durationInterval;
        let userId = localStorage.getItem('create_user_id') || 'user_' + Date.now();
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationId = null;
        let currentTranscriptionText = '';
        let currentIncidentId = null;
        let isPaused = false;
        let pausedTime = 0;
        let autoSaveInterval = null;

        // Store user ID
        localStorage.setItem('create_user_id', userId);

        // ===== TYPEFORM REDIRECT HANDLER =====
        function extractTypeformParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const user_id = urlParams.get('auth_user_id') ||
                           urlParams.get('user_id') ||
                           urlParams.get('userId') ||
                           urlParams.get('create_user_id');

            const incident_id = urlParams.get('incident_id');

            console.log('📥 URL parameters:', {
                user_id,
                incident_id,
                fullUrl: window.location.href
            });

            if (user_id) {
                localStorage.setItem('create_user_id', user_id);
                sessionStorage.setItem('userId', user_id);
                userId = user_id;
                document.getElementById('welcomeBanner').style.display = 'block';
                return true;
            }

            if (incident_id) {
                currentIncidentId = incident_id;
                sessionStorage.setItem('incident_id', incident_id);
            }

            return false;
        }

        // ===== NETWORK STATUS =====
        function updateNetworkStatus() {
            const statusElement = document.getElementById('networkStatus');
            const statusText = statusElement.querySelector('span:last-child');

            if (navigator.onLine) {
                statusElement.className = 'network-status online';
                statusText.textContent = 'Connected';
            } else {
                statusElement.className = 'network-status offline';
                statusText.textContent = 'Offline';
            }
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', () => {
            updateNetworkStatus();
            showStatus('Network connection lost. Recording will be saved locally.', 'error');
        });

        // ===== STATUS MESSAGE =====
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            const statusIndicator = statusDiv.querySelector('.status-indicator');

            statusDiv.style.display = 'block';
            statusText.textContent = message;

            switch(type) {
                case 'error':
                    statusDiv.style.background = '#fee2e2';
                    statusIndicator.className = 'status-indicator recording';
                    break;
                case 'success':
                    statusDiv.style.background = '#d4edda';
                    statusIndicator.className = 'status-indicator complete';
                    break;
                case 'warning':
                    statusDiv.style.background = '#fff3cd';
                    statusIndicator.className = 'status-indicator processing';
                    break;
                default:
                    statusDiv.style.background = '#d1ecf1';
                    statusIndicator.className = 'status-indicator processing';
            }

            if (type === 'info' || type === 'success') {
                setTimeout(() => {
                    if (statusText.textContent === message) {
                        statusDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // ===== PROGRESS TRACKING =====
        function updateProgress(stepId, status) {
            const step = document.getElementById(stepId);
            const allSteps = document.querySelectorAll('.progress-step');
            const stepIndex = Array.from(allSteps).indexOf(step);

            if (status === 'active') {
                step.classList.add('active');
                step.classList.remove('complete');
                const progressLine = document.getElementById('progressLine');
                progressLine.style.width = `${(stepIndex / 3) * 100}%`;
            } else if (status === 'complete') {
                step.classList.remove('active');
                step.classList.add('complete');
                const progressLine = document.getElementById('progressLine');
                progressLine.style.width = `${((stepIndex + 1) / 4) * 100}%`;
            }
        }

        // ===== AUDIO VISUALIZER =====
        function initializeVisualizer() {
            const barsContainer = document.getElementById('visualizerBars');
            barsContainer.innerHTML = '';

            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = '10px';
                barsContainer.appendChild(bar);
            }
        }

        function animateVisualizer() {
            if (!analyser || !audioContext) return;

            const bars = document.querySelectorAll('.visualizer-bar');
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // Calculate average audio level
            let sum = 0;
            bars.forEach((bar, index) => {
                const value = dataArray[index * 4] || 0;
                sum += value;
                const height = Math.max(10, (value / 255) * 250);  // Scale to 250px max
                bar.style.height = `${height}px`;

                // Apply color class based on value
                bar.className = 'visualizer-bar';
                if (value < 30) {
                    bar.classList.add('level-quiet');
                } else if (value < 150) {
                    bar.classList.add('level-good');
                } else {
                    bar.classList.add('level-loud');
                }
            });

            // Update audio level indicator
            const avgLevel = sum / bars.length;
            const indicator = document.getElementById('audioLevelIndicator');

            if (indicator) {
                indicator.className = 'audio-level-indicator';
                if (avgLevel < 30) {
                    indicator.classList.add('quiet');
                    indicator.textContent = 'Audio Level: Too Quiet';
                } else if (avgLevel < 150) {
                    indicator.classList.add('good');
                    indicator.textContent = 'Audio Level: Good';
                } else {
                    indicator.classList.add('loud');
                    indicator.textContent = 'Audio Level: Too Loud';
                }
            }

            animationId = requestAnimationFrame(animateVisualizer);
        }

        // ===== MICROPHONE CHECK =====
        let micCheckStream = null;
        let micCheckContext = null;
        let micCheckAnalyser = null;
        let micCheckAnimationId = null;

        function initializeMicCheckBars() {
            const barsContainer = document.getElementById('micCheckBars');
            barsContainer.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'mic-check-bar';
                bar.style.height = '10px';
                barsContainer.appendChild(bar);
            }
        }

        function animateMicCheckVisualizer() {
            if (!micCheckAnalyser || !micCheckContext) return;

            const bars = document.querySelectorAll('.mic-check-bar');
            const dataArray = new Uint8Array(micCheckAnalyser.frequencyBinCount);
            micCheckAnalyser.getByteFrequencyData(dataArray);

            let sum = 0;
            bars.forEach((bar, index) => {
                const value = dataArray[index * 6] || 0;
                sum += value;
                const height = Math.max(10, (value / 255) * 100);
                bar.style.height = `${height}px`;
            });

            const avgLevel = sum / bars.length;
            const levelText = document.getElementById('micLevelText');
            if (avgLevel < 20) {
                levelText.textContent = 'Too quiet - speak louder!';
                levelText.style.color = '#ff9800';
            } else if (avgLevel < 150) {
                levelText.textContent = 'Perfect! Your microphone is working great!';
                levelText.style.color = '#4CAF50';
            } else {
                levelText.textContent = 'Very loud - you might want to move back a bit';
                levelText.style.color = '#ff9800';
            }

            micCheckAnimationId = requestAnimationFrame(animateMicCheckVisualizer);
        }

        async function startMicrophoneCheck() {
            try {
                const modal = document.getElementById('micCheckModal');
                modal.classList.add('active');

                initializeMicCheckBars();

                micCheckStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                micCheckContext = new (window.AudioContext || window.webkitAudioContext)();
                micCheckAnalyser = micCheckContext.createAnalyser();
                const micCheckMicrophone = micCheckContext.createMediaStreamSource(micCheckStream);
                micCheckMicrophone.connect(micCheckAnalyser);
                micCheckAnalyser.fftSize = 256;

                animateMicCheckVisualizer();

                // Set up button event listeners (safer than inline onclick for CSP)
                const cancelBtn = document.getElementById('cancelMicCheck');
                const proceedBtn = document.getElementById('proceedWithRecording');

                // Remove any existing listeners
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                proceedBtn.replaceWith(proceedBtn.cloneNode(true));

                // Get fresh references after cloning
                const newCancelBtn = document.getElementById('cancelMicCheck');
                const newProceedBtn = document.getElementById('proceedWithRecording');

                return new Promise((resolve, reject) => {
                    window.micCheckResolve = resolve;
                    window.micCheckReject = reject;

                    // Add click handlers
                    newCancelBtn.addEventListener('click', cancelMicrophoneCheck);
                    newProceedBtn.addEventListener('click', proceedWithRecording);
                });
            } catch (error) {
                console.error('Microphone check error:', error);
                showStatus('Failed to access microphone. Please check permissions.', 'error');
                throw error;
            }
        }

        function cancelMicrophoneCheck() {
            console.log('🚫 Microphone check cancelled');
            if (micCheckAnimationId) {
                cancelAnimationFrame(micCheckAnimationId);
            }
            if (micCheckStream) {
                micCheckStream.getTracks().forEach(track => track.stop());
            }
            if (micCheckContext) {
                micCheckContext.close();
            }

            document.getElementById('micCheckModal').classList.remove('active');

            if (window.micCheckReject) {
                window.micCheckReject('cancelled');
            }
        }

        function proceedWithRecording() {
            console.log('✅ Microphone check passed, proceeding with recording');
            if (micCheckAnimationId) {
                cancelAnimationFrame(micCheckAnimationId);
            }
            if (micCheckStream) {
                micCheckStream.getTracks().forEach(track => track.stop());
            }
            if (micCheckContext) {
                micCheckContext.close();
            }

            document.getElementById('micCheckModal').classList.remove('active');

            if (window.micCheckResolve) {
                window.micCheckResolve();
            }
        }

        // ===== COUNTDOWN FUNCTION =====
        function showCountdown() {
            return new Promise((resolve) => {
                const overlay = document.getElementById('countdownOverlay');
                const numberElement = document.getElementById('countdownNumber');
                let count = 5;

                // Show overlay
                overlay.classList.add('active');

                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        numberElement.textContent = count;
                        // Re-trigger animation by removing and adding class
                        numberElement.style.animation = 'none';
                        setTimeout(() => {
                            numberElement.style.animation = '';
                        }, 10);
                    } else {
                        clearInterval(countdownInterval);
                        overlay.classList.remove('active');
                        resolve();
                    }
                }, 1000);
            });
        }

        // ===== RECORDING FUNCTIONS =====
        async function startRecording() {
            try {
                // First, check microphone
                await startMicrophoneCheck();

                // Then show countdown
                await showCountdown();

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                // Setup audio context for visualization
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;

                // Show visualizer
                document.getElementById('visualizer').classList.add('active');

                // Scroll to visualizer for better UX
                setTimeout(() => {
                    document.getElementById('visualizer').scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }, 300); // Small delay to allow visualizer to render

                animateVisualizer();

                // Setup media recorder
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = handleRecordingComplete;

                mediaRecorder.start();
                recordingStartTime = Date.now();

                // Update UI
                document.getElementById('recordButton').style.display = 'none';
                document.getElementById('pauseButton').style.display = 'inline-block';
                document.getElementById('stopButton').style.display = 'inline-block';
                document.getElementById('recordingStatus').style.display = 'block';
                showStatus('Recording in progress...', 'warning');

                // Start duration timer
                durationInterval = setInterval(updateDuration, 1000);

                // Auto-stop after 5 minutes
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                        showStatus('Maximum recording time reached (5 minutes)', 'warning');
                    }
                }, 5 * 60 * 1000);

            } catch (error) {
                console.error('Error starting recording:', error);
                showStatus('Failed to access microphone. Please check permissions.', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')) {
                mediaRecorder.stop();
                clearInterval(durationInterval);

                // Stop visualizer
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                document.getElementById('visualizer').classList.remove('active');

                // Stop audio tracks
                if (microphone) {
                    microphone.mediaStream.getTracks().forEach(track => track.stop());
                }

                // Update UI
                document.getElementById('pauseButton').style.display = 'none';
                document.getElementById('stopButton').style.display = 'none';
                document.getElementById('retryButton').style.display = 'inline-block';
                document.getElementById('recordingStatus').style.display = 'none';
                showStatus('Processing your recording...', 'info');
                updateProgress('step-record', 'complete');
                updateProgress('step-upload', 'active');

                // Reset pause state
                isPaused = false;
                pausedTime = 0;
            }
        }

        // ===== PAUSE/RESUME FUNCTIONS =====
        function pauseRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.pause();
                isPaused = true;
                pausedTime = Date.now();

                // Pause duration timer
                clearInterval(durationInterval);

                // Pause visualizer
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }

                // Update UI
                document.getElementById('pauseButton').innerHTML = '▶️ Resume';
                document.getElementById('recordingStatus').querySelector('span:last-child').textContent = 'Recording paused';
                showStatus('Recording paused', 'warning');

                console.log('Recording paused');
            }
        }

        function resumeRecording() {
            if (mediaRecorder && mediaRecorder.state === 'paused') {
                mediaRecorder.resume();
                isPaused = false;

                // Adjust recording start time to account for pause
                const pauseDuration = Date.now() - pausedTime;
                recordingStartTime += pauseDuration;

                // Resume duration timer
                durationInterval = setInterval(updateDuration, 1000);

                // Resume visualizer
                animateVisualizer();

                // Update UI
                document.getElementById('pauseButton').innerHTML = '⏸️ Pause';
                document.getElementById('recordingStatus').querySelector('span:last-child').textContent = 'Recording in progress';
                showStatus('Recording resumed', 'info');

                console.log('Recording resumed');
            }
        }

        function togglePause() {
            if (isPaused) {
                resumeRecording();
            } else {
                pauseRecording();
            }
        }

        function updateDuration() {
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('duration').textContent =
                `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        async function handleRecordingComplete() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

            // Show audio player
            const audioPlayback = document.getElementById('audioPlayback');
            audioPlayback.src = URL.createObjectURL(audioBlob);
            audioPlayback.style.display = 'block';

            // Upload and transcribe
            await uploadAndTranscribe(audioBlob);
        }

        async function uploadAndTranscribe(audioBlob) {
            try {
                updateProgress('step-upload', 'complete');
                updateProgress('step-transcribe', 'active');
                showStatus('Uploading and transcribing your recording...', 'info');

                console.log('📤 Uploading audio:', {
                    size: Math.round(audioBlob.size / 1024) + ' KB',
                    type: audioBlob.type
                });

                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                // Note: userId comes from authentication cookie (via requireAuth middleware)

                const response = await fetch('/api/transcription/transcribe', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include' // Send cookies for authentication
                });

                console.log('📥 Server response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                // Try to parse JSON response
                let result;
                try {
                    result = await response.json();
                    console.log('📄 Response data:', result);
                } catch (jsonError) {
                    console.error('❌ Failed to parse JSON:', jsonError);
                    const textResponse = await response.text();
                    console.error('❌ Response text:', textResponse);
                    throw new Error(`Server returned invalid JSON (Status: ${response.status})`);
                }

                if (!response.ok) {
                    throw new Error(result.error || result.message || `Server error: ${response.status} ${response.statusText}`);
                }

                if (result.success) {
                    updateProgress('step-transcribe', 'complete');
                    showTranscription(result.transcription.text);
                    showStatus('Transcription complete!', 'success');
                } else {
                    throw new Error(result.error || result.message || 'Transcription failed');
                }

            } catch (error) {
                console.error('❌ Upload error:', error);

                // Show detailed error message
                let errorMessage = 'Failed to process recording. ';
                if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Please try again.';
                }

                showStatus(errorMessage, 'error');
                document.getElementById('recordButton').style.display = 'inline-block';
                document.getElementById('retryButton').style.display = 'none';
            }
        }

        // ===== TRANSCRIPTION DISPLAY =====
        function showTranscription(text) {
            currentTranscriptionText = text;
            document.getElementById('transcriptionText').textContent = text;
            document.getElementById('transcriptionResult').style.display = 'block';
            updateCharCount();

            // Start auto-save
            startAutoSave();

            // Fetch user name if available
            fetchUserName();

            // Switch to Transcription tab
            switchTab('transcription');
        }

        async function fetchUserName() {
            try {
                const response = await fetch('/api/auth/session', {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.authenticated && data.user.fullName) {
                    document.getElementById('userName').textContent = data.user.fullName + "'s";
                }
            } catch (error) {
                console.log('Could not fetch user name:', error);
            }
        }

        function updateCharCount() {
            const text = document.getElementById('transcriptionText').textContent;
            const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            const chars = text.length;
            document.getElementById('wordCount').textContent = `${words} words`;
            document.getElementById('charCount').textContent = `${chars} characters`;
        }

        function updateNarrativeCount() {
            const text = document.getElementById('accidentNarrative').value;
            const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            const chars = text.length;

            const charCountEl = document.getElementById('narrativeCharCount');
            const wordCountEl = document.getElementById('narrativeWordCount');

            charCountEl.textContent = `${chars} / 2000 characters`;
            wordCountEl.textContent = `${words} words`;

            // Visual feedback for character limit
            if (chars >= 1900) {
                charCountEl.style.color = '#e53e3e';
                charCountEl.style.fontWeight = '700';
            } else if (chars >= 1600) {
                charCountEl.style.color = '#f59e0b';
                charCountEl.style.fontWeight = '600';
            } else {
                charCountEl.style.color = '#666';
                charCountEl.style.fontWeight = '400';
            }
        }

        // ===== AUTO-SAVE FUNCTIONALITY =====
        function startAutoSave() {
            // Auto-save every 10 seconds
            autoSaveInterval = setInterval(() => {
                autoSaveDraft();
            }, 10000);

            console.log('Auto-save enabled (every 10 seconds)');
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
                console.log('Auto-save disabled');
            }
        }

        function autoSaveDraft() {
            const transcriptionText = document.getElementById('transcriptionText').textContent;
            const narrativeText = document.getElementById('accidentNarrative').value;

            // Only save if text has changed
            if ((transcriptionText !== currentTranscriptionText && transcriptionText.trim().length > 0) ||
                narrativeText.trim().length > 0) {
                const indicator = document.getElementById('autoSaveIndicator');
                indicator.textContent = 'Saving draft...';
                indicator.className = 'auto-save-indicator saving';

                // Save both to localStorage
                localStorage.setItem('draft_transcription', transcriptionText);
                localStorage.setItem('draft_narrative', narrativeText);
                localStorage.setItem('draft_timestamp', Date.now());
                localStorage.setItem('draft_userId', userId);

                console.log('Draft auto-saved', {
                    transcriptionLength: transcriptionText.length,
                    narrativeLength: narrativeText.length
                });

                // Update indicator
                setTimeout(() => {
                    indicator.textContent = `Last saved: ${new Date().toLocaleTimeString()}`;
                    indicator.className = 'auto-save-indicator saved';
                }, 500);
            }
        }

        function restoreDraft() {
            const savedTranscription = localStorage.getItem('draft_transcription');
            const savedNarrative = localStorage.getItem('draft_narrative');
            const savedTimestamp = localStorage.getItem('draft_timestamp');
            const savedUserId = localStorage.getItem('draft_userId');

            if ((savedTranscription || savedNarrative) && savedUserId === userId) {
                const savedDate = new Date(parseInt(savedTimestamp));
                const minutesAgo = Math.floor((Date.now() - parseInt(savedTimestamp)) / 60000);

                let message = 'A draft was auto-saved';
                if (minutesAgo < 1) {
                    message += ' less than a minute ago.';
                } else if (minutesAgo === 1) {
                    message += ' 1 minute ago.';
                } else if (minutesAgo < 60) {
                    message += ` ${minutesAgo} minutes ago.`;
                } else {
                    message += ` on ${savedDate.toLocaleDateString()} at ${savedDate.toLocaleTimeString()}.`;
                }

                message += ' Would you like to restore it?';

                if (confirm(message)) {
                    if (savedTranscription) {
                        document.getElementById('transcriptionText').textContent = savedTranscription;
                        document.getElementById('transcriptionResult').style.display = 'block';
                        updateCharCount();
                    }
                    if (savedNarrative) {
                        document.getElementById('accidentNarrative').value = savedNarrative;
                        updateNarrativeCount();
                    }
                    showStatus('Draft restored successfully', 'success');

                    // Start auto-save
                    startAutoSave();

                    console.log('Draft restored from localStorage');
                } else {
                    // Clear draft if user declines
                    localStorage.removeItem('draft_transcription');
                    localStorage.removeItem('draft_narrative');
                    localStorage.removeItem('draft_timestamp');
                    localStorage.removeItem('draft_userId');
                }
            }
        }

        // Listen for changes in transcription box and narrative
        document.addEventListener('DOMContentLoaded', () => {
            const transcriptionBox = document.getElementById('transcriptionText');
            if (transcriptionBox) {
                transcriptionBox.addEventListener('input', updateCharCount);
            }

            const narrativeBox = document.getElementById('accidentNarrative');
            if (narrativeBox) {
                narrativeBox.addEventListener('input', updateNarrativeCount);
                // Initial count
                updateNarrativeCount();
            }
        });

        // ===== SAVE TRANSCRIPTION =====
        async function saveTranscription() {
            const transcriptionText = document.getElementById('transcriptionText').textContent;
            const narrativeText = document.getElementById('accidentNarrative').value;

            // Combine narrative and voice transcription
            let combinedStatement = '';
            if (narrativeText.trim()) {
                combinedStatement += '=== Full Accident Narrative ===\n\n' + narrativeText.trim();
            }
            if (transcriptionText.trim()) {
                if (combinedStatement) combinedStatement += '\n\n';
                combinedStatement += '=== Voice Transcription ===\n\n' + transcriptionText.trim();
            }

            if (!combinedStatement.trim()) {
                showStatus('Please write your accident narrative before saving', 'error');
                return;
            }

            try {
                showStatus('Saving statement...', 'info');

                const response = await fetch('/api/incident-reports/save-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        incidentId: currentIncidentId,
                        personalStatement: combinedStatement,
                        accidentNarrative: narrativeText,
                        voiceTranscription: transcriptionText
                    }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    currentTranscriptionText = transcriptionText;
                    showStatus('Statement saved successfully!', 'success');

                    // Clear localStorage draft after successful save
                    localStorage.removeItem('draft_transcription');
                    localStorage.removeItem('draft_narrative');
                } else {
                    throw new Error(result.error || 'Save failed');
                }

            } catch (error) {
                console.error('Save error:', error);
                showStatus('Failed to save statement. Please try again.', 'error');
            }
        }

        // Clear draft from localStorage and textareas
        function clearDraft() {
            if (confirm('Are you sure you want to clear all drafts? This cannot be undone.')) {
                // Clear localStorage
                localStorage.removeItem('draft_transcription');
                localStorage.removeItem('draft_narrative');
                localStorage.removeItem('draft_timestamp');
                localStorage.removeItem('draft_userId');

                // Clear both fields
                const transcriptionText = document.getElementById('transcriptionText');
                const narrativeText = document.getElementById('accidentNarrative');
                transcriptionText.textContent = '';
                narrativeText.value = '';

                // Update counters
                updateCharCount();
                updateNarrativeCount();

                // Show confirmation
                showStatus('Drafts cleared successfully', 'success');
                console.log('✅ Draft cleared from localStorage');
            }
        }

        // ===== SAVE AND CONTINUE TO DECLARATION =====
        async function saveAndContinue() {
            const transcriptionText = document.getElementById('transcriptionText').textContent;
            const narrativeText = document.getElementById('accidentNarrative').value;

            if ((!narrativeText || narrativeText.trim().length === 0) &&
                (!transcriptionText || transcriptionText.trim().length === 0)) {
                showStatus('Please write your accident narrative before continuing.', 'warning');
                return;
            }

            // Combine narrative and transcription (prioritize narrative)
            const combinedStatement = narrativeText.trim()
                ? narrativeText.trim()
                : transcriptionText.trim();

            try {
                showStatus('Saving your statement...', 'info');

                const response = await fetch('/api/incident-reports/save-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        incidentId: currentIncidentId,
                        personalStatement: combinedStatement
                    }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Saved! Redirecting to declaration page...', 'success');
                    console.log('✅ Statement saved, redirecting to declaration');

                    // Clear auto-save draft since we're moving to next page
                    localStorage.removeItem('transcriptionDraft');

                    // Redirect to declaration page
                    setTimeout(() => {
                        window.location.href = '/declaration.html';
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to save statement');
                }
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Failed to save. Please try again.', 'error');
            }
        }

        // ===== AI ANALYSIS GENERATION =====
        async function generateAIAnalysis() {
            const text = document.getElementById('transcriptionText').textContent;

            if (!text || text.trim().length === 0) {
                showStatus('Please record or enter a statement first.', 'warning');
                return;
            }

            try {
                updateProgress('step-summary', 'active');
                showStatus('Generating AI analysis...', 'info');

                // Show loading spinners
                document.getElementById('summarySection').style.display = 'block';
                document.getElementById('summaryText').innerHTML = '<div class="spinner"></div><div class="loading-text">Analyzing your statement...</div>';

                const response = await fetch('/api/ai/analyze-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        incidentId: currentIncidentId,
                        transcription: text
                    }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    displayAIAnalysis(result.analysis);
                    updateProgress('step-summary', 'complete');
                    showStatus('AI analysis complete!', 'success');
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }

            } catch (error) {
                console.error('AI analysis error:', error);
                showStatus('Failed to generate AI analysis. Please try again.', 'error');
                document.getElementById('summarySection').style.display = 'none';
            }
        }

        function displayAIAnalysis(analysis) {
            // Display Summary
            document.getElementById('summaryText').innerHTML = analysis.summary || 'No summary available.';

            // Display Key Points
            const keyPointsList = document.getElementById('keyPointsList');
            keyPointsList.innerHTML = '';
            if (analysis.keyPoints && analysis.keyPoints.length > 0) {
                analysis.keyPoints.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    keyPointsList.appendChild(li);
                });
            }

            // Display AI Review
            if (analysis.review) {
                document.getElementById('reviewSection').style.display = 'block';
                document.getElementById('qualityAssessment').textContent = analysis.review.quality || '';

                const missingInfoDiv = document.getElementById('missingInfo');
                missingInfoDiv.innerHTML = '';
                if (analysis.review.missingInfo && analysis.review.missingInfo.length > 0) {
                    const ul = document.createElement('ul');
                    analysis.review.missingInfo.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'missing-info';
                        li.textContent = item;
                        ul.appendChild(li);
                    });
                    missingInfoDiv.appendChild(ul);
                } else {
                    missingInfoDiv.innerHTML = '<p style="color: #4CAF50;">✓ All key information appears to be present.</p>';
                }

                const suggestionsDiv = document.getElementById('suggestions');
                suggestionsDiv.innerHTML = '';
                if (analysis.review.suggestions && analysis.review.suggestions.length > 0) {
                    analysis.review.suggestions.forEach(suggestion => {
                        const div = document.createElement('div');
                        div.className = 'suggestion';
                        div.textContent = suggestion;
                        suggestionsDiv.appendChild(div);
                    });
                }
            }

            // Display Combined Report (if Typeform data available)
            if (analysis.combinedReport) {
                document.getElementById('combinedReportSection').style.display = 'block';
                document.getElementById('combinedReportText').innerHTML = analysis.combinedReport;
            }

            // Display Final Review
            if (analysis.finalReview) {
                document.getElementById('finalReviewSection').style.display = 'block';
                document.getElementById('completenessScore').textContent =
                    analysis.finalReview.completenessScore + '%';

                document.getElementById('reportStrengths').innerHTML =
                    analysis.finalReview.strengths || '';

                const nextStepsList = document.getElementById('nextStepsList');
                nextStepsList.innerHTML = '';
                if (analysis.finalReview.nextSteps && analysis.finalReview.nextSteps.length > 0) {
                    analysis.finalReview.nextSteps.forEach(step => {
                        const li = document.createElement('li');
                        li.textContent = step;
                        nextStepsList.appendChild(li);
                    });
                }

                document.getElementById('legalConsiderations').innerHTML =
                    analysis.finalReview.legalConsiderations || '';
            }

            // ===== POPULATE METRICS DASHBOARD =====
            if (analysis.finalReview) {
                document.getElementById('metricsDashboard').style.display = 'block';

                // Completeness Score
                const score = analysis.finalReview.completenessScore || 0;
                const scoreElement = document.getElementById('metricScore');
                scoreElement.textContent = score + '%';
                scoreElement.className = 'metric-value ' + (score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low');

                // Key Points Count
                const keyPointsCount = analysis.keyPoints ? analysis.keyPoints.length : 0;
                document.getElementById('metricKeyPoints').textContent = keyPointsCount;

                // Quality Rating (derive from review quality)
                let qualityRating = 'Good';
                if (analysis.review && analysis.review.quality) {
                    const quality = analysis.review.quality.toLowerCase();
                    if (quality.includes('excellent') || quality.includes('comprehensive')) {
                        qualityRating = 'Excellent';
                    } else if (quality.includes('good') || quality.includes('detailed')) {
                        qualityRating = 'Good';
                    } else if (quality.includes('fair') || quality.includes('adequate')) {
                        qualityRating = 'Fair';
                    } else if (quality.includes('poor') || quality.includes('lacking')) {
                        qualityRating = 'Poor';
                    }
                }
                document.getElementById('metricQuality').textContent = qualityRating;

                // Completeness Breakdown (estimate based on missing info and score)
                const missingInfo = analysis.review && analysis.review.missingInfo ? analysis.review.missingInfo : [];

                // Calculate individual scores based on missing information
                const calculateCategoryScore = (keywords) => {
                    const hasMissing = missingInfo.some(item =>
                        keywords.some(keyword => item.toLowerCase().includes(keyword))
                    );
                    if (hasMissing) {
                        return Math.max(30, score - 30); // If missing, reduce from overall score
                    }
                    return Math.min(100, score + 10); // If present, slightly above overall score
                };

                const timeScore = calculateCategoryScore(['time', 'date', 'when']);
                const locationScore = calculateCategoryScore(['location', 'where', 'place', 'address']);
                const witnessScore = calculateCategoryScore(['witness', 'who', 'people', 'other']);
                const injuryScore = calculateCategoryScore(['injury', 'injuries', 'damage', 'hurt']);

                // Update Time & Date
                document.getElementById('timeScore').textContent = timeScore + '%';
                document.getElementById('timeFill').style.width = timeScore + '%';

                // Update Location Details
                document.getElementById('locationScore').textContent = locationScore + '%';
                document.getElementById('locationFill').style.width = locationScore + '%';

                // Update Witness Information
                document.getElementById('witnessScore').textContent = witnessScore + '%';
                document.getElementById('witnessFill').style.width = witnessScore + '%';

                // Update Injuries & Damage
                document.getElementById('injuryScore').textContent = injuryScore + '%';
                document.getElementById('injuryFill').style.width = injuryScore + '%';

                console.log('📊 Metrics dashboard populated', {
                    score,
                    keyPointsCount,
                    qualityRating,
                    breakdown: { timeScore, locationScore, witnessScore, injuryScore }
                });
            }

            // Switch to Analysis tab
            switchTab('analysis');
        }

        // ===== COLLAPSIBLE SECTIONS =====
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            content.classList.toggle('open');
        }

        // ===== TAB SWITCHING =====
        function switchTab(tabName, event = null) {
            // Remove active class from all tab buttons and panels
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Add active class to selected tab button
            // If event is provided, use it; otherwise find button by onclick attribute
            let tabButton = null;
            if (event) {
                tabButton = event.target.closest('.tab-button');
            } else {
                // Find button by searching for one that calls switchTab with this tabName
                tabButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
            }

            if (tabButton) {
                tabButton.classList.add('active');
            }

            const tabPanel = document.getElementById(`tab-${tabName}`);
            if (tabPanel) {
                tabPanel.classList.add('active');
            }

            console.log(`Switched to ${tabName} tab`);
        }

        // ===== SECURITY MODAL =====
        function openSecurityModal() {
            document.getElementById('securityModal').classList.add('open');
        }

        function closeSecurityModal() {
            document.getElementById('securityModal').classList.remove('open');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('securityModal');
            if (e.target === modal) {
                closeSecurityModal();
            }
        });

        // ===== AUTHENTICATION CHECK =====
        async function checkAuthentication() {
            try {
                console.log('🔐 Checking authentication...');

                const response = await fetch('/api/auth/session', {
                    method: 'GET',
                    credentials: 'include' // Include cookies
                });

                const data = await response.json();

                if (!response.ok || !data.authenticated) {
                    console.warn('❌ User not authenticated, redirecting to login');
                    // Redirect to login with return URL
                    const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                    window.location.href = `/login.html?redirect=${returnUrl}`;
                    return false;
                }

                // User is authenticated! Get userId from session
                userId = data.user.id;
                console.log('✅ User authenticated:', {
                    userId,
                    email: data.user.email
                });

                return true;

            } catch (error) {
                console.error('❌ Authentication check failed:', error);
                // On error, redirect to login
                window.location.href = '/login.html';
                return false;
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Initializing transcription page');

            // Check authentication first
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // Stop initialization if not authenticated
            }

            // Extract URL parameters (for incident_id if present)
            extractTypeformParams();

            // Initialize components
            initializeVisualizer();
            updateNetworkStatus();

            // Check for saved draft
            restoreDraft();

            // Set up event listeners
            document.getElementById('recordButton').addEventListener('click', startRecording);
            document.getElementById('pauseButton').addEventListener('click', togglePause);
            document.getElementById('stopButton').addEventListener('click', stopRecording);
            document.getElementById('retryButton').addEventListener('click', () => {
                location.reload();
            });
            document.getElementById('saveTranscriptionBtn').addEventListener('click', saveTranscription);
            document.getElementById('generateSummaryBtn').addEventListener('click', generateAIAnalysis);
            document.getElementById('clearDraftBtn').addEventListener('click', clearDraft);
            document.getElementById('saveAndContinueBtn').addEventListener('click', saveAndContinue);
            document.getElementById('securityBadge').addEventListener('click', openSecurityModal);

            // Type Your Own Account button - switches to Transcription tab
            document.getElementById('typeOwnAccountBtn').addEventListener('click', () => {
                switchTab('transcription');
            });

            // Tab navigation event listeners (CSP compliant)
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.tab;
                    switchTab(tabName, e);
                });
            });

            // Collapsible section event listeners (CSP compliant)
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    if (targetId) {
                        toggleSection(targetId);
                    }
                });
            });

            // Prevent accidental navigation during recording
            window.addEventListener('beforeunload', (e) => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    e.preventDefault();
                    e.returnValue = 'Recording in progress. Are you sure you want to leave?';
                }
            });

            showStatus('Ready to record your statement', 'info');
            console.log('✅ Transcription page initialized successfully');
        });

        // Handle errors globally
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showStatus(`Error: ${event.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showStatus(`Error: ${event.reason}`, 'error');
        });
    </script>
    <script src="/js/mascot.js"></script>
</body>
</html>
