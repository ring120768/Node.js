<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Other Driver & Vehicle - Page 7 of 10</title>

  <style>
    /* Design System Variables */
    :root {
      /* Brand Colors */
      --grad-start: #0E7490;
      --grad-end: #0c6179;
      --accent: #0E7490;
      --accent-hover: #0c6179;

      /* Page Background */
      --bg-light: #E8DCC4;

      /* Text Colors */
      --text-dark: #1a1a1a;
      --text-muted: #6b7280;

      /* Borders & Dividers */
      --border: #4B5563;

      /* Form Elements */
      --input-bg: #CFD2D7;
      --checkbox-bg: #F5F1E8;
      --container-bg: #F5F1E8;
      --button-bg: #ffffff;
      --button-hover: rgba(14, 116, 144, 0.1);

      /* Status Colors */
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.6;
      overflow-x: hidden;
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }

    /* Sticky Banner */
    .banner {
      background: linear-gradient(135deg, var(--grad-start) 0%, var(--grad-end) 100%);
      padding: 20px 16px;
      position: sticky;
      top: 0;
      z-index: 200;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    @supports (padding-top: env(safe-area-inset-top)) {
      .banner {
        padding-top: max(20px, env(safe-area-inset-top));
      }
    }

    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 12px;
    }

    .brand .logo {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .brand h1 {
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .brand .tagline {
      font-size: 0.875rem;
      color: rgba(255,255,255,0.95);
      font-weight: 500;
    }

    /* Progress Bar */
    .progress-container {
      margin-top: 16px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      height: 8px;
      overflow: hidden;
      backdrop-filter: blur(8px);
    }

    .progress-bar {
      height: 100%;
      background: white;
      border-radius: 20px;
      transition: width 0.3s ease;
      width: 70%; /* Page 7 of 10 */
    }

    .progress-label {
      text-align: center;
      color: white;
      font-size: 0.75rem;
      margin-top: 8px;
      font-weight: 600;
    }

    /* Main Container */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .page-header h2 {
      font-size: 1.5rem;
      color: var(--text-dark);
      margin-bottom: 8px;
    }

    .page-header p {
      color: var(--text-muted);
      font-size: 0.938rem;
    }

    /* Form Sections */
    .form-section {
      background: var(--container-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 16px;
    }

    .section-icon {
      font-size: 1.5rem;
    }

    /* Form Groups */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 8px;
      font-size: 0.938rem;
    }

    .required {
      color: var(--danger);
    }

    .form-hint {
      font-size: 0.813rem;
      color: var(--text-muted);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    /* Input Fields */
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s;
      background: var(--input-bg);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.1);
      background: #ffffff;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af;
    }

    /* DVLA Lookup Section */
    .lookup-container {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .lookup-container input {
      flex: 1;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .lookup-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--grad-start) 0%, var(--grad-end) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.938rem;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .lookup-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(14, 116, 144, 0.3);
    }

    .lookup-btn:active {
      transform: translateY(0);
    }

    .lookup-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Vehicle Details Display */
    .vehicle-details {
      background: linear-gradient(135deg, rgba(14, 116, 144, 0.05) 0%, rgba(12, 97, 121, 0.05) 100%);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
    }

    .vehicle-details h3 {
      font-size: 1.125rem;
      color: var(--accent);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 0.875rem;
    }

    .detail-value {
      color: var(--text-muted);
      font-size: 0.875rem;
      text-align: right;
    }

    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.813rem;
      font-weight: 600;
    }

    .status-badge.valid {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status-badge.invalid {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .status-badge.expired {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .status-badge.checking {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .status-badge.beta {
      background: rgba(99, 102, 241, 0.1);
      color: #6366f1;
      font-size: 0.75rem;
    }

    /* Navigation Buttons */
    .nav-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 32px;
    }

    .btn {
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-secondary {
      background: var(--button-bg);
      color: var(--grad-start);
      border: 2px solid var(--grad-start);
    }

    .btn-secondary:hover {
      border-color: var(--grad-start);
      background: var(--button-hover);
    }

    .btn-primary {
      background: var(--grad-start);
      color: white;
      box-shadow: 0 4px 12px rgba(14, 116, 144, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(14, 116, 144, 0.4);
      background: var(--grad-end);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    #add-vehicle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(14, 116, 144, 0.4);
      background: var(--accent-hover);
    }

    #add-vehicle-btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Alert Messages */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.875rem;
    }

    .alert-info {
      background: rgba(99, 102, 241, 0.1);
      color: #4338ca;
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      color: #b91c1c;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Warning Container */
    .warnings-container {
      margin-top: 16px;
      display: none; /* Hidden until warnings exist */
    }

    /* Mobile Responsive */
    @media (max-width: 640px) {
      .lookup-container {
        flex-direction: column;
      }

      .lookup-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- Sticky Banner -->
  <div class="banner">
    <div class="brand">
      <img src="/images/logo.png" alt="Car Crash Lawyer AI Logo" class="logo">
      <h1>Incident Report</h1>
      <p class="tagline">Page 7 of 10: Other Driver & Vehicle</p>
    </div>

    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
    <div class="progress-label">70% Complete</div>
  </div>

  <!-- Main Container -->
  <div class="container">

    <div class="page-header">
      <h2>Other Driver & Vehicle Details</h2>
      <p>Information about the other driver and their vehicle</p>
    </div>

    <!-- Helpful Information Alert -->
    <div class="alert alert-info" style="margin-bottom: 24px;">
      <span>ℹ️</span>
      <div>
        <strong>We understand this information may be difficult to obtain</strong>
        <p style="margin-top: 4px;">Just provide what you can. You only need:</p>
        <ul style="margin: 8px 0 0 20px; padding: 0;">
          <li>Driver name OR license plate (whichever you have)</li>
          <li>Brief description of damage to their vehicle (minimum 5 characters)</li>
        </ul>
        <p style="margin-top: 8px; font-size: 0.875rem; opacity: 0.9;">
          All other fields are optional but recommended if available.
        </p>
      </div>
    </div>

    <!-- Other Driver Information -->
    <div class="form-section">
      <div class="section-title">
        <span class="section-icon">👤</span>
        <span>Other Driver Information</span>
      </div>

      <div class="form-group">
        <label for="other-driver-name" class="form-label">
          Full Name
          <span style="color: var(--text-muted); font-size: 0.875rem;">(if known)</span>
        </label>
        <input
          type="text"
          id="other-driver-name"
          name="other_driver_name"
          placeholder="Enter full name if available"
        >
      </div>

      <div class="form-group">
        <label for="other-driver-phone" class="form-label">
          Contact Number
        </label>
        <input
          type="tel"
          id="other-driver-phone"
          name="other_driver_phone"
          placeholder="e.g., 07700 900000"
        >
      </div>

      <div class="form-group">
        <label for="other-driver-email" class="form-label">
          Email Address
        </label>
        <input
          type="email"
          id="other-driver-email"
          name="other_driver_email"
          placeholder="e.g., driver@example.com"
        >
      </div>

      <div class="form-group">
        <label for="other-driver-license" class="form-label">
          Driving License Number (if obtained)
        </label>
        <input
          type="text"
          id="other-driver-license"
          name="other_driver_license"
          placeholder="e.g., JONES061102W97YT"
          maxlength="16"
        >
      </div>
    </div>

    <!-- Other Vehicle Registration & DVLA Lookup -->
    <div class="form-section">
      <div class="section-title">
        <span class="section-icon">🔍</span>
        <span>Other Vehicle Registration</span>
      </div>

      <div class="form-group">
        <label for="other-license-plate" class="form-label">
          UK License Plate Number
          <span style="color: var(--text-muted); font-size: 0.875rem;">(if known)</span>
        </label>
        <p class="form-hint">Enter the other vehicle's registration number if you have it</p>

        <div class="lookup-container">
          <input
            type="text"
            id="other-license-plate"
            name="other_license_plate"
            placeholder="e.g., AB12 CDE"
            maxlength="8"
          >
          <button type="button" class="lookup-btn" id="lookup-btn">
            🔍 Look Up
          </button>
        </div>
      </div>

      <!-- Vehicle Details (Hidden until lookup) -->
      <div id="vehicle-details" style="display: none;" class="vehicle-details">
        <h3>✅ Vehicle Found</h3>

        <div class="detail-row">
          <span class="detail-label">Make</span>
          <span class="detail-value" id="vehicle-make">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Model</span>
          <span class="detail-value" id="vehicle-model">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Colour</span>
          <span class="detail-value" id="vehicle-colour">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Year</span>
          <span class="detail-value" id="vehicle-year">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Fuel Type</span>
          <span class="detail-value" id="vehicle-fuel">-</span>
        </div>
      </div>

      <!-- Error Message -->
      <div id="lookup-error" style="display: none;" class="alert alert-error">
        <span>⚠️</span>
        <span id="lookup-error-message">Vehicle not found. Please check the registration number.</span>
      </div>
    </div>

    <!-- Other Vehicle Status & Warnings -->
    <div class="form-section">
      <div class="section-title">
        <span class="section-icon">📋</span>
        <span>Other Vehicle Status</span>
      </div>

      <div class="form-group">
        <div class="detail-row">
          <span class="detail-label">MOT Status</span>
          <span id="other-mot-status" class="status-badge">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">MOT Expiry Date</span>
          <span id="other-mot-expiry" class="detail-value">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tax Status</span>
          <span id="other-tax-status" class="status-badge">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tax Due Date</span>
          <span id="other-tax-due" class="detail-value">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Insurance Status <span class="status-badge beta">BETA</span></span>
          <span id="other-insurance-status" class="status-badge">Not Available</span>
        </div>
      </div>

      <!-- Warnings Container -->
      <div id="warnings-container" class="warnings-container">
        <!-- Dynamic warnings will be inserted here -->
      </div>

      <div class="alert alert-info" style="margin-top: 12px;">
        <span>ℹ️</span>
        <span>MOT and Tax data from DVLA. Insurance verification is not yet available via API.</span>
      </div>
    </div>

    <!-- Other Driver's Insurance Details (Manual Entry) -->
    <div class="form-section">
      <div class="section-title">
        <span class="section-icon">🛡️</span>
        <span>Other Driver's Insurance Details</span>
      </div>

      <div class="alert alert-warning">
        <span>⚠️</span>
        <span>Please obtain and manually enter the other driver's insurance details. This information is critical for your claim.</span>
      </div>

      <div class="form-group">
        <label for="other-insurance-company" class="form-label">
          Insurance Company
          <span style="color: #f59e0b; font-size: 0.875rem;">(Recommended)</span>
        </label>
        <input
          type="text"
          id="other-insurance-company"
          name="other_insurance_company"
          placeholder="e.g., Aviva, Direct Line, etc."
        >
      </div>

      <div class="form-group">
        <label for="other-policy-number" class="form-label">
          Policy Number
          <span style="color: #f59e0b; font-size: 0.875rem;">(Recommended)</span>
        </label>
        <input
          type="text"
          id="other-policy-number"
          name="other_policy_number"
          placeholder="e.g., ABC123456789"
        >
      </div>

      <div class="form-group">
        <label for="other-policy-holder" class="form-label">
          Policy Holder Name
          <span style="color: #f59e0b; font-size: 0.875rem;">(Recommended)</span>
        </label>
        <p class="form-hint">The person named on the insurance policy (may be different from the driver)</p>
        <input
          type="text"
          id="other-policy-holder"
          name="other_policy_holder"
          placeholder="Enter policy holder's full name"
        >
      </div>

      <div class="form-group">
        <label for="other-policy-cover" class="form-label">
          Policy Cover Type
          <span style="color: #f59e0b; font-size: 0.875rem;">(Recommended)</span>
        </label>
        <select id="other-policy-cover" name="other_policy_cover">
          <option value="">-- Select cover type --</option>
          <option value="Comprehensive">Comprehensive</option>
          <option value="Third Party, Fire & Theft">Third Party, Fire & Theft</option>
          <option value="Third Party Only">Third Party Only</option>
          <option value="Unknown">Unknown</option>
        </select>
      </div>
    </div>

    <!-- Point of Impact & Damage (Other Vehicle) -->
    <div class="form-section">
      <div class="section-title">
        <span class="section-icon">💥</span>
        <span>Point of Impact & Damage to Other Vehicle</span>
      </div>

      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" id="no-damage-checkbox" name="no_visible_damage" style="margin-right: 8px; width: 20px; height: 20px; vertical-align: middle;">
          <span style="vertical-align: middle;">No visible damage to the other vehicle</span>
        </label>
      </div>

      <div class="form-group" id="damage-description-group">
        <label for="other-point-of-impact" class="form-label">
          Describe the damage to the other vehicle
          <span class="required" id="damage-required">*</span>
        </label>
        <p class="form-hint">Brief description is fine - Example: "Rear bumper damage" or "Front driver side dent"</p>
        <textarea
          id="other-point-of-impact"
          name="other_point_of_impact"
          placeholder="Describe what you observed..."
          maxlength="1000"
          required
        ></textarea>
        <div class="char-counter">
          <span id="other-impact-count">0</span> / 1000 characters (minimum 5)
        </div>
      </div>

      <div class="alert alert-info">
        <span>💡</span>
        <span><strong>Tip:</strong> Be specific about which parts of their vehicle made contact with yours, visible damage you observed, and any fluids leaking or other effects.</span>
      </div>
    </div>

    <!-- Add Another Vehicle -->
    <div style="margin: 32px 0; text-align: center;">
      <button type="button" class="btn" id="add-vehicle-btn" style="background: var(--accent); color: white; padding: 16px 32px; font-size: 1rem; font-weight: 600; border-radius: 12px; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 12px; box-shadow: 0 4px 12px rgba(53, 122, 148, 0.3); transition: all 0.2s ease;">
        <span style="font-size: 1.5rem;">➕</span>
        <span>Add Another Vehicle</span>
      </button>
      <p style="margin-top: 12px; color: var(--text-muted); font-size: 0.875rem;">If there were more than 2 vehicles involved in the incident</p>
    </div>

    <!-- Navigation Buttons -->
    <div class="nav-buttons">
      <button type="button" class="btn btn-secondary" id="back-btn">
        <span>←</span>
        <span>Back</span>
      </button>
      <button type="button" class="btn btn-primary" id="next-btn" disabled>
        <span>Next</span>
        <span>→</span>
      </button>
    </div>

  </div>

  <!-- Advisory Modal -->
  <div id="advisory-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; padding: 20px; overflow-y: auto;">
    <div style="max-width: 600px; margin: 40px auto; background: white; border-radius: 16px; padding: 32px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
      <div style="text-align: center; margin-bottom: 24px;">
        <div style="font-size: 48px; margin-bottom: 12px;">📋</div>
        <h2 style="font-size: 1.5rem; color: #1a1a1a; margin: 0 0 8px;">Important Reminders</h2>
        <p style="color: #666; font-size: 0.938rem;">Before continuing, please note:</p>
      </div>

      <div style="background: #fff3cd; border-left: 4px solid #f59e0b; padding: 16px; margin-bottom: 20px; border-radius: 4px;">
        <h3 style="font-size: 1rem; font-weight: 700; color: #856404; margin: 0 0 12px;">🔍 Missing Insurance Details?</h3>
        <ul style="margin: 0; padding-left: 20px; line-height: 1.8; color: #856404;">
          <li>Try to obtain insurance details from the other driver at the scene</li>
          <li>Take a photo of their insurance certificate if available</li>
          <li>You can update this information later if needed</li>
        </ul>
      </div>

      <div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 16px; margin-bottom: 20px; border-radius: 4px;">
        <h3 style="font-size: 1rem; font-weight: 700; color: #0d47a1; margin: 0 0 12px;">✅ What You Should Do Next:</h3>
        <ul style="margin: 0; padding-left: 20px; line-height: 1.8; color: #0d47a1;">
          <li><strong>Take photos</strong> of damage to all vehicles (next page)</li>
          <li><strong>Get witness details</strong> if any witnesses are present</li>
          <li><strong>Report to police</strong> if there are injuries or the other driver left the scene</li>
          <li><strong>Contact your insurer</strong> within 24 hours</li>
        </ul>
      </div>

      <div style="background: #fce4ec; border-left: 4px solid #e91e63; padding: 16px; margin-bottom: 24px; border-radius: 4px;">
        <h3 style="font-size: 1rem; font-weight: 700; color: #880e4f; margin: 0 0 12px;">⚠️ Important Legal Notes:</h3>
        <ul style="margin: 0; padding-left: 20px; line-height: 1.8; color: #880e4f;">
          <li>Do NOT admit fault or liability</li>
          <li>Exchange only basic details (name, registration, insurance)</li>
          <li>Document everything with photos and notes</li>
          <li>The more information you gather now, the stronger your claim</li>
        </ul>
      </div>

      <div style="display: flex; gap: 12px;">
        <button type="button" id="modal-back-btn" style="flex: 1; padding: 14px; background: white; border: 2px solid #d1d5db; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
          ← Go Back
        </button>
        <button type="button" id="modal-continue-btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #0E7490 0%, #0c6179 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 12px rgba(14, 116, 144, 0.3);">
          I Understand — Continue →
        </button>
      </div>
    </div>
  </div>

  <script>
    // Page state
    let vehicleData = {};
    let warnings = [];

    // Element references
    const otherPointOfImpact = document.getElementById('other-point-of-impact');
    const otherImpactCount = document.getElementById('other-impact-count');

    // Format license plate
    document.getElementById('other-license-plate').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });

    // Character counter for point of impact
    otherPointOfImpact.addEventListener('input', () => {
      const length = otherPointOfImpact.value.length;
      otherImpactCount.textContent = length;

      // Visual feedback at 70% and 90%
      if (length >= 900) {
        otherImpactCount.style.color = '#e53e3e';
        otherImpactCount.style.fontWeight = '700';
      } else if (length >= 700) {
        otherImpactCount.style.color = '#f59e0b';
        otherImpactCount.style.fontWeight = '600';
      } else {
        otherImpactCount.style.color = '#666';
        otherImpactCount.style.fontWeight = '400';
      }

      validateForm();
    });

    // No damage checkbox handler
    const noDamageCheckbox = document.getElementById('no-damage-checkbox');
    const damageDescriptionGroup = document.getElementById('damage-description-group');
    const damageRequired = document.getElementById('damage-required');

    noDamageCheckbox.addEventListener('change', () => {
      if (noDamageCheckbox.checked) {
        // Disable textarea and mark as optional
        otherPointOfImpact.disabled = true;
        otherPointOfImpact.style.opacity = '0.5';
        otherPointOfImpact.style.cursor = 'not-allowed';
        damageRequired.style.display = 'none';
        otherPointOfImpact.required = false;
      } else {
        // Enable textarea and mark as required
        otherPointOfImpact.disabled = false;
        otherPointOfImpact.style.opacity = '1';
        otherPointOfImpact.style.cursor = 'text';
        damageRequired.style.display = 'inline';
        otherPointOfImpact.required = true;
      }
      validateForm();
    });

    // Check for expired/invalid statuses
    function checkForWarnings(vehicle) {
      warnings = [];
      const today = new Date();

      // Check MOT expiry
      if (vehicle.motExpiryDate) {
        const motExpiry = new Date(vehicle.motExpiryDate);
        if (motExpiry < today) {
          warnings.push({
            type: 'error',
            title: '⚠️ Expired MOT',
            message: `MOT expired on ${vehicle.motExpiryDate}. The other vehicle should not have been driven on public roads.`
          });
        }
      }

      // Check MOT status
      if (vehicle.motStatus && !vehicle.motStatus.toLowerCase().includes('valid')) {
        warnings.push({
          type: 'error',
          title: '⚠️ Invalid MOT',
          message: `MOT status is "${vehicle.motStatus}". The vehicle may not be roadworthy.`
        });
      }

      // Check Tax expiry
      if (vehicle.taxDueDate) {
        const taxDue = new Date(vehicle.taxDueDate);
        if (taxDue < today) {
          warnings.push({
            type: 'error',
            title: '⚠️ Expired Tax',
            message: `Tax expired on ${vehicle.taxDueDate}. The other vehicle should not have been driven on public roads.`
          });
        }
      }

      // Check Tax status
      if (vehicle.taxStatus && !vehicle.taxStatus.toLowerCase().includes('tax')) {
        warnings.push({
          type: 'error',
          title: '⚠️ Untaxed Vehicle',
          message: `Tax status is "${vehicle.taxStatus}". The vehicle may be untaxed.`
        });
      }

      // Insurance warning (always shown)
      warnings.push({
        type: 'warning',
        title: 'ℹ️ Insurance Status Unknown',
        message: 'Insurance cannot be verified via DVLA API. Please obtain insurance details from the other driver.'
      });

      displayWarnings();
    }

    // Display warnings
    function displayWarnings() {
      const container = document.getElementById('warnings-container');

      if (warnings.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.innerHTML = '';
      warnings.forEach(warning => {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${warning.type}`;
        alertDiv.innerHTML = `
          <span>${warning.title}</span>
          <span>${warning.message}</span>
        `;
        container.appendChild(alertDiv);
      });

      container.style.display = 'block';
    }

    // DVLA Lookup
    document.getElementById('lookup-btn').addEventListener('click', async () => {
      const licensePlate = document.getElementById('other-license-plate').value.trim();
      const lookupBtn = document.getElementById('lookup-btn');
      const vehicleDetails = document.getElementById('vehicle-details');
      const lookupError = document.getElementById('lookup-error');

      if (!licensePlate) {
        alert('Please enter a license plate number');
        return;
      }

      // Show loading state
      lookupBtn.disabled = true;
      lookupBtn.textContent = '⏳ Looking up...';
      vehicleDetails.style.display = 'none';
      lookupError.style.display = 'none';
      document.getElementById('warnings-container').style.display = 'none';

      try {
        // Call DVLA API endpoint
        const response = await fetch(`/api/dvla/lookup?registration=${licensePlate}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // Store vehicle data
          vehicleData = data.vehicle;

          // Display vehicle details
          document.getElementById('vehicle-make').textContent = data.vehicle.make || '-';
          document.getElementById('vehicle-model').textContent = data.vehicle.model || '-';
          document.getElementById('vehicle-colour').textContent = data.vehicle.colour || '-';
          document.getElementById('vehicle-year').textContent = data.vehicle.yearOfManufacture || '-';
          document.getElementById('vehicle-fuel').textContent = data.vehicle.fuelType || '-';

          // Display MOT status
          const motStatus = document.getElementById('other-mot-status');
          if (data.vehicle.motStatus) {
            const isValid = data.vehicle.motStatus.toLowerCase().includes('valid');
            motStatus.className = 'status-badge ' + (isValid ? 'valid' : 'expired');
            motStatus.textContent = data.vehicle.motStatus;
          }
          if (data.vehicle.motExpiryDate) {
            document.getElementById('other-mot-expiry').textContent = data.vehicle.motExpiryDate;
          }

          // Display Tax status
          const taxStatus = document.getElementById('other-tax-status');
          if (data.vehicle.taxStatus) {
            const isTaxed = data.vehicle.taxStatus.toLowerCase().includes('tax');
            taxStatus.className = 'status-badge ' + (isTaxed ? 'valid' : 'expired');
            taxStatus.textContent = data.vehicle.taxStatus;
          }
          if (data.vehicle.taxDueDate) {
            document.getElementById('other-tax-due').textContent = data.vehicle.taxDueDate;
          }

          vehicleDetails.style.display = 'block';

          // Check for warnings
          checkForWarnings(data.vehicle);

          // Enable next button
          validateForm();
        } else {
          throw new Error(data.error || 'Vehicle not found');
        }

      } catch (error) {
        console.error('DVLA lookup error:', error);
        document.getElementById('lookup-error-message').textContent = error.message || 'Failed to look up vehicle. Please try again.';
        lookupError.style.display = 'flex';
      } finally {
        lookupBtn.disabled = false;
        lookupBtn.textContent = '🔍 Look Up';
      }
    });

    // Form Validation
    function validateForm() {
      const driverName = document.getElementById('other-driver-name').value.trim();
      const licensePlate = document.getElementById('other-license-plate').value.trim();
      const noDamageChecked = document.getElementById('no-damage-checkbox').checked;
      const impactFilled = otherPointOfImpact.value.trim().length >= 5;

      const nextBtn = document.getElementById('next-btn');

      // If "no damage" is checked, impact description is not required
      const damageRequirementMet = noDamageChecked || impactFilled;

      // Much more lenient - only require name OR license plate, plus damage info (or no damage checkbox)
      const canProceed = (driverName || licensePlate) && damageRequirementMet;

      nextBtn.disabled = !canProceed;

      // Show helpful feedback
      updateValidationFeedback(driverName, licensePlate, impactFilled, noDamageChecked);
    }

    function updateValidationFeedback(driverName, licensePlate, impactFilled, noDamageChecked) {
      // Remove existing feedback
      const existingFeedback = document.getElementById('validation-feedback');
      if (existingFeedback) existingFeedback.remove();

      // If form is valid, no feedback needed
      const damageRequirementMet = noDamageChecked || impactFilled;
      if ((driverName || licensePlate) && damageRequirementMet) return;

      // Create feedback message
      const feedback = document.createElement('div');
      feedback.id = 'validation-feedback';
      feedback.className = 'alert alert-info';
      feedback.style.marginTop = '20px';

      const missingItems = [];
      if (!driverName && !licensePlate) {
        missingItems.push('Either driver name OR license plate');
      }
      if (!damageRequirementMet) {
        if (noDamageChecked) {
          // Checkbox is checked but somehow still not met - shouldn't happen
        } else {
          const currentLength = otherPointOfImpact.value.trim().length;
          missingItems.push(`Damage description (need ${5 - currentLength} more characters) OR check "No visible damage"`);
        }
      }

      feedback.innerHTML = `
        <span>ℹ️</span>
        <div>
          <strong>To continue, please provide:</strong>
          <ul style="margin: 8px 0 0 20px; padding: 0;">
            ${missingItems.map(item => `<li>${item}</li>`).join('')}
          </ul>
          <p style="margin-top: 8px; font-size: 0.875rem; opacity: 0.9;">
            We understand getting all information may be difficult. Just provide what you can.
          </p>
        </div>
      `;

      // Insert before navigation buttons
      const navButtons = document.querySelector('.nav-buttons');
      navButtons.parentNode.insertBefore(feedback, navButtons);
    }

    // Auto-save
    function autoSave() {
      const formData = {
        other_driver_name: document.getElementById('other-driver-name').value,
        other_driver_phone: document.getElementById('other-driver-phone').value,
        other_driver_email: document.getElementById('other-driver-email').value,
        other_driver_license: document.getElementById('other-driver-license').value,
        other_license_plate: document.getElementById('other-license-plate').value,
        other_insurance_company: document.getElementById('other-insurance-company').value,
        other_policy_number: document.getElementById('other-policy-number').value,
        other_policy_holder: document.getElementById('other-policy-holder').value,
        other_policy_cover: document.getElementById('other-policy-cover').value,
        other_point_of_impact: otherPointOfImpact.value,
        no_visible_damage: noDamageCheckbox.checked,
        vehicle_data: vehicleData,
        warnings: warnings
      };

      localStorage.setItem('page7_data', JSON.stringify(formData));
      console.log('Page 7 data saved:', formData);
    }

    // Load saved data
    function loadSavedData() {
      const saved = localStorage.getItem('page7_data');
      if (saved) {
        const data = JSON.parse(saved);

        if (data.other_driver_name) {
          document.getElementById('other-driver-name').value = data.other_driver_name;
        }
        if (data.other_driver_phone) {
          document.getElementById('other-driver-phone').value = data.other_driver_phone;
        }
        if (data.other_driver_email) {
          document.getElementById('other-driver-email').value = data.other_driver_email;
        }
        if (data.other_driver_license) {
          document.getElementById('other-driver-license').value = data.other_driver_license;
        }
        if (data.other_license_plate) {
          document.getElementById('other-license-plate').value = data.other_license_plate;
        }

        // Restore insurance details
        if (data.other_insurance_company) {
          document.getElementById('other-insurance-company').value = data.other_insurance_company;
        }
        if (data.other_policy_number) {
          document.getElementById('other-policy-number').value = data.other_policy_number;
        }
        if (data.other_policy_holder) {
          document.getElementById('other-policy-holder').value = data.other_policy_holder;
        }
        if (data.other_policy_cover) {
          document.getElementById('other-policy-cover').value = data.other_policy_cover;
        }

        // Restore point of impact
        if (data.other_point_of_impact) {
          otherPointOfImpact.value = data.other_point_of_impact;
          otherImpactCount.textContent = data.other_point_of_impact.length;
        }

        // Restore no damage checkbox
        if (data.no_visible_damage) {
          noDamageCheckbox.checked = true;
          // Trigger change event to disable textarea
          noDamageCheckbox.dispatchEvent(new Event('change'));
        }

        if (data.vehicle_data) {
          vehicleData = data.vehicle_data;
          // Re-display vehicle details
          document.getElementById('vehicle-details').style.display = 'block';
          document.getElementById('vehicle-make').textContent = vehicleData.make || '-';
          document.getElementById('vehicle-model').textContent = vehicleData.model || '-';
          document.getElementById('vehicle-colour').textContent = vehicleData.colour || '-';
          document.getElementById('vehicle-year').textContent = vehicleData.yearOfManufacture || '-';
          document.getElementById('vehicle-fuel').textContent = vehicleData.fuelType || '-';

          // Re-display MOT/Tax status
          const motStatus = document.getElementById('other-mot-status');
          if (vehicleData.motStatus) {
            const isValid = vehicleData.motStatus.toLowerCase().includes('valid');
            motStatus.className = 'status-badge ' + (isValid ? 'valid' : 'expired');
            motStatus.textContent = vehicleData.motStatus;
          }
          if (vehicleData.motExpiryDate) {
            document.getElementById('other-mot-expiry').textContent = vehicleData.motExpiryDate;
          }

          const taxStatus = document.getElementById('other-tax-status');
          if (vehicleData.taxStatus) {
            const isTaxed = vehicleData.taxStatus.toLowerCase().includes('tax');
            taxStatus.className = 'status-badge ' + (isTaxed ? 'valid' : 'expired');
            taxStatus.textContent = vehicleData.taxStatus;
          }
          if (vehicleData.taxDueDate) {
            document.getElementById('other-tax-due').textContent = vehicleData.taxDueDate;
          }
        }

        if (data.warnings) {
          warnings = data.warnings;
          displayWarnings();
        }

        validateForm();
      }
    }

    // Modal functionality
    const advisoryModal = document.getElementById('advisory-modal');
    const modalBackBtn = document.getElementById('modal-back-btn');
    const modalContinueBtn = document.getElementById('modal-continue-btn');

    // Show modal when Next button clicked
    document.getElementById('next-btn').addEventListener('click', () => {
      autoSave();
      advisoryModal.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    });

    // Modal back button - close modal
    modalBackBtn.addEventListener('click', () => {
      advisoryModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    });

    // Modal continue button - proceed to next page
    modalContinueBtn.addEventListener('click', () => {
      advisoryModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      window.location.href = '/incident-form-page8-other-damage-images.html';
    });

    // Navigation
    document.getElementById('back-btn').addEventListener('click', () => {
      autoSave();
      window.location.href = '/incident-form-page6-vehicle-images.html';
    });

    // Add Another Vehicle handler
    document.getElementById('add-vehicle-btn').addEventListener('click', () => {
      // Save current vehicle data before adding another
      autoSave();

      // Get existing additional vehicles from sessionStorage
      let additionalVehicles = [];
      const stored = sessionStorage.getItem('additional_vehicles');
      if (stored) {
        try {
          additionalVehicles = JSON.parse(stored);
        } catch (e) {
          console.error('Error parsing additional vehicles:', e);
          additionalVehicles = [];
        }
      }

      // Add current vehicle data to array
      const currentVehicleData = {
        vehicle_number: additionalVehicles.length + 2, // Vehicle 1 is user, 2 is first other, 3+ are additional
        other_driver_name: document.getElementById('other-driver-name').value,
        other_driver_phone: document.getElementById('other-driver-phone').value,
        other_driver_email: document.getElementById('other-driver-email').value,
        other_driver_address: document.getElementById('other-driver-address').value,
        other_driver_license: document.getElementById('other-driver-license').value,
        other_license_plate: document.getElementById('other-license-plate').value,
        other_vehicle_make: document.getElementById('other-vehicle-make').value,
        other_vehicle_model: document.getElementById('other-vehicle-model').value,
        other_vehicle_color: document.getElementById('other-vehicle-color').value,
        other_insurance_company: document.getElementById('other-insurance-company').value,
        other_policy_number: document.getElementById('other-policy-number').value,
        other_policy_cover: document.getElementById('other-policy-cover').value,
        no_visible_damage: document.getElementById('no-damage-checkbox').checked,
        other_point_of_impact: document.getElementById('other-point-of-impact').value,
        saved_at: new Date().toISOString()
      };

      additionalVehicles.push(currentVehicleData);
      sessionStorage.setItem('additional_vehicles', JSON.stringify(additionalVehicles));

      console.log(`✅ Vehicle ${currentVehicleData.vehicle_number} saved. Total vehicles: ${additionalVehicles.length + 1}`);

      // Show confirmation message
      const vehicleNum = currentVehicleData.vehicle_number;
      const confirmMsg = document.createElement('div');
      confirmMsg.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 1000; font-weight: 600; animation: slideDown 0.3s ease;';
      confirmMsg.innerHTML = `<span style="font-size: 1.2rem; margin-right: 8px;">✓</span> Vehicle ${vehicleNum} saved! Now add vehicle ${vehicleNum + 1}`;
      document.body.appendChild(confirmMsg);

      setTimeout(() => {
        confirmMsg.remove();
      }, 2000);

      // Clear form for next vehicle
      document.getElementById('other-driver-name').value = '';
      document.getElementById('other-driver-phone').value = '';
      document.getElementById('other-driver-email').value = '';
      document.getElementById('other-driver-address').value = '';
      document.getElementById('other-driver-license').value = '';
      document.getElementById('other-license-plate').value = '';
      document.getElementById('other-vehicle-make').value = '';
      document.getElementById('other-vehicle-model').value = '';
      document.getElementById('other-vehicle-color').value = '';
      document.getElementById('other-insurance-company').value = '';
      document.getElementById('other-policy-number').value = '';
      document.getElementById('other-policy-cover').value = '';
      document.getElementById('no-damage-checkbox').checked = false;
      document.getElementById('other-point-of-impact').value = '';

      // Reset validation
      validateForm();

      // Scroll to top smoothly
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Auto-save on changes
    document.querySelectorAll('input, textarea, select').forEach(element => {
      element.addEventListener('change', autoSave);
      element.addEventListener('input', validateForm);
    });

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      loadSavedData();

      // Display count of additional vehicles if any
      const stored = sessionStorage.getItem('additional_vehicles');
      if (stored) {
        try {
          const vehicles = JSON.parse(stored);
          if (vehicles.length > 0) {
            const addBtn = document.getElementById('add-vehicle-btn');
            const countBadge = document.createElement('span');
            countBadge.style.cssText = 'background: white; color: var(--accent); padding: 4px 12px; border-radius: 20px; font-size: 0.875rem; margin-left: 8px; font-weight: 700;';
            countBadge.textContent = `${vehicles.length + 1} vehicles recorded`;
            addBtn.appendChild(countBadge);
          }
        } catch (e) {
          console.error('Error displaying vehicle count:', e);
        }
      }
    });
  </script>

</body>
</html>
