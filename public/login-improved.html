<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Login - Car Crash Lawyer AI</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 100%;
      padding: 40px 30px;
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-icon {
      font-size: 64px;
      margin-bottom: 10px;
    }

    h1 {
      text-align: center;
      color: #333;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .input-wrapper {
      position: relative;
    }

    .input-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 18px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 15px 14px 45px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group input::placeholder {
      color: #999;
    }

    .remember-me {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }

    .remember-me input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .remember-me label {
      font-size: 14px;
      color: #666;
      cursor: pointer;
      user-select: none;
    }

    .btn-login {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-login:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .btn-login:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn-login:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-login.loading {
      position: relative;
      color: transparent;
    }

    .btn-login.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fee;
      border-left: 4px solid #e74c3c;
      color: #c0392b;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      animation: shake 0.5s ease-in-out;
    }

    .error-message.show {
      display: block;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .success-message {
      background: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .links {
      text-align: center;
      margin-top: 25px;
      padding-top: 25px;
      border-top: 1px solid #e0e0e0;
    }

    .links a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: color 0.3s ease;
    }

    .links a:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    .links p {
      margin: 10px 0;
      color: #666;
      font-size: 14px;
    }

    /* Mobile optimizations */
    @media (max-width: 480px) {
      .login-container {
        padding: 30px 20px;
      }

      h1 {
        font-size: 24px;
      }

      .logo-icon {
        font-size: 48px;
      }

      .form-group input {
        font-size: 16px; /* Prevents zoom on iOS */
      }
    }

    /* Prevent auto-zoom on iOS when focusing inputs */
    @supports (-webkit-touch-callout: none) {
      input[type="email"],
      input[type="password"] {
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo">
      <div class="logo-icon">‚öñÔ∏è</div>
      <h1>Welcome Back</h1>
      <p class="subtitle">Login to access your account</p>
    </div>

    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>

    <form id="login-form">
      <div class="form-group">
        <label for="email">Email</label>
        <div class="input-wrapper">
          <span class="input-icon">üìß</span>
          <input
            type="email"
            id="email"
            name="email"
            required
            placeholder="your@email.com"
            autocomplete="email"
            autocapitalize="off"
            autocorrect="off"
          >
        </div>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <div class="input-wrapper">
          <span class="input-icon">üîí</span>
          <input
            type="password"
            id="password"
            name="password"
            required
            placeholder="Enter your password"
            autocomplete="current-password"
          >
        </div>
      </div>

      <div class="remember-me">
        <input type="checkbox" id="rememberMe" name="rememberMe" checked>
        <label for="rememberMe">Keep me logged in for 30 days</label>
      </div>

      <button type="submit" class="btn-login" id="loginBtn">
        Login
      </button>
    </form>

    <div class="links">
      <p>Don't have an account? <a href="signup-auth.html">Sign Up</a></p>
      <p><a href="#" id="forgot-password">Forgot Password?</a></p>
    </div>
  </div>

  <script>
    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('loginBtn');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    // Get redirect parameter from URL (for protected pages)
    function getRedirectUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const redirect = urlParams.get('redirect');

      if (!redirect) {
        return '/dashboard.html'; // Default to dashboard after login
      }

      // Decode and sanitize redirect URL
      let decodedRedirect = decodeURIComponent(redirect);

      // Security: Only allow relative paths
      if (decodedRedirect.includes('://')) {
        try {
          const url = new URL(decodedRedirect);
          decodedRedirect = url.pathname + url.search + url.hash;
        } catch (e) {
          console.warn('Invalid redirect URL, defaulting to dashboard');
          return '/dashboard.html';
        }
      }

      return decodedRedirect.startsWith('/') ? decodedRedirect : `/${decodedRedirect}`;
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      successMessage.classList.remove('show');
    }

    // Show success message
    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.add('show');
      errorMessage.classList.remove('show');
    }

    // Hide all messages
    function hideMessages() {
      errorMessage.classList.remove('show');
      successMessage.classList.remove('show');
    }

    // Handle login form submission
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessages();

      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      // Client-side validation
      if (!email || !password) {
        showError('Please enter both email and password');
        return;
      }

      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError('Please enter a valid email address');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.classList.add('loading');

      try {
        console.log('üîê Attempting login for:', email);

        const response = await fetch('/api/auth/login', {
          method: 'POST',
          credentials: 'include', // CRITICAL: Required to store cookies
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            password,
            rememberMe
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log('‚úÖ Login successful:', data);
          showSuccess('Login successful! Redirecting...');

          // Small delay to show success message
          setTimeout(() => {
            const redirectUrl = getRedirectUrl();
            console.log('üîÑ Redirecting to:', redirectUrl);
            window.location.href = redirectUrl;
          }, 800);
        } else {
          console.error('‚ùå Login failed:', data);

          // User-friendly error messages
          let errorMsg = 'Login failed. Please try again.';

          if (data.error) {
            if (data.error.includes('Invalid') || data.error.includes('credentials')) {
              errorMsg = 'Invalid email or password. Please check and try again.';
            } else if (data.error.includes('not found') || data.error.includes('does not exist')) {
              errorMsg = 'No account found with this email. Please sign up first.';
            } else {
              errorMsg = data.error;
            }
          }

          showError(errorMsg);
          loginBtn.disabled = false;
          loginBtn.classList.remove('loading');
        }
      } catch (error) {
        console.error('üí• Login error:', error);
        showError('Connection error. Please check your internet and try again.');
        loginBtn.disabled = false;
        loginBtn.classList.remove('loading');
      }
    });

    // Handle forgot password
    document.getElementById('forgot-password').addEventListener('click', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value.trim().toLowerCase();

      if (!email) {
        showError('Please enter your email address first');
        return;
      }

      showSuccess('Password reset link sent! Check your email.');

      // TODO: Implement actual password reset with Supabase
      console.log('üîë Password reset requested for:', email);
    });

    // Auto-focus email field on load
    window.addEventListener('load', () => {
      document.getElementById('email').focus();
    });
  </script>
</body>
</html>
