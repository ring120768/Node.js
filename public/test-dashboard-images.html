<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Dashboard Images</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #0B7AB0;
      border-bottom: 2px solid #0B7AB0;
      padding-bottom: 10px;
    }
    .status {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .image-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .image-container {
      width: 100%;
      height: 200px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .image-info {
      padding: 15px;
    }
    .image-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .image-meta {
      font-size: 12px;
      color: #666;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
    }
    .error {
      background: #fee;
      color: #c00;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      background: #efe;
      color: #0a0;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
    }
    button {
      background: #0B7AB0;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #095A85;
    }
    .debug {
      background: #333;
      color: #0f0;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      margin: 10px 0;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>üñºÔ∏è Dashboard Images Test</h1>

  <div class="status">
    <h2>Test Controls</h2>
    <button onclick="testAPI()">Test API</button>
    <button onclick="loadAndDisplayImages()">Load Images</button>
    <button onclick="clearDebug()">Clear Debug</button>
  </div>

  <div id="debug" class="debug" style="display:none;"></div>
  <div id="messages"></div>

  <div id="imagesContainer" class="loading">
    Click "Load Images" to start...
  </div>

  <script>
    const TEST_USER_ID = '199d9251-b2e0-40a5-80bf-fc1529d9bf6c';
    const API_BASE = 'http://localhost:5001';

    function debug(message, data = null) {
      const debugEl = document.getElementById('debug');
      debugEl.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();
      let output = `[${timestamp}] ${message}`;
      if (data) {
        output += '\n' + JSON.stringify(data, null, 2);
      }
      debugEl.textContent += output + '\n\n';
      console.log(message, data);
    }

    function clearDebug() {
      document.getElementById('debug').textContent = '';
      document.getElementById('debug').style.display = 'none';
      document.getElementById('messages').innerHTML = '';
    }

    function showMessage(message, type = 'info') {
      const messagesEl = document.getElementById('messages');
      const messageEl = document.createElement('div');
      messageEl.className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'status';
      messageEl.textContent = message;
      messagesEl.appendChild(messageEl);
    }

    async function testAPI() {
      clearDebug();
      debug('Testing API endpoint...');

      try {
        const url = `${API_BASE}/api/user-documents?user_id=${TEST_USER_ID}&document_type=image`;
        debug('Fetching from:', url);

        const response = await fetch(url);
        debug('Response status:', response.status);

        if (!response.ok) {
          throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        debug('API Response:', data);

        const images = data.data?.documents || [];
        showMessage(`‚úÖ API working! Found ${images.length} images`, 'success');

        if (images.length > 0) {
          debug('First image details:', {
            type: images[0].document_type,
            has_public_url: !!images[0].public_url,
            has_signed_url: !!images[0].signed_url,
            url_length: (images[0].public_url || images[0].signed_url || '').length
          });
        }

      } catch (error) {
        debug('‚ùå API Error:', error.message);
        showMessage(`‚ùå API Error: ${error.message}`, 'error');
      }
    }

    async function loadAndDisplayImages() {
      clearDebug();
      const container = document.getElementById('imagesContainer');
      container.innerHTML = '<div class="loading">Loading images...</div>';

      try {
        debug('Loading images from API...');
        const url = `${API_BASE}/api/user-documents?user_id=${TEST_USER_ID}&document_type=image`;
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        const images = data.data?.documents || [];

        debug(`Found ${images.length} images`);
        showMessage(`Found ${images.length} images`, 'success');

        if (images.length === 0) {
          container.innerHTML = '<div class="status">No images found</div>';
          return;
        }

        // Display images
        container.innerHTML = '<div class="images-grid">' +
          images.map((image, index) => {
            const imageUrl = image.signed_url || image.public_url;
            debug(`Image ${index + 1}: ${image.document_type}`, {
              has_url: !!imageUrl,
              url_start: imageUrl ? imageUrl.substring(0, 100) + '...' : 'NO URL'
            });

            return `
              <div class="image-card">
                <div class="image-container">
                  ${imageUrl ?
                    `<img src="${imageUrl}"
                          alt="${image.document_type}"
                          onload="imageLoaded(this, '${image.document_type}')"
                          onerror="imageError(this, '${image.document_type}')"
                     >` :
                    `<div style="color: #999;">No URL Available</div>`
                  }
                </div>
                <div class="image-info">
                  <div class="image-title">${formatDocumentType(image.document_type)}</div>
                  <div class="image-meta">
                    <div>üìÖ ${new Date(image.created_at).toLocaleDateString()}</div>
                    <div>‚úÖ ${image.status}</div>
                    <div>üìè ${formatFileSize(image.file_size)}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('') +
        '</div>';

      } catch (error) {
        debug('‚ùå Error loading images:', error.message);
        showMessage(`‚ùå Error: ${error.message}`, 'error');
        container.innerHTML = `<div class="error">Failed to load images: ${error.message}</div>`;
      }
    }

    function imageLoaded(img, type) {
      debug(`‚úÖ Image loaded successfully: ${type}`);
    }

    function imageError(img, type) {
      debug(`‚ùå Image failed to load: ${type}`);
      img.parentElement.innerHTML = `
        <div style="color: #c00; text-align: center; padding: 20px;">
          ‚ùå<br>Failed to load<br>${formatDocumentType(type)}
        </div>
      `;
    }

    function formatDocumentType(type) {
      if (!type) return 'Unknown';
      return type.replace(/_/g, ' ')
                 .split(' ')
                 .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                 .join(' ');
    }

    function formatFileSize(bytes) {
      if (!bytes) return 'Unknown size';
      const mb = bytes / (1024 * 1024);
      return mb.toFixed(2) + ' MB';
    }

    // Auto-load on page load
    window.addEventListener('DOMContentLoaded', () => {
      debug('Page loaded, ready to test');
      showMessage('Click "Test API" to check connection, then "Load Images" to display images');
    });
  </script>
</body>
</html>