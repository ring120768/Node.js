// src/routes/index.js - CLEAN PRODUCTION VERSION

/**
 * Central Router for Car Crash Lawyer AI
 * Handles all API routes and system endpoints
 * 
 * Note: Webhooks are mounted in app.js at /webhooks/* (not here)
 */

const express = require('express');
const router = express.Router();
const config = require('../config');
const logger = require('../utils/logger');

// ==================== ROUTE IMPORTS ====================

const authRoutes = require('./auth.routes');
const transcriptionRoutes = require('./transcription.routes');
const gdprRoutes = require('./gdpr.routes');
const emergencyRoutes = require('./emergency.routes');
const pdfRoutes = require('./pdf.routes');
const locationRoutes = require('./location.routes');
const debugRoutes = require('./debug.routes');

// ==================== HELPER FUNCTIONS ====================

/**
 * Get WebSocket client count safely
 */
function getWebSocketCount(websocketModule) {
  if (!websocketModule) return 0;
  if (typeof websocketModule.getClientCount === 'function') {
    try {
      return websocketModule.getClientCount();
    } catch (err) {
      logger.warn('Failed to get WebSocket count:', err.message);
      return 0;
    }
  }
  return 0;
}

/**
 * Check WebSocket initialization safely
 */
function isWebSocketInitialized(websocketModule) {
  if (!websocketModule) return false;
  if (typeof websocketModule.isInitialized === 'function') {
    try {
      return websocketModule.isInitialized();
    } catch (err) {
      return false;
    }
  }
  return false;
}

/**
 * Check external service configuration status
 */
function getServiceStatus() {
  return {
    supabase: !!(config.supabase.url && config.supabase.serviceKey),
    openai: !!config.openai.apiKey,
    what3words: !!config.what3words.apiKey,
    dvla: !!config.dvla.apiKey
  };
}

// ==================== SYSTEM ENDPOINTS ====================

/**
 * Health Check Endpoint
 * GET /health
 */
router.get('/health', async (req, res) => {
  try {
    const services = getServiceStatus();
    const websocketModule = req.app.locals.websocketModule;
    const supabaseEnabled = req.app.locals.supabaseEnabled;
    const authService = req.app.locals.authService;

    res.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      services: {
        supabase: supabaseEnabled && services.supabase,
        openai: services.openai,
        what3words: services.what3words,
        dvla: services.dvla,
        websocket: getWebSocketCount(websocketModule),
        auth: !!authService,
        gdprCompliant: true
      }
    });
  } catch (error) {
    logger.error('Health check error:', error);
    res.status(500).json({
      status: 'unhealthy',
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});

/**
 * API Configuration Endpoint
 * GET /api/config
 */
router.get('/api/config', (req, res) => {
  try {
    const supabaseEnabled = req.app.locals.supabaseEnabled;
    const authService = req.app.locals.authService;
    const websocketModule = req.app.locals.websocketModule;
    const pdfModules = req.app.locals.pdfModules;

    res.json({
      supabaseUrl: config.supabase.url,
      supabaseAnonKey: config.supabase.anonKey,
      features: {
        realtime: supabaseEnabled && isWebSocketInitialized(websocketModule),
        transcription: config.openai.enabled,
        ai_summary: config.openai.enabled,
        ai_listening: config.openai.enabled,
        pdf_generation: !!pdfModules,
        auth: !!authService,
        what3words: config.what3words.enabled,
        dvla: config.dvla.enabled,
        gdpr_consent: true
      }
    });
  } catch (error) {
    logger.error('API config error:', error);
    res.status(500).json({
      error: 'Failed to load API configuration',
      message: error.message
    });
  }
});

/**
 * System Status Page
 * GET /system-status
 */
router.get('/system-status', async (req, res) => {
  try {
    const services = getServiceStatus();
    const supabaseEnabled = req.app.locals.supabaseEnabled;
    const authService = req.app.locals.authService;
    const websocketModule = req.app.locals.websocketModule;
    const pdfModules = req.app.locals.pdfModules;

    const status = (condition, active = 'Active', inactive = 'Not configured') => 
      condition ? `‚úÖ ${active}` : `‚ö†Ô∏è ${inactive}`;

    const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Crash Lawyer AI - System Status</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container { 
            max-width: 900px; 
            width: 100%;
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { 
            color: #333; 
            margin-bottom: 10px;
            font-size: 28px;
        }
        .status-badge { 
            padding: 12px 20px; 
            background: #4CAF50; 
            color: white; 
            border-radius: 8px; 
            display: inline-block;
            font-weight: 600;
            font-size: 14px;
            margin: 10px 0;
        }
        .badge { 
            padding: 6px 12px; 
            color: white; 
            border-radius: 5px; 
            font-size: 11px; 
            margin-left: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .gdpr-badge { background: #2196F3; }
        .section { 
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        .section:first-of-type { border-top: none; margin-top: 20px; }
        h3 { 
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        ul { 
            list-style: none; 
            padding: 0; 
        }
        li { 
            margin: 8px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            font-size: 14px;
        }
        code { 
            background: #667eea; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        .links {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
            text-align: center;
        }
        a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin: 0 10px;
        }
        a:hover {
            text-decoration: underline;
        }
        @media (max-width: 600px) {
            .container { padding: 20px; }
            h1 { font-size: 22px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Car Crash Lawyer AI<span class="badge gdpr-badge">GDPR Compliant</span></h1>
        <div class="status-badge">‚úÖ All Systems Operational</div>

        <div class="section">
            <h3>üìä System Status</h3>
            <ul>
                <li>Supabase Database: ${status(supabaseEnabled && services.supabase, 'Connected')}</li>
                <li>OpenAI API: ${status(services.openai, 'Configured')}</li>
                <li>what3words API: ${status(services.what3words, 'Configured')}</li>
                <li>DVLA API: ${status(services.dvla, 'Configured')}</li>
                <li>Auth Service: ${status(authService)}</li>
                <li>WebSocket: ${status(isWebSocketInitialized(websocketModule))}</li>
                <li>PDF Generation: ${status(pdfModules, 'Available', 'Unavailable')}</li>
                <li>GDPR Compliance: ‚úÖ Full audit logging enabled</li>
            </ul>
        </div>

        <div class="section">
            <h3>üîå API Endpoints</h3>
            <ul>
                <li><code>/api/auth/*</code> - Authentication & user management</li>
                <li><code>/api/transcription/*</code> - Audio transcription services</li>
                <li><code>/api/gdpr/*</code> - GDPR compliance & data requests</li>
                <li><code>/api/emergency/*</code> - Emergency contact management</li>
                <li><code>/api/pdf/*</code> - PDF report generation</li>
                <li><code>/api/location/*</code> - Location services (what3words)</li>
                <li><code>/api/debug/*</code> - Debug & testing endpoints</li>
            </ul>
        </div>

        <div class="section">
            <h3>üé£ Webhook Endpoints</h3>
            <ul>
                <li><code>/webhooks/user_signup</code> - Typeform user profile completion</li>
                <li><code>/webhooks/incident_reports</code> - Incident report submissions</li>
                <li><code>/webhooks/demo</code> - Demo & test submissions</li>
                <li><code>/webhooks/health</code> - Webhook health check</li>
            </ul>
        </div>

        <div class="links">
            <a href="/">‚Üê Main Page</a>
            <a href="/health">Health Check</a>
            <a href="/webhooks/health">Webhook Status</a>
        </div>
    </div>
</body>
</html>`;

    res.send(htmlContent);
  } catch (error) {
    logger.error('System status error:', error);
    res.status(500).send(`
      <!DOCTYPE html>
      <html>
      <head><title>Error</title></head>
      <body>
        <h1>System Status Error</h1>
        <p>${error.message}</p>
      </body>
      </html>
    `);
  }
});

// ==================== MOUNT API ROUTES ====================

router.use('/api/auth', authRoutes);
router.use('/api/transcription', transcriptionRoutes);
router.use('/api/gdpr', gdprRoutes);
router.use('/api/emergency', emergencyRoutes);
router.use('/api/pdf', pdfRoutes);
router.use('/api/location', locationRoutes);
router.use('/api/debug', debugRoutes);

// ==================== LEGACY REDIRECTS ====================

/**
 * Legacy Transcription Endpoints
 */
router.post('/api/whisper/transcribe', (req, res) => {
  res.redirect(307, '/api/transcription/transcribe');
});

router.get('/api/transcription-status/:queueId', (req, res) => {
  res.redirect(`/api/transcription/status/${req.params.queueId}`);
});

router.post('/api/update-transcription', (req, res) => {
  res.redirect(307, '/api/transcription/update');
});

router.post('/api/save-transcription', (req, res) => {
  res.redirect(307, '/api/transcription/save');
});

router.get('/api/user/:userId/latest-transcription', (req, res) => {
  res.redirect(`/api/transcription/user/${req.params.userId}/latest`);
});

router.get('/api/user/:userId/transcriptions', (req, res) => {
  res.redirect(`/api/transcription/user/${req.params.userId}/all`);
});

/**
 * Legacy Location Endpoints
 */
router.get('/api/what3words/convert', (req, res) => {
  res.redirect(`/api/location/convert?${new URLSearchParams(req.query)}`);
});

router.get('/api/what3words/autosuggest', (req, res) => {
  res.redirect(`/api/location/autosuggest?${new URLSearchParams(req.query)}`);
});

router.get('/api/what3words', (req, res) => {
  res.redirect(`/api/location/legacy?${new URLSearchParams(req.query)}`);
});

/**
 * Legacy PDF Endpoints
 */
router.post('/generate-pdf', (req, res) => {
  res.redirect(307, '/api/pdf/generate');
});

router.get('/pdf-status/:userId', (req, res) => {
  res.redirect(`/api/pdf/status/${req.params.userId}`);
});

router.get('/download-pdf/:userId', (req, res) => {
  res.redirect(`/api/pdf/download/${req.params.userId}`);
});

/**
 * Legacy Webhook Endpoints
 * Redirect to new /webhooks/* location (not /api/webhooks/*)
 */
router.post('/api/webhooks/signup', (req, res) => {
  res.redirect(307, '/webhooks/user_signup');
});

router.post('/api/webhooks/incident-report', (req, res) => {
  res.redirect(307, '/webhooks/incident_reports');
});

router.post('/webhook/signup', (req, res) => {
  res.redirect(307, '/webhooks/user_signup');
});

router.post('/webhook/incident-report', (req, res) => {
  res.redirect(307, '/webhooks/incident_reports');
});

/**
 * Legacy Debug Endpoints
 */
router.get('/api/test-openai', (req, res) => {
  res.redirect('/api/debug/test-openai');
});

router.get('/api/process-queue-now', (req, res) => {
  res.redirect('/api/debug/process-queue');
});

router.get('/test/transcription-queue', (req, res) => {
  res.redirect('/api/debug/transcription-queue');
});

router.post('/test/process-transcription-queue', (req, res) => {
  res.redirect(307, '/api/debug/process-transcription-queue');
});

module.exports = router;