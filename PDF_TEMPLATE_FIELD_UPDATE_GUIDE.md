# PDF Template Field Update Guide
**Date:** 2025-11-20
**Purpose:** Update Dropbox PDF template to match refactored AI analysis schema

---

## Issue Summary

The PDF template in Dropbox (`Car-Crash-Lawyer-AI-incident-report-main.pdf`) has **outdated field names** from the original Nov 16 implementation. The code was refactored on Nov 20 (commit `529f5d4`) to simplify the AI analysis schema.

---

## Required Field Name Changes

### Page 13: User's Voice Transcription

| Old Field Name (Dropbox) | ➜ | New Field Name (Required) |
|--------------------------|---|---------------------------|
| `ai_summary_of_accident_data_transcription` | ➜ | `voice_transcription` |
| *(Field doesn't exist in old template)* | ➜ | `analysis_metadata` (NEW) |
| *(Field doesn't exist in old template)* | ➜ | `quality_review` (NEW) |

**Notes:**
- `voice_transcription`: Main transcription text from OpenAI Whisper API
- `analysis_metadata`: Small text box for model info (e.g., "Model: GPT-4o | Generated: 20/11/2025, 21:30 GMT | v1.2")
- `quality_review`: Quality assessment section with strengths/improvements

---

### Page 14: AI Summary & Key Points

| Old Field Name (Dropbox) | ➜ | New Field Name (Required) |
|--------------------------|---|---------------------------|
| `detailed_account_of_what_happened` | ➜ | `ai_summary` |

**Notes:**
- This field contains the AI-generated summary with bullet points
- Should be a large multiline text field
- Auto-fit font sizing enabled (code handles font size 4-10)

---

### Page 15: Legal Closing Statement

| Old Field Name (Dropbox) | ➜ | New Field Name (Required) |
|--------------------------|---|---------------------------|
| `ai_combined_narrative_and_next_steps` | ➜ | `closing_statement` |

**Notes:**
- Legal closing statement generated by GPT-4o
- Large multiline text field
- Auto-fit font sizing enabled

---

### Page 16: Final Review & Next Steps

| Old Field Name (Dropbox) | ➜ | New Field Name (Required) |
|--------------------------|---|---------------------------|
| *(Field may not exist in old template)* | ➜ | `final_review` (NEW) |

**Notes:**
- Next steps and recommendations section
- Large multiline text field
- Auto-fit font sizing enabled

---

### Page 18: Emergency Audio Transcription

| Old Field Name (Dropbox) | ➜ | New Field Name (Required) |
|--------------------------|---|---------------------------|
| `emergency_audio_transcription` | ➜ | `emergency_audio_transcription` ✅ |
| *(Field doesn't exist in old template)* | ➜ | `emergency_recording_timestamp` (NEW) |

**Notes:**
- `emergency_audio_transcription`: ✅ **Already correct** - no change needed
- `emergency_recording_timestamp`: NEW field for recording timestamp

---

## Summary of Changes

### Fields to Rename (3)
1. Page 13: `ai_summary_of_accident_data_transcription` → `voice_transcription`
2. Page 14: `detailed_account_of_what_happened` → `ai_summary`
3. Page 15: `ai_combined_narrative_and_next_steps` → `closing_statement`

### New Fields to Add (4)
1. Page 13: `analysis_metadata` (small text box for AI model info)
2. Page 13: `quality_review` (multiline text field)
3. Page 16: `final_review` (multiline text field)
4. Page 18: `emergency_recording_timestamp` (date/time field)

### Fields Already Correct (1)
1. Page 18: `emergency_audio_transcription` ✅

---

## How to Update the PDF Template

### Using Adobe Acrobat Pro:

1. **Open the template:**
   - File: `Car-Crash-Lawyer-AI-incident-report-main.pdf` (from Dropbox)

2. **Enter form editing mode:**
   - Tools → Prepare Form

3. **Rename existing fields:**
   - Right-click on field → Properties → General tab
   - Update the "Name" field with new name from table above
   - Click "Close"

4. **Add new fields:**
   - Use "Add a Text Field" button from toolbar
   - Position the field on the appropriate page
   - Set field name from table above
   - Configure properties:
     - **Multiline:** Enable for all text fields except `analysis_metadata`
     - **Scrolling:** Enable
     - **Font:** Helvetica
     - **Font Size:** Auto (code will handle sizing)
   - For `emergency_recording_timestamp`: Use Date Field instead of Text Field

5. **Verify all changes:**
   - Tools → Prepare Form → More → List Fields
   - Check that all field names match the "New Field Name" column

6. **Save the updated template:**
   - File → Save As
   - Recommended: `Car-Crash-Lawyer-AI-incident-report-main-UPDATED.pdf`

7. **Test the updated template:**
   ```bash
   # In the Node.js project directory:

   # 1. Copy updated template to project
   cp ~/Dropbox/Car-Crash-Lawyer-AI-incident-report-main-UPDATED.pdf \
      pdf-templates/Car-Crash-Lawyer-AI-incident-report-main.pdf

   # 2. Test PDF generation with real data
   node test-form-filling.js [user-uuid]

   # 3. Verify Pages 13-16 have correct data
   ```

---

## Current Code Implementation

The code currently uses these field names (from `src/services/adobePdfFormFillerService.js` lines 876-902):

```javascript
// Page 13 - Voice Transcription
setFieldText('voice_transcription', incident.voice_transcription || '');

// Page 13 - Analysis Metadata (compact format for small text box)
setFieldText('analysis_metadata', aiMetadataText);

// Page 13 - Quality Review
setFieldText('quality_review', incident.quality_review || '');

// Page 14 - AI Summary
setFieldText('ai_summary', incident.ai_summary || '');

// Page 15 - Closing Statement
setFieldText('closing_statement', incident.closing_statement || '');

// Page 16 - Final Review
setFieldText('final_review', incident.final_review || '');

// Page 18 - Emergency Audio
setFieldText('emergency_audio_transcription', emergencyContent.trim());
setFieldText('emergency_recording_timestamp', emergencyTimestamp);
```

---

## Database Schema (After Migration 028)

All AI analysis fields are stored directly in the `incident_reports` table:

```sql
ALTER TABLE incident_reports
  ADD COLUMN voice_transcription TEXT,
  ADD COLUMN analysis_metadata JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN quality_review TEXT,
  ADD COLUMN ai_summary TEXT,
  ADD COLUMN closing_statement TEXT,
  ADD COLUMN final_review TEXT;
```

---

## Verification Checklist

After updating the PDF template:

- [ ] All 3 field names renamed correctly
- [ ] All 4 new fields added with correct names
- [ ] All multiline fields have "Multiline" and "Scrolling" enabled
- [ ] Font size set to "Auto" for all text fields
- [ ] `emergency_recording_timestamp` is a Date Field (not Text Field)
- [ ] Template saved with new filename
- [ ] Template copied to `pdf-templates/Car-Crash-Lawyer-AI-incident-report-main.pdf`
- [ ] Test PDF generation successful with `node test-form-filling.js [user-uuid]`
- [ ] Pages 13-16 display data correctly in generated PDF
- [ ] Updated template uploaded back to Dropbox

---

## Migration History

- **Nov 16, 2025** (commit `a6cedc9`): Original Pages 13-18 implementation
  - Used separate `ai_transcription` and `ai_analysis` tables
  - Field names: `ai_summary_of_accident_data_transcription`, `detailed_account_of_what_happened`, etc.

- **Nov 20, 2025** (commit `529f5d4`): Refactor to simplify schema
  - Migration 028: Added fields directly to `incident_reports` table
  - New field names: `voice_transcription`, `ai_summary`, `closing_statement`, etc.
  - **PDF template NOT updated** (this guide addresses that)

---

## Contact

If you encounter issues updating the PDF template:
1. Check that Adobe Acrobat Pro is installed (not just Reader)
2. Verify you're editing the correct template file
3. Test the PDF generation after each change
4. Refer to Adobe Acrobat documentation for form field editing

---

**Last Updated:** 2025-11-20
**Author:** Claude Code
**Status:** Ready for implementation
